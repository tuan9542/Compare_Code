SET QUOTED_IDENTIFIER ON;
SET ANSI_NULLS ON;
GO
/*
==================================================
Author			:	BacVT - VietMXH
Create date		:	10/07/2015 - 12/05/2020 15:50
Description		:	Gán Người xử lý cho Yêu cầu
Note			:	Dựa theo Phân quyền và Phân công
				:	- Nếu Phân quyền có check FollowAssignment
				:	thì theo bảng Phân công
				:	- Nếu Phân quyền không check FollowAssignment
				:	thì dựa vào Chức danh Phân công lấy Người xử lý
				:	[10.96.254.143].FRTInsideV2
				:	[10.96.254.55].FRTCallLogV2
==================================================
Test:
EXEC Assigners_InsertForRequest
    @RequestId = 5242865	--	Mã CallLog
  , @StepNo = 1	--	Bước CallLog (Nếu = 0 => Tự lấy Bước CallLog hiện tại)
  , @Is_NotView = 0	--	Không xem Kết quả? 1-Không xem, 0-Có xem
*/
ALTER PROCEDURE dbo.Assigners_InsertForRequest
    @RequestId BIGINT   --	Mã CallLog
  , @StepNo INT = 0     --	Bước CallLog (Nếu = 0 => Tự lấy Bước CallLog hiện tại)
  , @Is_NotView BIT = 0 --	Không xem Kết quả? 1-Không xem, 0-Có xem
AS
    BEGIN


        BEGIN TRY
            SET NOCOUNT ON;

            --	====================================================================================================
            --	==========Set Default==========
            IF ( @Is_NotView IS NULL )
                SET @Is_NotView = 0;

            --	====================================================================================================
            --	==========Lấy Thông tin CallLog==========
            SELECT
                R.Id         AS Request_Id
              , R.TypeId     AS Request_TypeId
              , R.StepNo     AS Request_StepNo
              , R.GroupId    AS Request_GroupId
              , R.Sender     AS Request_Sender
              , R.Assigner   AS Request_Assigner
              , R.TimeCreate AS Request_TimeCreate
              , R.FromShop   AS Request_FromShop
              , R.ToShop     AS Request_ToShop
              , R.FromOffice AS Request_FromOffice
              , R.ToOffice   AS Request_ToOffice
              , R.ErrorCode  AS Request_ErrorCode
              , R.Status     AS Request_Status
              , R.SaleCode   AS SaleCode
              , R.BI_PhongBanPhuTrach --  Edit - ThuongNM2 - 06/03/2019 - Thay đổi yêu cầu CL 23=====
              , R.Note                -- Add - LuanNT44 - 25/06/2019 - Màn hình định nghĩa CL Hỗ trợ bán hàng
            INTO
                #Tmp_Request
            FROM
                dbo.Requests AS R ( NOLOCK )
            WHERE
                --	Lấy CallLog theo Mã CallLog (Duy nhất 1 Mã)
                R.Id = @RequestId;

            DECLARE
                @ASM                     VARCHAR(40)  = '00241'
              , @Request_TypeId          INT
              , @ItemId                  INT
              , @Request_Sender          NVARCHAR(40)
              , @Request_Assigner        NVARCHAR(40)
              , @Request_TimeCreate      DATETIME
              , @SourceId                INT
              , @Loai                    INT          = ''
              , @StepNo_Tmp              INT
              , @Request_FromShop        NVARCHAR(40)
              , @Request_ToShop          NVARCHAR(40)
              , @Request_Status          INT
              , @Request_Assigner_UuTien NVARCHAR(40) = N''
              , @Request_SaleCode        NVARCHAR(50)
              , @Request_GroupId         INT
              , @Request_Note            NVARCHAR(500) -- Add - LuanNT44 - 25/06/2019 - Màn hình định nghĩa CL Hỗ trợ bán hàng
              , @Request_FromOffice      NVARCHAR(40)  -- Add - LuanNT44 - 25/06/2019 - Màn hình định nghĩa CL Hỗ trợ bán hàng
              , @Request_ToOffice        NVARCHAR(40); -- Add - LuanNT44 - 25/06/2019 - Màn hình định nghĩa CL Hỗ trợ bán hàng

            SELECT
                @Request_TypeId     = R.Request_TypeId
              , @StepNo_Tmp         = Request_StepNo
              , @ItemId             = Request_GroupId
              , @Request_Sender     = Request_Sender
              , @Request_Assigner   = Request_Assigner
              , @Request_TimeCreate = Request_TimeCreate
              , @Request_FromShop   = Request_FromShop
              , @Request_ToShop     = Request_ToShop
              , @Request_Status     = Request_Status
              , @Loai               = Request_ErrorCode
              , @Request_SaleCode   = SaleCode
              , @Request_GroupId    = Request_GroupId
              , @Request_Note       = R.Note               -- Add - LuanNT44 - 25/06/2019 - Màn hình định nghĩa CL Hỗ trợ bán hàng
              , @Request_FromOffice = R.Request_FromOffice -- Add - LuanNT44 - 25/06/2019 - Màn hình định nghĩa CL Hỗ trợ bán hàng
              , @Request_ToOffice   = R.Request_ToOffice   -- Add - LuanNT44 - 25/06/2019 - Màn hình định nghĩa CL Hỗ trợ bán hàng
            FROM
                #Tmp_Request AS R;

            -- SET bước
            IF ( @StepNo = 0 )
                SET @StepNo = @StepNo_Tmp;

            PRINT CONCAT(N'@Request_TypeId: ', @Request_TypeId);
            PRINT CONCAT(N'@StepNo: ', @StepNo);

            IF ( @Request_TypeId IN ( 19 ))
                BEGIN
                    SELECT TOP 1
                           @SourceId = CASE
                                           WHEN RD.Quantity IS NOT NULL
                                                AND RD.Property8 = 'Happy call'
                                                AND ISNULL(RD.Property3, '') <> '' THEN '2305'
                                           WHEN RD.Quantity IS NOT NULL
                                                AND RD.Property8 = N'Bảo hành'
                                                AND ISNULL(RD.Property3, '') <> '' THEN N'2306'
                                           WHEN RD.Quantity IS NULL
                                                AND ISNULL(RD.Property2, '') <> '' THEN '2307'
                                           ELSE '2308' -- shop
                                       END
                    FROM
                           dbo.RequestDetails ( NOLOCK ) RD
                    WHERE
                           RD.RequestId = @RequestId;
                END;
            ELSE IF ( @Request_TypeId IN ( 51, 183 ))
                     BEGIN
                         EXEC dbo.sp_Requests_Temporary_Delete @RequestID = @RequestId;
                     END;

            CREATE TABLE #Tmp_SourceIds ( Id INT );

            IF ( @SourceId IS NOT NULL AND @SourceId > 0 )
                BEGIN
                    DECLARE @LoopS INT = 1;

                    INSERT INTO #Tmp_SourceIds
                    SELECT Id FROM dbo.Items ( NOLOCK ) WHERE ParentId = @SourceId
                    UNION ALL
                    SELECT @SourceId;

                    WHILE ( @LoopS < 5 )
                        BEGIN
                            INSERT INTO #Tmp_SourceIds ( Id )
                            SELECT
                                Id
                            FROM
                                dbo.Items ( NOLOCK )
                            WHERE
                                ParentId IN ( SELECT Id FROM #Tmp_SourceIds )
                                AND Id NOT IN ( SELECT Id FROM #Tmp_SourceIds );

                            SET @LoopS += 1;
                        END;

                    SET @LoopS = 1;

                    WHILE ( @LoopS < 5 )
                        BEGIN
                            SET @SourceId = (
                                                SELECT TOP 1
                                                       ParentId
                                                FROM
                                                       dbo.Items ( NOLOCK )
                                                WHERE
                                                       Id = @SourceId
                                                       AND ISNULL(ParentId, 0) <> 0
                                            );

                            IF ( @SourceId IS NOT NULL )
                                BEGIN
                                    INSERT INTO #Tmp_SourceIds ( Id ) SELECT @SourceId;
                                END;

                            SET @LoopS += 1;
                        END;
                END;

            UPDATE Requests SET Assigner = NULL WHERE Id = @RequestId;

            CREATE TABLE #Tmp_Assigner ( Assigner VARCHAR(40));

            CREATE TABLE #Tmp_Item ( Id INT );

            --	===Danh sách Item theo phân cấp cha con===
            IF ( @ItemId > 0 )
                BEGIN
                    DECLARE @Loop INT = 1;

                    INSERT INTO #Tmp_Item
                    SELECT Id FROM dbo.Items ( NOLOCK ) WHERE ParentId = @ItemId
                    UNION ALL
                    SELECT @ItemId;

                    WHILE ( @Loop < 5 )
                        BEGIN
                            INSERT INTO #Tmp_Item ( Id )
                            SELECT
                                Id
                            FROM
                                dbo.Items ( NOLOCK )
                            WHERE
                                ParentId IN ( SELECT Id FROM #Tmp_Item )
                                AND Id NOT IN ( SELECT Id FROM #Tmp_Item );

                            SET @Loop += 1;
                        END;

                    SET @Loop = 1;

                    WHILE ( @Loop < 5 )
                        BEGIN
                            SET @ItemId = (
                                              SELECT TOP 1
                                                     ParentId
                                              FROM
                                                     dbo.Items ( NOLOCK )
                                              WHERE
                                                     Id = @ItemId
                                                     AND ISNULL(ParentId, 0) <> 0
                                          );

                            IF ( @ItemId IS NOT NULL )
                                BEGIN
                                    INSERT INTO #Tmp_Item SELECT @ItemId;
                                END;

                            SET @Loop += 1;
                        END;
                END;

            DECLARE @FromShop VARCHAR(40) = ISNULL(@Request_ToShop, '');

            IF ( @FromShop = '' )
                SET @FromShop = ISNULL(@Request_FromShop, '');

            --	====================================================================================================
            --	==========Lấy Thông tin Inside==========
            --	===Lấy DL Nhân viên===
            SELECT
                ID                       AS ID
              , EmployeeCode             AS EmployeeCode
              , Leader                   AS Leader
              , Status                   AS Status
              , RegionHierachyCode       AS RegionHierachyCode
              , EmployeeName             AS EmployeeName
              , Email                    AS Email
              , WarehouseCode            AS WarehouseCode
              , OrganizationHierachyCode AS OrganizationHierachyCode
              , JobTitle                 AS JobTitle
            INTO
                #Tmp__F03_Employees
            FROM
                [10.96.254.143].FRTInsideV2.dbo.f03_Employees WITH ( NOLOCK )
            WHERE
                Status = 'A'; --ChuongNT3 - 16/11/2018 - bắt trạng thái nhân viên nghỉ việc

            --	===Lấy DL Nhân viên cùng Chức danh===
            SELECT
                EmployeeCode             AS EmployeeCode
              , JobTitleCode             AS JobTitleCode
              , WarehouseCode            AS WarehouseCode
              , Status                   AS Status
              , RegionHierachyCode       AS RegionHierachyCode
              , OrganizationHierachyCode AS OrganizationHierachyCode
            INTO
                #Tmp__F03_EmployeeJobTitles
            FROM
                [10.96.254.143].FRTInsideV2.dbo.F03_EmployeeJobTitles WITH ( NOLOCK );

            --	===Lấy DL F03_OrganizationHierachies===
            SELECT
                ID                       AS ID
              , OrganizationHierachyCode AS OrganizationHierachyCode
              , Status                   AS Status
            INTO
                #Tmp__F03_OrganizationHierachies
            FROM
                [10.96.254.143].FRTInsideV2.dbo.F03_OrganizationHierachies WITH ( NOLOCK );

            --	===Lấy DL F03_Jobtitles===
            SELECT
                JobTitleCode AS JobTitleCode
              , Status       AS Status
            INTO
                #Tmp__F03_JobTitles
            FROM
                [10.96.254.143].FRTInsideV2.dbo.F03_JobTitles WITH ( NOLOCK );

            --	===Lấy DL Warehouse===
            SELECT
                WarehouseCode    AS WarehouseCode
              , Status           AS Status
              , RegionL1         AS RegionL1
              , RegionL2         AS RegionL2
              , RegionL3         AS RegionL3
              , RegionL4         AS RegionL4
              , WarehouseCodeVNM AS WarehouseCodeVNM
            INTO
                #Tmp__Warehouse
            FROM
                [10.96.254.143].FRTInsideV2.dbo.Warehouse WITH ( NOLOCK );

            --	====================================================================================================
            --	==========Check Loại CallLog?==========
            --	===3===
            IF ( @Request_TypeId = 3 )
                BEGIN
                    IF ( @StepNo = 4 )
                        --	3-Yêu cầu của phòng hệ thống (Bước 4)
                        BEGIN
                            DECLARE @Tmp3_RequestStep_StepNo2 NVARCHAR(50);
                            SELECT
                                @Tmp3_RequestStep_StepNo2 = Assigner
                            FROM
                                dbo.RequestSteps ( NOLOCK )
                            WHERE
                                RequestId = @RequestId
                                AND StepNo = 2
                                AND Status = 1;

                            IF ( @Tmp3_RequestStep_StepNo2 <> '' )
                                BEGIN
                                    INSERT INTO #Tmp_Assigner ( Assigner ) SELECT @Tmp3_RequestStep_StepNo2;
                                END;

                            GOTO GOTO__Save_Assigner;
                        END;
                END;

            IF ( @Request_TypeId = 19 AND @StepNo = 1 )
                BEGIN
                    DECLARE
                        @LoaiKNCon_19       NVARCHAR(50) = N''
                      , @Exist_LoaiKN_BH_19 INT          = 0;
                    SELECT TOP 1
                           @LoaiKNCon_19 = RD.Property1
                    FROM
                           dbo.RequestDetails AS RD ( NOLOCK )
                    WHERE
                           RD.RequestId = @RequestId
                           AND RD.Status = 1;
                    SELECT TOP 1
                           @Exist_LoaiKN_BH_19 = I2.Id
                    FROM
                           dbo.Items            AS I ( NOLOCK )
                           INNER JOIN dbo.Items AS I2 ( NOLOCK )
                              ON I.ParentId = I2.Id
                    WHERE
                           I.TypeId = 19
                           AND I.Name = @LoaiKNCon_19
                           AND I.Status = 1
                           AND I2.KeyUnique = 'BH';

                    IF @Exist_LoaiKN_BH_19 > 0
                        BEGIN
                            INSERT INTO #Tmp_Assigner ( Assigner )
                            SELECT
                                E.EmployeeCode
                            FROM
                                #Tmp__F03_EmployeeJobTitles AS E ( NOLOCK )
                            WHERE
                                E.JobTitleCode = '00355'
                                AND E.Status = 'A';
                        END;
                END;

            --	===23===
            IF ( @Request_TypeId = 23 )
                BEGIN
                    IF ( ISNULL(@FromShop, '') = '' )
                        BEGIN
                            IF ( @StepNo = 1 )
                                --	23-Đồ dùng HC (Bước 1) (Đồ dùng HC Khối BO)
                                BEGIN
                                    --▼ Edit - LuanNt44 - 04/09/2019 - Đồ dùng HC cho khối BO
                                    IF ( @Request_Sender IN ( '24111', '8723', '12496', '9817', '17475' ))
                                        BEGIN
                                            --▼ Edit - LuanNt44 - 03/12/2019 - Đồ dùng HC cho khối BO   --LuanNT44-06/01/2020-23-Thêm 9817-- ecom
                                            IF ( @Request_Sender IN ( '24111', '8723', '9817' )) -- ecom
                                                BEGIN
                                                    INSERT INTO #Tmp_Assigner ( Assigner ) VALUES ( '5120' );
                                                END;
                                            IF ( @Request_Sender = '12496' )
                                                BEGIN
                                                    INSERT INTO #Tmp_Assigner ( Assigner ) VALUES ( '5934' ); --Đào tạo
                                                END;
                                            IF ( @Request_Sender = '17475' )
                                                BEGIN
                                                    INSERT INTO #Tmp_Assigner ( Assigner ) VALUES ( '0027' ); --Nguyễn Văn Vạn Giám Đốc TTĐT 24/02/2020 14:00 Han YC
                                                END;
                                        --▲ Edit - LuanNt44 - 03/12/2019 - Đồ dùng HC cho khối BO
                                        END;
                                    ELSE
                                        BEGIN
                                            --▼ Edit - ThuongNM2 - 10/12/2018 - Đồ dùng HC cho khối BO
                                            CREATE TABLE #TempLeaderBO
                                            (
                                                EmpCode NVARCHAR(100)
                                              , EmpName NVARCHAR(1000)
                                              , OrganCode NVARCHAR(100)
                                            );
                                            INSERT #TempLeaderBO ( EmpCode, EmpName, OrganCode )
                                            EXEC [SV_THUC_FRT_INSIDE].FRTInsideV2.dbo.Calllog_GetLeaderDPMByEmployeeCode
                                                @EmployeeCode = @Request_Sender; -- varchar(10)

                                            INSERT INTO #Tmp_Assigner ( Assigner ) SELECT EmpCode FROM #TempLeaderBO;
                                            DROP TABLE #TempLeaderBO;
                                        --▲ Edit - ThuongNM2 - 10/12/2018 - Đồ dùng HC cho khối BO
                                        END;
                                --▲ Edit - LuanNt44 - 04/09/2019 - Đồ dùng HC cho khối BO
                                END;

                            IF ( @StepNo = 2 OR @StepNo = 4 ) --LuanNT44-16/10/2019-23
                                --	23-Đồ dùng HC (Bước 2) (Đồ dùng HC Khối BO)
                                BEGIN
                                    --▼ LuanNT44-12/02/2020-23
                                    DECLARE @Regi VARCHAR(40) = '';
                                    SELECT
                                        @Regi = RegionHierachyCode
                                    FROM
                                        #Tmp__F03_Employees
                                    WHERE
                                        EmployeeCode = @Request_Sender
                                        AND Status = 'A';

                                    IF ( ISNULL(@Regi, '') <> '' )
                                        BEGIN
                                            IF ( @Regi IN ( '00637', '00002', '00003', '00168', '00169', '00170', '00172', '00173', '00174', '00187', '00188', '00189', '00192', '00210', '00236', '00352', '00374', '00390', '00403', '00411', '00413', '00437', '00442', '00460', '00461', '00474', '00527', '00585', '00190' )) --Miền Bắc -LuanNT44-14/05/2020 14:55
                                                BEGIN
                                                    SET @Regi = '00006'; --Hà Nội
                                                END;
                                            ELSE IF ( @Regi IN (   '00179'
                                                                 , '00205'
                                                                 , '00206'
                                                                 , '00224'
                                                                 , '00265'
                                                                 , '00382'
                                                                 , '00452'
                                                                 , '00453'
                                                                 , '00568'
                                                                 , '00571'
                                                                 , '00594' --Miền Đông
                                                                 , '00145'
                                                                 , '00167'
                                                                 , '00181'
                                                                 , '00204'
                                                                 , '00231'
                                                                 , '00257'
                                                                 , '00337'
                                                                 , '00386'
                                                                 , '00414'
                                                                 , '00484'
                                                                 , '00485'
                                                                 , '00486'
                                                                 , '00487'
                                                                 , '00488'
                                                                 , '00498'
                                                                 , '00499'
                                                                 , '00500'
                                                                 , '00501'
                                                                 , '00521'
                                                                 , '00532'
                                                                 , '00559'
                                                                 , '00569' --Miền Tây
                                                                 , '00043'
                                                                 , '00065'
                                                                 , '00072'
                                                                 , '00126'
                                                                 , '00158'
                                                                 , '00178'
                                                                 , '00228'
                                                                 , '00229'
                                                                 , '00241'
                                                                 , '00269'
                                                                 , '00458'
                                                                 , '00459'
                                                               )
                                                    ) --HCM
                                                     BEGIN
                                                         SET @Regi = '00007'; --HCM
                                                     END;
                                            INSERT INTO #Tmp_Assigner ( Assigner )
                                            SELECT DISTINCT
                                                   EmployeeCode
                                            FROM
                                                   #Tmp__F03_EmployeeJobTitles
                                            WHERE
                                                   RegionHierachyCode = @Regi
                                                   AND JobTitleCode = '00073'
                                                   AND Status = 'A'; -- 00073: Nhan vien hanh chinh
                                        END;
                                --▲ LuanNT44-12/02/2020-23
                                END;

                            GOTO GOTO__Save_Assigner;
                        END;
                END;

            --	===24===
            --▼  Add - LuanNT44 - 11/04/2020 - 24 - edit
            IF ( @Request_TypeId = 24 )
                BEGIN
                    IF ( @StepNo = 1 )
                        BEGIN
                            DECLARE @isshop INT = (
                                                      SELECT TOP 1
                                                             RD.Quantity5
                                                      FROM
                                                             dbo.RequestDetails RD ( NOLOCK )
                                                      WHERE
                                                             RD.RequestId = @RequestId
                                                             AND RD.Status = 1
                                                  );
                            IF ( @isshop = 1 ) --Shop
                                BEGIN
                                    --phần quyền
                                    SELECT
                                        Jobtitle
                                    INTO
                                        #Tmp_TypeId_24_Per_1
                                    FROM
                                        dbo.Permissions ( NOLOCK )
                                    WHERE
                                        TypeId = 24
                                        AND StepNo = 1
                                        AND FollowAssignment = 0
                                        AND Status = 1;

                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                    SELECT
                                        E.EmployeeCode
                                    FROM
                                        dbo.F03_EmployeeJobTitles   AS EJ ( NOLOCK )
                                        LEFT JOIN dbo.F03_Employees AS E ( NOLOCK )
                                          ON E.EmployeeCode = EJ.EmployeeCode
                                    WHERE
                                        EJ.JobTitleCode IN ( SELECT P.Jobtitle FROM #Tmp_TypeId_24_Per_1 P )
                                        AND EJ.WarehouseCode = @Request_FromShop
                                        AND EJ.Status = 'A'
                                        AND E.Status = 'A';
                                    DROP TABLE #Tmp_TypeId_24_Per_1;
                                END;
                            ELSE
                                BEGIN
                                    -- CSVC phân công
                                    DECLARE @shopcode24 NVARCHAR(100) = (
                                                                            SELECT TOP 1
                                                                                   R.FromShop
                                                                            FROM
                                                                                   dbo.Requests R ( NOLOCK )
                                                                            WHERE
                                                                                   R.Id = @RequestId
                                                                        );
                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                    SELECT
                                        A.Assigner
                                    FROM
                                        dbo.Assignments A ( NOLOCK )
                                    WHERE
                                        A.PermissionId IN (
                                                              SELECT
                                                                  Id
                                                              FROM
                                                                  dbo.Permissions ( NOLOCK )
                                                              WHERE
                                                                  TypeId = 24
                                                                  AND StepNo = 1
                                                                  AND FollowAssignment = 1
                                                                  AND Status = 1
                                                          )
                                        AND A.Status = 1
                                        AND @shopcode24 IN ( SELECT T.GiaTri FROM dbo.ufn_SplitStringToTable(A.Shop, ',', 0) AS T );
                                END;
                            GOTO GOTO__Save_Assigner;
                        END;
                    IF ( @StepNo = 2 )
                        BEGIN
                            DECLARE
                                @tongtien_24_Thuc  FLOAT
                              , @tongtien_24_chuan FLOAT;
                            SELECT
                                @tongtien_24_Thuc  = SUM(RD.Quantity3)
                              , @tongtien_24_chuan = SUM(RD.Quantity4)
                            FROM
                                dbo.RequestDetails RD ( NOLOCK )
                            WHERE
                                RD.RequestId = @RequestId
                                AND RD.Status = 1;
                            SELECT
                                Jobtitle
                            INTO
                                #Tmp_TypeId_24_Per
                            FROM
                                dbo.Permissions ( NOLOCK )
                            WHERE
                                TypeId = 24
                                AND StepNo = 2
                                --AND Jobtitle IN ( '00002', '00241' ) --RSM/ASM
                                AND Status = 1;

                            DECLARE
                                @region_24   VARCHAR(50) = ''
                              , @region_24_2 VARCHAR(50) = '';
                            DECLARE
                                @RegionL3_24 VARCHAR(50) = ''
                              , @RegionL4_24 VARCHAR(50) = '';
                            IF ( @Request_FromShop <> '' )
                                BEGIN
                                    SELECT TOP 1
                                           @region_24   = W.RegionL2
                                         , @RegionL3_24 = W.RegionL3
                                         , @RegionL4_24 = W.RegionL4
                                    FROM
                                           [10.96.254.143].FRTInsideV2.dbo.Warehouse AS W WITH ( NOLOCK )
                                    WHERE
                                           W.WarehouseCode = @Request_FromShop
                                           AND W.Status = 'A';
                                END;
                            ELSE
                                BEGIN
                                    SET @region_24_2 = (
                                                           SELECT TOP 1
                                                                  RegionHierachyCode
                                                           FROM
                                                                  dbo.F03_Employees ( NOLOCK )
                                                           WHERE
                                                                  EmployeeCode = @Request_Sender
                                                                  AND Status = 'A'
                                                       );
                                END;
                            IF (
                                   @tongtien_24_Thuc < 5000000
                                   AND @tongtien_24_Thuc <> ISNULL(@tongtien_24_chuan, 0)
                               )
                                BEGIN
                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                    SELECT
                                        E.EmployeeCode
                                    FROM
                                        dbo.F03_EmployeeJobTitles   AS EJ ( NOLOCK )
                                        LEFT JOIN dbo.F03_Employees AS E ( NOLOCK )
                                          ON E.EmployeeCode = EJ.EmployeeCode
                                    WHERE
                                        EJ.JobTitleCode = '00241' -- ASM
                                        AND (
                                                EJ.RegionHierachyCode = @region_24
                                                OR EJ.RegionHierachyCode = @RegionL3_24
                                                OR EJ.RegionHierachyCode = @RegionL4_24
                                            )
                                        AND EJ.Status = 'A'
                                        AND E.Status = 'A';

                                END;
                            IF (
                                   @tongtien_24_Thuc >= 5000000
                                   AND @tongtien_24_Thuc <> ISNULL(@tongtien_24_chuan, 0)
                               )
                                BEGIN
                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                    SELECT
                                        E.EmployeeCode
                                    FROM
                                        dbo.F03_EmployeeJobTitles   AS EJ ( NOLOCK )
                                        LEFT JOIN dbo.F03_Employees AS E ( NOLOCK )
                                          ON E.EmployeeCode = EJ.EmployeeCode
                                    WHERE
                                        EJ.JobTitleCode IN ( '00002' ) -- RSM
                                        AND EJ.RegionHierachyCode = ISNULL(@region_24, @region_24_2)
                                        AND EJ.Status = 'A'
                                        AND E.Status = 'A';
                                END;

                            DROP TABLE #Tmp_TypeId_24_Per;

                            GOTO GOTO__Save_Assigner;
                        END;
                END;
            --▲  Add - LuanNT44 - 11/04/2020 - 24 - edit
            --	===25===
            -- Add - LuanNT44 - 25/06/2019 - Màn hình định nghĩa CL Hỗ trợ bán hàng
            IF ( @Request_TypeId = 25 )
                BEGIN
                    IF ( ISNULL(@Request_Note, '') <> '' )
                        BEGIN
                            SELECT
                                P.Id
                            INTO
                                #Tmp_TypeID_25_Per
                            FROM
                                dbo.Permissions AS P ( NOLOCK )
                            WHERE
                                P.TypeId = 25
                                AND P.StepNo = 1
                                AND P.Status = 1;

                            DECLARE @Level25 BIGINT = (
                                                          SELECT TOP 1
                                                                 S.Level
                                                          FROM
                                                                 dbo.SellLineDefine S ( NOLOCK )
                                                          WHERE
                                                                 S.IdFunction = TRY_CONVERT(BIGINT, @Request_Note)
                                                                 AND S.Status = 1
                                                      );

                            SELECT
                                A.Assigner
                            INTO
                                #Tmp_TypeID_25_Ass
                            FROM
                                dbo.Assignments                            AS A ( NOLOCK )
                                LEFT JOIN #Tmp__F03_OrganizationHierachies AS O
                                  ON O.ID = A.Organization
                                     AND O.Status = 'A'
                                LEFT JOIN #Tmp__F03_Employees              AS EM
                                  ON @Request_Sender = EM.EmployeeCode
                            WHERE
                                A.PermissionId IN ( SELECT P.Id FROM #Tmp_TypeID_25_Per AS P )
                                AND @Level25 IN ( SELECT C.GiaTri FROM dbo.ufn_SplitStringToTable(A.CapHeThong, ',', 0) C )
                                AND (
                                        ISNULL(A.Shop, '') = ''
                                        OR @Request_FromShop IN ( SELECT GiaTri FROM dbo.ufn_SplitStringToTable(A.Shop, ',', 0) )
                                        OR @Request_ToShop IN ( SELECT GiaTri FROM dbo.ufn_SplitStringToTable(A.Shop, ',', 0) )
                                        OR (
                                               ISNULL(@Request_FromShop, '') = ''
                                               AND ISNULL(@Request_ToShop, '') = ''
                                               AND EM.RegionHierachyCode IN ( SELECT GiaTri FROM dbo.ufn_SplitStringToTable(A.Region, ',', 0) )
                                           )
                                    )
                                AND (
                                        ISNULL(A.Organization, '') = ''
                                        OR O.OrganizationHierachyCode = @Request_FromOffice
                                        OR O.OrganizationHierachyCode = @Request_ToOffice
                                        OR (
                                               ISNULL(@Request_FromOffice, '') = ''
                                               AND ISNULL(@Request_ToOffice, '') = ''
                                           )
                                    )
                                AND A.Status = 1
                            OPTION ( MAXRECURSION 1000 );



                            INSERT INTO #Tmp_Assigner ( Assigner )
                            SELECT
                                E.EmployeeCode AS Assigner -- varchar(40)
                            FROM
                                #Tmp__F03_Employees AS E
                            WHERE
                                E.EmployeeCode IN ( SELECT A.Assigner FROM #Tmp_TypeID_25_Ass AS A )
                                AND E.Status = 'A';

                            DROP TABLE #Tmp_TypeID_25_Per;
                            DROP TABLE #Tmp_TypeID_25_Ass;
                        END;

                    GOTO GOTO__Save_Assigner;
                END;
            -- Add - LuanNT44 - 25/06/2019 - Màn hình định nghĩa CL Hỗ trợ bán hàng
            --	===53===
            IF ( @Request_TypeId = 53 )
                BEGIN
                    IF ( @StepNo = 1 )
                        --	53-Bàn giao quỹ giữa ca (Bước 1)
                        BEGIN
                            SELECT
                                EJ.EmployeeCode
                              , EJ.JobTitleCode
                            INTO
                                #Tmp__53__1__EmpJob
                            FROM
                                #Tmp__F03_EmployeeJobTitles AS EJ
                            WHERE
                                EJ.WarehouseCode = @Request_FromShop
                                AND EJ.JobTitleCode IN (   '00010'
                                                         , '00408'
                                                         , '00444'
                                                         , '00670' -- 00670:NV bán hàng kiêm thu ngân
                                                         , '00671' -- 00671:Trưởng ca bán hàng
                                                         , '00675' -- 00675:NV bán hàng đa nhiệm
                                                                   --	QL
                                                         , '00004'
                                                         , '00005'
                                                         , '00407'
                                                         , '00447'
                                                         , '00448'
                                                       )
                                AND EJ.EmployeeCode <> @Request_Sender
                                AND EJ.Status = 'A';

                            SELECT
                                EJ.EmployeeCode
                              , EJ.JobTitleCode
                              , CASE
                                    WHEN ( EJ.JobTitleCode IN (   '00010'
                                                                , '00408'
                                                                , '00444'
                                                                , '00670' -- 00670:NV bán hàng kiêm thu ngân
                                                                , '00671' -- 00671:Trưởng ca bán hàng
                                                                , '00675' -- 00675:NV bán hàng đa nhiệm
                                                              )
                                         ) THEN 1
                                    ELSE 0
                                END AS Is_KeToan
                            INTO
                                #Tmp__53__1__Ass
                            FROM
                                #Tmp__53__1__EmpJob            AS EJ
                                INNER JOIN #Tmp__F03_Employees AS E
                                   ON EJ.EmployeeCode = E.EmployeeCode
                            WHERE
                                E.Status = 'A';

                            IF ( EXISTS ( SELECT 1 FROM #Tmp__53__1__Ass AS A WHERE A.Is_KeToan = 1 ))
                                BEGIN
                                    DECLARE
                                        @Now       DATE     = @Request_TimeCreate
                                      , @TimeStart DATETIME = NULL
                                      , @TimeEnd   DATETIME = NULL;
                                    SET @TimeStart = DATEADD(HOUR, 8, @Now);
                                    SET @TimeEnd = DATEADD(HOUR, 15, @Now);

                                    IF ( @Request_TimeCreate BETWEEN @TimeStart AND @TimeEnd )
                                        BEGIN
                                            BEGIN TRY
                                                INSERT INTO #Tmp_Assigner ( Assigner )
                                                --	Note - VietMXH - 12/01/2016 - Chú ý Link Server
                                                EXEC [10.96.254.143].FRTInsideV2.dbo.F07_GetAllEmployKetoanTheoCa
                                                    @Ca = N'C'
                                                  , @Ngay = @Now
                                                  , @ShopCode = @Request_FromShop;
                                            END TRY
                                            BEGIN CATCH
                                                DECLARE @ErrorMessage__53__1__C NVARCHAR(2000);
                                                SET @ErrorMessage__53__1__C = N'Lỗi: [FRTInsideV2.dbo.F07_GetAllEmployKetoanTheoCa]';
                                                SET @ErrorMessage__53__1__C += N', @RequestId=''' + ISNULL(CONVERT(NVARCHAR(50), @RequestId), 'NULL') + N'''';
                                                SET @ErrorMessage__53__1__C += N', @StepNo=''' + ISNULL(CONVERT(NVARCHAR(50), @StepNo), 'NULL') + N'''';
                                                SET @ErrorMessage__53__1__C += N', @Is_NotView=''' + ISNULL(CONVERT(NVARCHAR(50), @Is_NotView), 'NULL') + N'''';
                                                SET @ErrorMessage__53__1__C += N', @Ca=''C''';
                                                SET @ErrorMessage__53__1__C += N', @Now=''' + ISNULL(CONVERT(NVARCHAR(50), @Now, 121), 'NULL') + N'''';
                                                SET @ErrorMessage__53__1__C += N', @ShopCode=''' + ISNULL(CONVERT(NVARCHAR(50), @Request_FromShop), 'NULL') + N'''';
                                                SET @ErrorMessage__53__1__C += N' - ERROR_MESSAGE: ' + ERROR_MESSAGE() + N' - ERROR_LINE: ' + CONVERT(NVARCHAR, ERROR_LINE());

                                                --	===Ghi Log===
                                                INSERT INTO dbo.Logs ( Title, Error, Status, TimeCreate )
                                                VALUES (
                                                           N'Assigners_InsertForRequest' -- Title - nvarchar(300)
                                                         , @ErrorMessage__53__1__C       -- Error - nvarchar(max)
                                                         , 1                             -- Status - tinyint
                                                         , GETDATE()                     -- TimeCreate - datetime
                                                       );
                                            END CATCH;
                                        END;
                                    ELSE
                                        BEGIN
                                            SET @Now = DATEADD(DAY, 1, @Now);

                                            BEGIN TRY
                                                INSERT INTO #Tmp_Assigner ( Assigner )
                                                --	Note - VietMXH - 12/01/2016 - Chú ý Link Server
                                                EXEC [10.96.254.143].FRTInsideV2.dbo.F07_GetAllEmployKetoanTheoCa
                                                    @Ca = N'S'
                                                  , @Ngay = @Now
                                                  , @ShopCode = @Request_FromShop;
                                            END TRY
                                            BEGIN CATCH
                                                DECLARE @ErrorMessage__53__1__S NVARCHAR(2000);
                                                SET @ErrorMessage__53__1__S = N'Lỗi: [FRTInsideV2.dbo.F07_GetAllEmployKetoanTheoCa]';
                                                SET @ErrorMessage__53__1__S += N', @RequestId=''' + ISNULL(CONVERT(NVARCHAR(50), @RequestId), 'NULL') + N'''';
                                                SET @ErrorMessage__53__1__S += N', @StepNo=''' + ISNULL(CONVERT(NVARCHAR(50), @StepNo), 'NULL') + N'''';
                                                SET @ErrorMessage__53__1__S += N', @Is_NotView=''' + ISNULL(CONVERT(NVARCHAR(50), @Is_NotView), 'NULL') + N'''';
                                                SET @ErrorMessage__53__1__S += N', @Ca=''S''';
                                                SET @ErrorMessage__53__1__S += N', @Now=''' + ISNULL(CONVERT(NVARCHAR(50), @Now, 121), 'NULL') + N'''';
                                                SET @ErrorMessage__53__1__S += N', @ShopCode=''' + ISNULL(CONVERT(NVARCHAR(50), @Request_FromShop), 'NULL') + N'''';
                                                SET @ErrorMessage__53__1__S += N' - ERROR_MESSAGE: ' + ERROR_MESSAGE() + N' - ERROR_LINE: ' + CONVERT(NVARCHAR, ERROR_LINE());

                                                --	===Ghi Log===
                                                INSERT INTO dbo.Logs ( Title, Error, Status, TimeCreate )
                                                VALUES (
                                                           N'Assigners_InsertForRequest' -- Title - nvarchar(300)
                                                         , @ErrorMessage__53__1__S       -- Error - nvarchar(max)
                                                         , 1                             -- Status - tinyint
                                                         , GETDATE()                     -- TimeCreate - datetime
                                                       );
                                            END CATCH;
                                        END;
                                END;
                            ELSE
                                BEGIN
                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                    SELECT DISTINCT
                                           A.EmployeeCode
                                    FROM
                                           #Tmp__53__1__Ass AS A
                                    WHERE
                                           A.Is_KeToan = 0;
                                END;

                            DROP TABLE
                                #Tmp__53__1__EmpJob
                              , #Tmp__53__1__Ass;

                            GOTO GOTO__Save_Assigner;
                        END;
                END;

            --	===60===
            IF ( @Request_TypeId = 60 )
                BEGIN
                    IF ( @StepNo = 2 )
                        --	60-Xác nhận công nợ - Bước 2
                        BEGIN
                            --	===Add Người xử lý Phân công Bước 0===
                            INSERT INTO #Tmp_Assigner ( Assigner )
                            SELECT DISTINCT
                                   A.Assigner AS Assigner -- varchar(40)
                            FROM
                                   dbo.Permissions                AS P ( NOLOCK )
                                   INNER JOIN dbo.Assignments     AS A ( NOLOCK )
                                      ON P.TypeId = 60 --	60-Xác nhận công nợ
                                         AND P.StepNo = 0 --	Bước 0
                                         AND P.Status = 1
                                         AND P.Id = A.PermissionId
                                         AND A.Status = 1
                                   INNER JOIN #Tmp__F03_Employees AS E
                                      ON A.Assigner = E.EmployeeCode
                                         AND E.Status = 'A'
                            WHERE
                                   (
                                       ISNULL(A.Shop, '') = ''
                                       OR (
                                              A.Shop <> ''
                                              AND @Request_ToShop IN ( SELECT GiaTri FROM dbo.ufn_SplitStringToTable(A.Shop, ',', 0) )
                                          )
                                   )
                            OPTION ( MAXRECURSION 1000 );

                            GOTO GOTO__Save_Assigner;
                        END;
                END;

            --	===78===
            IF ( @Request_TypeId = 78 )
                BEGIN
                    IF ( @StepNo = 1 )
                        --	78-Khối BO (Bước 1) (Đề nghị Thanh toán Khối BO)
                        BEGIN
                            INSERT INTO #Tmp_Assigner ( Assigner )
                            SELECT
                                Leader
                            FROM
                                #Tmp__F03_Employees
                            WHERE
                                EmployeeCode = @Request_Sender --▶ Edit-LuanNT44-20/11/2018-Sửa rule người xử lý
                                AND Status = 'A';

                            GOTO GOTO__Save_Assigner;
                        END;
                END;

            --	===90===
            IF ( @Request_TypeId = 90 )
                BEGIN
                    IF ( @StepNo = 2 )
                        --	90-Chia target (Bước 2)
                        BEGIN
                            INSERT INTO #Tmp_Assigner ( Assigner )
                            SELECT
                                Leader
                            FROM
                                #Tmp__F03_Employees
                            WHERE
                                EmployeeCode = @Request_Assigner
                                AND Status = 'A';

                            GOTO GOTO__Save_Assigner;
                        END;
                END;

            --	===121===
            IF ( @Request_TypeId = 121 )
                BEGIN
                    IF ( @Request_FromShop <> '' )
                        BEGIN
                            ----- Tìm phòng ban của người gởi CallLog
                            DECLARE @SenderChange NVARCHAR(40) = (
                                                                     SELECT TOP 1
                                                                            EmpCode
                                                                     FROM
                                                                            dbo.RequestDetails ( NOLOCK )
                                                                     WHERE
                                                                            RequestId = @RequestId
                                                                            AND Status = 1
                                                                 );
                            DECLARE @Organiztion_Sender_121 VARCHAR(40) = ISNULL((
                                                                                     SELECT TOP 1
                                                                                            EJT.OrganizationHierachyCode
                                                                                     FROM
                                                                                            #Tmp__F03_EmployeeJobTitles EJT
                                                                                     WHERE
                                                                                            @SenderChange = EJT.EmployeeCode
                                                                                            AND EJT.Status = 'A'
                                                                                 )
                                                                               , ''
                                                                                );
                            DECLARE @Shop_Sender_121 VARCHAR(40) = ISNULL((
                                                                              SELECT TOP 1
                                                                                     EJT.WarehouseCode
                                                                              FROM
                                                                                     #Tmp__F03_EmployeeJobTitles EJT
                                                                              WHERE
                                                                                     @SenderChange = EJT.EmployeeCode
                                                                                     AND EJT.Status = 'A'
                                                                          )
                                                                        , ''
                                                                         );
                            IF ( @StepNo = 1 AND @Organiztion_Sender_121 <> '' )
                                BEGIN
                                    --ChuongNT3 - 30/05/2018 - Thêm người phụ trách xử lý
                                    DECLARE @NVPhuTrach NVARCHAR(20) = (
                                                                           SELECT TOP 1
                                                                                  EmpCode
                                                                           FROM
                                                                                  dbo.RequestDetails ( NOLOCK )
                                                                           WHERE
                                                                                  RequestId = @RequestId
                                                                       );
                                    SELECT
                                        P.Id
                                    INTO
                                        #Temp_Permission121
                                    FROM
                                        dbo.Permissions AS P ( NOLOCK )
                                    WHERE
                                        P.TypeId = 121
                                        AND P.Status = 1
                                        AND P.StepNo = 1
                                        AND P.FollowAssignment = 1;
                                    SELECT
                                        Ass.Assigner
                                    INTO
                                        #Temp_Assigner121
                                    FROM
                                        dbo.Assignments AS Ass ( NOLOCK )
                                    WHERE
                                        Ass.PermissionId IN ( SELECT P12.Id FROM #Temp_Permission121 AS P12 )
                                        AND Ass.Status = 1;
                                    --ChuongNT3 - 30/05/2018 - Thêm người phụ trách xử lý
                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                    VALUES ( @NVPhuTrach -- Assigner - varchar(40)
)                                   ;
                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                    SELECT
                                        EJ.EmployeeCode
                                    FROM
                                        #Tmp__F03_EmployeeJobTitles AS EJ
                                    WHERE
                                        EJ.OrganizationHierachyCode = @Organiztion_Sender_121
                                        AND EJ.Status = 'A'
                                        AND EJ.EmployeeCode IN ( SELECT Assigner FROM #Temp_Assigner121 )
                                        AND EJ.JobTitleCode IN (
                                                                   --	--> Phòng tiếp nhận cuộc gọi
                                                                   '00482' --		Trưởng nhóm tiếp nhận cuộc gọi
                                                                 , '00480' --		Trưởng phòng tiếp nhận cuộc gọi
                                                                 , '00481' --		Phó phòng tiếp nhận cuộc gọi
                                                                           --  --> Phòng xử lý đơn hàng
                                                                 , '00485' --		Phó phòng xử lý đơn hàng
                                                                 , '00484' --		Trưởng phòng xử lý đơn hàng
                                                                 , '00486' --		Trưởng nhóm xử lý đơn hàng
                                                                 , '00573' --		Trưởng Nhóm Xử Lý Đơn Hàng F.F
                                                                           --  --> Phòng kinh doanh phi truyền thống
                                                                 , '00547' --		Trưởng phòng kinh doanh phi truyền thống	
                                                                 , '00505' --	Trưởng Nhóm Dự Án Ecom
                                                                 , '00641' --	Trưởng nhóm Khai thác đơn hàng
                                                               );

                                    DROP TABLE
                                        #Temp_Permission121
                                      , #Temp_Assigner121;
                                END;

                            GOTO GOTO__Save_Assigner;
                        END;
                END;

            --	===122===
            IF ( @Request_TypeId = 122 )
                BEGIN
                    IF ( @StepNo = 2 )
                        BEGIN
                            INSERT INTO #Tmp_Assigner ( Assigner ) VALUES ( @Request_Sender );

                            GOTO GOTO__Add_Default_Permission;
                        END;
                END;

            --	===126===
            IF ( @Request_TypeId = 126 )
                BEGIN
                    IF ( @FromShop <> '' )
                        --	126-Đồ dùng kỹ thuật
                        -------------- Gán lại người xử lý các bước cho loại 126 giống loại 130
                        -------------- ErrorCode = 130: tạo từ loại HC do HC tạo
                        BEGIN
                            CREATE TABLE #Tmp_PermissionT
                            (
                                RowId INT IDENTITY(1, 1)
                              , Jobtitle VARCHAR(40)
                              , FollowAssignment BIT
                              , TypeId INT
                              , Id BIGINT
                              , StepNo INT
                            );
                            -- Lấy danh sách phân quyền
                            IF ( ISNULL(@Loai, '') = 1 )
                                BEGIN
                                    INSERT INTO #Tmp_PermissionT ( Jobtitle, FollowAssignment, TypeId, Id, StepNo )
                                    SELECT
                                        P.Jobtitle
                                                 -- Jobtitle - varchar(40)
                                      , P.FollowAssignment
                                                 -- FollowAssignment - bit
                                      , P.TypeId
                                                 -- TypeId - int
                                      , P.Id
                                                 -- Id - bigint
                                      , P.StepNo -- StepNo - int
                                    FROM
                                        #Tmp_Request                 AS R
                                        INNER JOIN dbo.[Permissions] AS P ( NOLOCK )
                                           -- ON R.Request_TypeId = P.TypeId
                                           ON P.TypeId = 130
                                              AND P.StepNo = @StepNo
                                              AND P.Status = 1
                                              AND P.PermissionType = 0;
                                END;
                            ELSE
                                BEGIN
                                    INSERT INTO #Tmp_PermissionT ( Jobtitle, FollowAssignment, TypeId, Id, StepNo )
                                    SELECT
                                        P.Jobtitle
                                                 -- Jobtitle - varchar(40)
                                      , P.FollowAssignment
                                                 -- FollowAssignment - bit
                                      , P.TypeId
                                                 -- TypeId - int
                                      , P.Id
                                                 -- Id - bigint
                                      , P.StepNo -- StepNo - int
                                    FROM
                                        #Tmp_Request                 AS R
                                        INNER JOIN dbo.[Permissions] AS P ( NOLOCK )
                                           -- ON R.Request_TypeId = P.TypeId
                                           ON P.TypeId = 126
                                              AND P.StepNo = @StepNo
                                              AND P.Status = 1
                                              AND P.PermissionType = 0;
                                END;

                            DECLARE
                                @RowIdT            INT = 1
                              , @RowTotalT         INT = ISNULL(( SELECT MAX(RowId)FROM #Tmp_PermissionT ), 0)
                              , @JobtitleT         VARCHAR(40)
                              , @FollowAssignmentT BIT;

                            WHILE ( @RowIdT <= @RowTotalT )
                                BEGIN
                                    SELECT
                                        @JobtitleT         = Jobtitle
                                      , @FollowAssignmentT = FollowAssignment
                                    FROM
                                        #Tmp_PermissionT
                                    WHERE
                                        RowId = @RowIdT;

                                    IF ( @FollowAssignmentT = 1 )
                                        ----1: Theo người được phân công xử lý
                                        BEGIN
                                            INSERT INTO #Tmp_Assigner ( Assigner )
                                            SELECT
                                                A.Assigner
                                            FROM
                                                #Tmp_Request                               AS R
                                                INNER JOIN #Tmp_PermissionT                AS P
                                                   ON --R.Request_TypeId = P.TypeId
                                                   --P.TypeId = 130
                                                   P.TypeId = IIF(ISNULL(@Loai, '') = 1, 130, 126)
                                                INNER JOIN dbo.Assignments                 AS A ( NOLOCK )
                                                   ON P.Id = A.PermissionId
                                                      AND A.Status = 1
                                                LEFT JOIN #Tmp__F03_OrganizationHierachies AS O
                                                  ON O.ID = A.Organization
                                                     AND O.Status = 'A'
                                                LEFT JOIN #Tmp__F03_Employees              AS EM
                                                  ON R.Request_Sender = EM.EmployeeCode
                                                LEFT JOIN #Tmp__F03_Employees              AS EMA
                                                  ON A.Assigner = EMA.EmployeeCode
                                            WHERE
                                                P.StepNo = @StepNo
                                                AND EM.Status = 'A'
                                                AND EMA.Status = 'A'
                                                AND (
                                                        ISNULL(A.Shop, '') = ''
                                                        OR R.Request_FromShop IN ( SELECT GiaTri FROM dbo.ufn_SplitStringToTable(A.Shop, ',', 0) )
                                                        OR R.Request_ToShop IN ( SELECT GiaTri FROM dbo.ufn_SplitStringToTable(A.Shop, ',', 0) )
                                                        OR (
                                                               R.Request_TypeId <> 102
                                                               AND ISNULL(R.Request_FromShop, '') = ''
                                                               AND ISNULL(R.Request_ToShop, '') = ''
                                                               AND EM.RegionHierachyCode IN ( SELECT Value FROM dbo.fnSplitString(A.Region, ',') )
                                                           )
                                                    )
                                                AND (
                                                        ISNULL(A.Organization, '') = ''
                                                        OR O.OrganizationHierachyCode = R.Request_FromOffice
                                                        OR O.OrganizationHierachyCode = R.Request_ToOffice
                                                        OR (
                                                               ISNULL(R.Request_FromOffice, '') = ''
                                                               AND ISNULL(R.Request_ToOffice, '') = ''
                                                           )
                                                    )
                                                AND ( A.ItemId = 0 OR A.ItemId IN ( SELECT Id FROM #Tmp_Item ))
                                                AND ( A.SourceId = 0 OR A.SourceId IN ( SELECT Id FROM #Tmp_SourceIds ))
                                            OPTION ( MAXRECURSION 1000 );
                                        END;
                                    ELSE
                                        ---- 0: Theo chức danh phân quyền
                                        BEGIN
                                            PRINT N'Theo chức danh phân quyền @1';
                                            INSERT INTO #Tmp_Assigner ( Assigner )
                                            SELECT
                                                EM.EmployeeCode
                                            FROM
                                                #Tmp__F03_Employees                    AS EM
                                                INNER JOIN #Tmp__F03_EmployeeJobTitles AS EJ
                                                   ON EM.EmployeeCode = EJ.EmployeeCode
                                                      AND EM.Status = 'A'
                                                      AND EJ.Status = 'A'
                                            WHERE
                                                EJ.JobTitleCode = @JobtitleT
                                                AND @JobtitleT <> @ASM
                                                AND ( EJ.WarehouseCode = @FromShop OR ISNULL(EJ.WarehouseCode, '') = '' );

                                            IF ( @JobtitleT = @ASM )
                                                -- Nếu phân quyền cho ASM và check không theo phân công
                                                BEGIN
                                                    DECLARE
                                                        @RegionL3T VARCHAR(40)
                                                      , @RegionL4T VARCHAR(40);

                                                    -- Lấy vùng miền của shop tạo
                                                    SELECT
                                                        @RegionL3T = RegionL3
                                                      , @RegionL4T = RegionL4
                                                    FROM
                                                        #Tmp__Warehouse
                                                    WHERE
                                                        WarehouseCode = @FromShop
                                                        AND Status = 'A';

                                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                                    SELECT
                                                        EJ.EmployeeCode
                                                    FROM
                                                        #Tmp__F03_JobTitles                    AS J
                                                        INNER JOIN #Tmp__F03_EmployeeJobTitles AS EJ
                                                           ON J.JobTitleCode = EJ.JobTitleCode
                                                              AND J.Status = 'A'
                                                              AND EJ.Status = 'A'
                                                    WHERE
                                                        J.JobTitleCode = @ASM
                                                        AND ( EJ.RegionHierachyCode = @RegionL3T OR EJ.RegionHierachyCode = @RegionL4T );
                                                END;
                                        END;

                                    SET @RowIdT += 1;
                                END;

                            DROP TABLE #Tmp_PermissionT;

                            GOTO GOTO__Save_Assigner;
                        END;
                END;

            --	===143===
            IF ( @Request_TypeId = 143 )
                BEGIN
                    IF ( @StepNo = 1 )
                        --	143-Claim nhà vận chuyển BO (Bước 1)
                        BEGIN

                            --	===Người Xử lý===
                            CREATE TABLE #Tmp_TypeId143_StepNo1_Permission
                            (
                                RowId INT IDENTITY(1, 1)
                              , Jobtitle VARCHAR(40)
                              , FollowAssignment BIT
                              , TypeId INT
                              , Id BIGINT
                              , StepNo INT
                            );
                            INSERT INTO #Tmp_TypeId143_StepNo1_Permission ( Jobtitle, FollowAssignment, TypeId, Id, StepNo )
                            SELECT
                                P.Jobtitle
                                         -- Jobtitle - varchar(40)
                              , P.FollowAssignment
                                         -- FollowAssignment - bit
                              , P.TypeId
                                         -- TypeId - int
                              , P.Id
                                         -- Id - bigint
                              , P.StepNo -- StepNo - int
                            FROM
                                #Tmp_Request                 AS R
                                INNER JOIN dbo.[Permissions] AS P ( NOLOCK )
                                   ON R.Request_TypeId = P.TypeId
                                      AND P.StepNo = @StepNo
                                      AND P.Status = 1
                                      AND P.PermissionType = 0;

                            DECLARE
                                @TypeId143_StepNo1_RowId            INT = 1
                              , @TypeId143_StepNo1_RowTotal         INT = ISNULL(( SELECT MAX(RowId)FROM #Tmp_TypeId143_StepNo1_Permission ), 0)
                              , @TypeId143_StepNo1_Jobtitle         VARCHAR(40)
                              , @TypeId143_StepNo1_FollowAssignment BIT;

                            CREATE TABLE #Tmp_TypeId143_StepNo1_ShopOrOffice ( VALUE VARCHAR(50));

                            WHILE ( @TypeId143_StepNo1_RowId <= @TypeId143_StepNo1_RowTotal )
                                BEGIN
                                    SELECT
                                        @TypeId143_StepNo1_Jobtitle         = Jobtitle
                                      , @TypeId143_StepNo1_FollowAssignment = FollowAssignment
                                    FROM
                                        #Tmp_TypeId143_StepNo1_Permission
                                    WHERE
                                        RowId = @TypeId143_StepNo1_RowId;

                                    IF ( @TypeId143_StepNo1_FollowAssignment = 1 )
                                        ----1: Theo người được phân công xử lý
                                        BEGIN
                                            INSERT INTO #Tmp_Assigner ( Assigner )
                                            SELECT DISTINCT
                                                   A.Assigner
                                            FROM
                                                   #Tmp_Request                                 AS R
                                                   INNER JOIN #Tmp_TypeId143_StepNo1_Permission AS P
                                                      ON R.Request_TypeId = P.TypeId
                                                   INNER JOIN dbo.Assignments                   AS A ( NOLOCK )
                                                      ON P.Id = A.PermissionId
                                                         AND A.Status = 1
                                                   LEFT JOIN #Tmp__F03_OrganizationHierachies   AS O
                                                     ON O.ID = A.Organization
                                                        AND O.Status = 'A'
                                                   LEFT JOIN #Tmp__F03_Employees                AS EM
                                                     ON R.Request_Sender = EM.EmployeeCode
                                                   LEFT JOIN #Tmp__F03_Employees                AS EMA
                                                     ON A.Assigner = EMA.EmployeeCode
                                            WHERE
                                                   P.StepNo = @StepNo
                                                   AND EM.Status = 'A'
                                                   AND EMA.Status = 'A'
                                                   AND (
                                                           ISNULL(A.Shop, '') = ''
                                                           OR ( EXISTS (
                                                                           SELECT TOP 1
                                                                                  1
                                                                           FROM   (
                                                                                      SELECT
                                                                                          VALUE
                                                                                      FROM
                                                                                          #Tmp_TypeId143_StepNo1_ShopOrOffice
                                                                                      INTERSECT
                                                                                      SELECT
                                                                                          GiaTri
                                                                                      FROM
                                                                                          dbo.ufn_SplitStringToTable(A.Shop, ',', 0)
                                                                                  ) AS tb
                                                                       )
                                                              )
                                                           OR (
                                                                  ISNULL(R.Request_FromShop, '') = ''
                                                                  AND ISNULL(R.Request_ToShop, '') = ''
                                                                  AND EM.RegionHierachyCode IN ( SELECT GiaTri FROM dbo.ufn_SplitStringToTable(A.Region, ',', 0) )
                                                              )
                                                       )
                                                   AND (
                                                           ISNULL(A.Organization, '') = ''
                                                           OR O.OrganizationHierachyCode = R.Request_FromOffice
                                                           OR O.OrganizationHierachyCode = R.Request_ToOffice
                                                           OR (
                                                                  ISNULL(R.Request_FromOffice, '') = ''
                                                                  AND ISNULL(R.Request_ToOffice, '') = ''
                                                              )
                                                       )
                                                   AND ( A.ItemId = 0 OR A.ItemId IN ( SELECT Id FROM #Tmp_Item ))
                                                   AND ( A.SourceId = 0 OR A.SourceId IN ( SELECT Id FROM #Tmp_SourceIds ))
                                            OPTION ( MAXRECURSION 1000 );
                                        END;

                                    IF ( @TypeId143_StepNo1_FollowAssignment = 0 )
                                        ---- 0: Theo chức danh phân quyền
                                        BEGIN
                                            PRINT N'Theo chức danh phân quyền @2';

                                            INSERT INTO #Tmp_Assigner ( Assigner )
                                            SELECT DISTINCT
                                                   EM.EmployeeCode
                                            FROM
                                                   #Tmp__F03_Employees                    AS EM
                                                   INNER JOIN #Tmp__F03_EmployeeJobTitles AS EJ
                                                      ON EM.EmployeeCode = EJ.EmployeeCode
                                                         AND EM.Status = 'A'
                                                         AND EJ.Status = 'A'
                                            WHERE
                                                   EJ.JobTitleCode = @TypeId143_StepNo1_Jobtitle
                                                   AND @TypeId143_StepNo1_Jobtitle <> @ASM
                                                   AND ( EJ.WarehouseCode = @FromShop OR ISNULL(EJ.WarehouseCode, '') = '' );
                                        END;

                                    SET @TypeId143_StepNo1_RowId += 1;
                                END;

                            DROP TABLE
                                #Tmp_TypeId143_StepNo1_Permission
                              , #Tmp_TypeId143_StepNo1_ShopOrOffice;

                            --	===Người được CC===
                            SELECT
                                ShopCode2
                            INTO
                                #Tmp_TypeId143_StepNo1_ShopCode2
                            FROM
                                dbo.RequestDetails ( NOLOCK )
                            WHERE
                                RequestId = @RequestId
                                AND ShopCode2 <> '';

                            IF ( EXISTS ( SELECT TOP 1 1 FROM #Tmp_TypeId143_StepNo1_ShopCode2 ))
                                BEGIN
                                    INSERT INTO dbo.Assigners
                                    (
                                        RequestId
                                      , EmployeeCode
                                      , StepNo
                                      , Type
                                      , Status
                                      , TimeCreate
                                      , GroupMail
                                      , IsRead
                                      , Requests_ARCH_Id
                                      , CreateBy
                                      , TimeUpdate
                                      , UpdateBy
                                    )
                                    SELECT DISTINCT
                                           @RequestId      AS RequestId
                                         , EJ.EmployeeCode AS EmployeeCode
                                         , 1               AS StepNo
                                         , 2               AS Type
                                         , 1               AS Status
                                         , GETDATE()       AS TimeCreate
                                         , NULL            AS GroupMail
                                         , 0               AS IsRead
                                         , NULL            AS Requests_ARCH_Id
                                         , N'-1'           AS CreateBy
                                         , GETDATE()       AS TimeUpdate
                                         , N'-1'           AS UpdateBy -- nvarchar(50)
                                    FROM
                                           #Tmp__F03_EmployeeJobTitles AS EJ
                                    WHERE
                                           EJ.WarehouseCode IN ( SELECT S.ShopCode2 FROM #Tmp_TypeId143_StepNo1_ShopCode2 AS S )
                                           AND EJ.Status = 'A'
                                           AND EJ.JobTitleCode IN (   '00004' --	00004  SM
                                                                    , '00005' --	00005  PSM
                                                                    , '00007' --	00007 Thủ kho chính
                                                                    , '00008' --	00008 Thủ kho quầy
                                                                    , '00295' --	00295 Thủ kho chính_BK
                                                                  );
                                END;

                            DROP TABLE #Tmp_TypeId143_StepNo1_ShopCode2;

                            GOTO GOTO__Save_Assigner;
                        END;
                    IF ( @StepNo = 4 ) --ChuongNT3 - 10//12/2018 - thêm tgian / lý do ko nhâp
                        --ChuongNT3 - 22/10/2018 - thêm hình up thêm
                        BEGIN
                            DECLARE @Sender_143 NVARCHAR(20) = N'';
                            SELECT @Sender_143 = Sender FROM dbo.Requests WHERE Id = @RequestId;
                            INSERT #Tmp_Assigner ( Assigner )
                            VALUES ( @Sender_143 -- Assigner - varchar(40)
)                           ;
                            GOTO GOTO__Save_Assigner;
                        END;
                END;

            --	===150===
            IF ( @Request_TypeId = 150 )
                BEGIN
                    IF ( @StepNo = 2 )
                        --	===150:Giám sát hình ảnh Camera + Bước 2===
                        BEGIN
                            DECLARE @TypeId_150_ShopCode NVARCHAR(50) = ISNULL((
                                                                                   SELECT TOP 1
                                                                                          RD.ShopCode
                                                                                   FROM
                                                                                          dbo.RequestDetails AS RD ( NOLOCK )
                                                                                   WHERE
                                                                                          RD.RequestId = @RequestId
                                                                               )
                                                                             , ''
                                                                              );

                            IF ( @TypeId_150_ShopCode <> '' )
                                BEGIN
                                    DECLARE @TypeId_150_AssignerCC NVARCHAR(50) = N'3247';

                                    IF ( EXISTS (
                                                    SELECT TOP 1
                                                           1
                                                    FROM
                                                           dbo.RequestDetails AS D ( NOLOCK )
                                                    WHERE
                                                           D.RequestId = @RequestId
                                                           AND --	8:Bảo vệ
                                                        D.Property3 = 8
                                                           AND D.Status = 1
                                                )
                                       )
                                        BEGIN
                                            DECLARE @TypeId_150_RegionL2 NVARCHAR(50) = ISNULL((
                                                                                                   SELECT TOP 1
                                                                                                          W.RegionL2
                                                                                                   FROM
                                                                                                          #Tmp__Warehouse AS W
                                                                                                   WHERE
                                                                                                          W.WarehouseCode = @TypeId_150_ShopCode
                                                                                                          AND W.Status = 'A'
                                                                                               )
                                                                                             , ''
                                                                                              );

                                            SET @TypeId_150_AssignerCC = ISNULL(@TypeId_150_AssignerCC, '') + ISNULL(   ( CASE
                                                                                                                              WHEN ( @TypeId_150_RegionL2 = '00006' ) --	00006:Hà Nội
                                                                                                                        THEN      ',11192,13693'
                                                                                                                              WHEN ( @TypeId_150_RegionL2 = '00002' ) --	00002-Miền Bắc 1
                                                                                                                        THEN      ',25977'
                                                                                                                              WHEN ( @TypeId_150_RegionL2 = '00003' ) --	00003:Miền Bắc 2
                                                                                                                        THEN      ',13693,15366'
                                                                                                                              WHEN ( @TypeId_150_RegionL2 = '00498' OR @TypeId_150_RegionL2 = '00484' ) --	00498:Miền Tây Nam Bộ 1 ; 00484:Miền Tây Nam Bộ 2
                                                                                                                        THEN      ',18728'
                                                                                                                              ELSE ''
                                                                                                                          END
                                                                                                                        )
                                                                                                                      , ''
                                                                                                                    );
                                        END;



                                    CREATE TABLE #Table_Tam ( EmployeeCode VARCHAR(40), GroupMail NVARCHAR(3000));
                                    INSERT INTO #Table_Tam ( EmployeeCode, GroupMail )
                                    EXEC dbo.Assigner_Insert
                                        @RequestId = @RequestId
                                      , @StepNo = 2
                                      , @Assigner = @TypeId_150_AssignerCC
                                      , @Type = 2
                                      , @RemoveAssignerOld = NULL;

                                    CREATE TABLE #Tmp_Permission_150
                                    (
                                        RowId INT IDENTITY(1, 1)
                                      , Jobtitle VARCHAR(40)
                                      , FollowAssignment BIT
                                      , TypeId INT
                                      , Id BIGINT
                                      , StepNo INT
                                    );

                                    INSERT INTO #Tmp_Permission_150 ( Jobtitle, FollowAssignment, TypeId, Id, StepNo )
                                    SELECT
                                        P.Jobtitle
                                                 -- Jobtitle - varchar(40)
                                      , P.FollowAssignment
                                                 -- FollowAssignment - bit
                                      , P.TypeId
                                                 -- TypeId - int
                                      , P.Id
                                                 -- Id - bigint
                                      , P.StepNo -- StepNo - int
                                    FROM
                                        dbo.[Permissions] AS P ( NOLOCK )
                                    WHERE
                                        P.TypeId = 150
                                        AND P.StepNo = 2
                                        AND P.PermissionType = 0
                                        AND P.Status = 1;

                                    DECLARE
                                        @RowId_150            INT = 1
                                      , @RowTotal_150         INT = ISNULL(( SELECT MAX(RowId)FROM #Tmp_Permission_150 ), 0)
                                      , @Jobtitle_150         VARCHAR(40)
                                      , @FollowAssignment_150 BIT;

                                    WHILE ( @RowId_150 <= @RowTotal_150 )
                                        BEGIN
                                            SELECT
                                                @Jobtitle_150         = Jobtitle
                                              , @FollowAssignment_150 = FollowAssignment
                                            FROM
                                                #Tmp_Permission_150
                                            WHERE
                                                RowId = @RowId_150;

                                            IF ( @FollowAssignment_150 = 1 )
                                                --	===1:Theo người được phân công xử lý===
                                                BEGIN
                                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                                    SELECT
                                                        A.Assigner
                                                    FROM
                                                        #Tmp_Request                               AS R
                                                        INNER JOIN #Tmp_Permission_150             AS P
                                                           ON R.Request_TypeId = P.TypeId
                                                        INNER JOIN dbo.Assignments                 AS A ( NOLOCK )
                                                           ON P.Id = A.PermissionId
                                                              AND A.Status = 1
                                                        LEFT JOIN #Tmp__F03_OrganizationHierachies AS O
                                                          ON O.ID = A.Organization
                                                             AND O.Status = 'A'
                                                        LEFT JOIN #Tmp__F03_Employees              AS EM
                                                          ON R.Request_Sender = EM.EmployeeCode
                                                        LEFT JOIN #Tmp__F03_Employees              AS EMA
                                                          ON A.Assigner = EMA.EmployeeCode
                                                    WHERE
                                                        P.StepNo = @StepNo
                                                        AND EM.Status = 'A'
                                                        AND EMA.Status = 'A'
                                                        AND (
                                                                ISNULL(A.Shop, '') = ''
                                                                OR @TypeId_150_ShopCode IN ( SELECT GiaTri FROM dbo.ufn_SplitStringToTable(A.Shop, ',', 0) )
                                                                OR (
                                                                       ISNULL(R.Request_FromShop, '') = ''
                                                                       AND ISNULL(R.Request_ToShop, '') = ''
                                                                       AND EM.RegionHierachyCode IN ( SELECT GiaTri FROM dbo.ufn_SplitStringToTable(A.Region, ',', 0) )
                                                                   )
                                                            )
                                                        AND (
                                                                ISNULL(A.Organization, '') = ''
                                                                OR O.OrganizationHierachyCode = R.Request_FromOffice
                                                                OR O.OrganizationHierachyCode = R.Request_ToOffice
                                                                OR (
                                                                       ISNULL(R.Request_FromOffice, '') = ''
                                                                       AND ISNULL(R.Request_ToOffice, '') = ''
                                                                   )
                                                            )
                                                        AND ( A.ItemId = 0 OR A.ItemId IN ( SELECT Id FROM #Tmp_Item ))
                                                        AND ( A.SourceId = 0 OR A.SourceId IN ( SELECT Id FROM #Tmp_SourceIds ))
                                                    OPTION ( MAXRECURSION 1000 );
                                                END;
                                            ELSE
                                                --	===0:Theo chức danh phân quyền===
                                                BEGIN
                                                    PRINT N'Theo chức danh phân quyền @3';

                                                    SELECT
                                                        EJ.EmployeeCode
                                                    INTO
                                                        #temp_F03_EmployeeJobTitles150
                                                    FROM
                                                        #Tmp__F03_EmployeeJobTitles AS EJ
                                                    WHERE
                                                        EJ.WarehouseCode = @TypeId_150_ShopCode
                                                        AND EJ.Status = 'A'
                                                        AND EJ.JobTitleCode IN (
                                                                                   SELECT
                                                                                       J.JobTitleCode
                                                                                   FROM
                                                                                       #Tmp__F03_JobTitles AS J
                                                                                   WHERE
                                                                                       J.JobTitleCode IN (
                                                                                                             SELECT
                                                                                                                 P.Jobtitle
                                                                                                             FROM
                                                                                                                 dbo.Permissions AS P ( NOLOCK )
                                                                                                             WHERE
                                                                                                                 P.TypeId = 150
                                                                                                                 AND P.StepNo = 2
                                                                                                                 AND P.Status = 1
                                                                                                         )
                                                                                       AND J.Status = 'A'
                                                                               )
                                                        AND --	Bỏ chức danh của VNM không cho nhận shop thường
                                                        EJ.JobTitleCode <> '00579';

                                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                                    SELECT EmployeeCode FROM #temp_F03_EmployeeJobTitles150;

                                                    DECLARE
                                                        @RegionL2_150 VARCHAR(40)
                                                      , @RegionL3_150 VARCHAR(40)
                                                      , @RegionL4_150 VARCHAR(40);

                                                    --	===Lấy vùng miền của shop tạo===
                                                    SELECT
                                                        @RegionL2_150 = RegionL2
                                                      , @RegionL3_150 = RegionL3
                                                      , @RegionL4_150 = RegionL4
                                                    FROM
                                                        #Tmp__Warehouse
                                                    WHERE
                                                        WarehouseCode = @TypeId_150_ShopCode
                                                        AND Status = 'A';

                                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                                    SELECT
                                                        EJ.EmployeeCode
                                                    FROM
                                                        #Tmp__F03_EmployeeJobTitles   AS EJ
                                                        LEFT JOIN #Tmp__F03_JobTitles AS J
                                                          ON EJ.JobTitleCode = J.JobTitleCode
                                                             AND J.Status = 'A'
                                                    WHERE
                                                        EJ.Status = 'A'
                                                        AND J.JobTitleCode IN (
                                                                                  SELECT
                                                                                      Jobtitle
                                                                                  FROM
                                                                                      dbo.Permissions ( NOLOCK )
                                                                                  WHERE
                                                                                      TypeId = 150
                                                                                      AND StepNo = 2
                                                                                      AND Status = 1
                                                                                      AND FollowAssignment = 0
                                                                              )
                                                        AND (
                                                                EJ.RegionHierachyCode = @RegionL3_150
                                                                OR EJ.RegionHierachyCode = @RegionL4_150
                                                                OR EJ.RegionHierachyCode = @RegionL2_150
                                                            )
                                                        AND J.JobTitleCode <> '00579';

                                                    CREATE TABLE #Tabet_SM
                                                    (
                                                        EmployeeCode VARCHAR(40)
                                                      , EmployeeName NVARCHAR(3000)
                                                      , JobTitle VARCHAR(40)
                                                      , WarehouseCode VARCHAR(40)
                                                    );

                                                    --	===Thêm SM cho shop VNM===
                                                    IF ( LEFT(@TypeId_150_ShopCode, 1) = 7 )
                                                        BEGIN
                                                            INSERT INTO #Tmp_Assigner ( Assigner )
                                                            SELECT
                                                                EJ.EmployeeCode
                                                            FROM
                                                                #Tmp__F03_EmployeeJobTitles   AS EJ
                                                                LEFT JOIN #Tmp__F03_JobTitles AS J
                                                                  ON EJ.JobTitleCode = J.JobTitleCode
                                                                     AND J.Status = 'A'
                                                            WHERE
                                                                EJ.Status = 'A'
                                                                AND J.JobTitleCode IN (
                                                                                          SELECT
                                                                                              Jobtitle
                                                                                          FROM
                                                                                              dbo.Permissions ( NOLOCK )
                                                                                          WHERE
                                                                                              TypeId = 150
                                                                                              AND StepNo = 2
                                                                                              AND Status = 1
                                                                                              AND FollowAssignment = 0
                                                                                      )
                                                                AND (
                                                                        EJ.RegionHierachyCode = @RegionL3_150
                                                                        OR EJ.RegionHierachyCode = @RegionL4_150
                                                                        OR EJ.RegionHierachyCode = @RegionL2_150
                                                                    )
                                                                AND J.JobTitleCode <> '00579';

                                                            INSERT INTO #Tabet_SM ( EmployeeCode, EmployeeName, JobTitle, WarehouseCode )
                                                            EXEC [10.96.254.143].FRTInsideV2.dbo.Calllog_GetManagerByShop
                                                                @Warehouse = @TypeId_150_ShopCode; -- varchar(10)

                                                            IF ( SELECT COUNT(1)FROM #Tabet_SM ) > 0
                                                                BEGIN
                                                                    INSERT INTO #Tmp_Assigner ( Assigner ) SELECT EmployeeCode FROM #Tabet_SM;
                                                                END;
                                                        END;

                                                    DROP TABLE #Tabet_SM;
                                                    DROP TABLE #temp_F03_EmployeeJobTitles150;
                                                END;

                                            SET @RowId_150 += 1;
                                        END;

                                    DROP TABLE #Tmp_Permission_150;
                                END;

                            DROP TABLE #Table_Tam;

                            GOTO GOTO__Save_Assigner;
                        END;
                END;

            --	===152===
            IF ( @Request_TypeId = 152 )
                --	152-Áo đồng phục phòng nhân sự và đào tạo
                BEGIN
                    IF ( @Request_FromShop <> '' )
                        BEGIN
                            ----- Tìm phòng ban của người gởi CallLog
                            DECLARE @Organiztion_Sender VARCHAR(40) = ISNULL((
                                                                                 SELECT TOP 1
                                                                                        EJT.OrganizationHierachyCode
                                                                                 FROM
                                                                                        #Tmp__F03_EmployeeJobTitles EJT
                                                                                 WHERE
                                                                                        @Request_Sender = EJT.EmployeeCode
                                                                                        AND EJT.Status = 'A'
                                                                             )
                                                                           , ''
                                                                            );

                            IF ( @StepNo = 1 AND @Organiztion_Sender <> '' )
                                BEGIN
                                    --▼ Edit-LuanNT44-25/11/2019-152-add NXL PB 0054
                                    SELECT
                                        EJ.EmployeeCode
                                    INTO
                                        #tmp_Assinger_152
                                    FROM
                                        #Tmp__F03_EmployeeJobTitles AS EJ
                                    WHERE
                                        EJ.OrganizationHierachyCode = @Organiztion_Sender
                                        AND EJ.Status = 'A'
                                        AND EJ.JobTitleCode IN (
                                                                   --	===Leader Nhân sự===
                                                                   '00312' --	00312-Phó Giám đốc nhân sự
                                                                 , '00371' --	00371-Trưởng Nhóm Quản Lý Cán Bộ
                                                                 , '00374' --	00374-Trưởng nhóm tuyển dụng
                                                                 , '00173' --	00173-Trưởng Nhóm Nhân Sự Tiền Lương
                                                                 , '00170' --	00170-Giám đốc nhân sự
                                                                 , '00051' --	00051-Trưởng phòng Nhân sự
                                                                           --	===Leader Đào tạo===
                                                                 , '00060' --	00060-Trưởng phòng đào tạo
                                                                 , '00340' --	00340-Phó giám đốc đào tạo
                                                                 , '00200' --	00200-Trưởng phòng đào tạo
                                                                 , '00339' --   00339 - Giám đốc đào tạo          --Add_LuanNT44-25/11/2019-152- thupt5 yc update thêm chức danh
                                                               );
                                    IF (
                                           @Organiztion_Sender = '0054' --Phòng đào tạo miền Bắc --> Hân YC
                                           AND NOT EXISTS ( SELECT TOP 1 1 FROM #tmp_Assinger_152 )
                                       )
                                        BEGIN
                                            INSERT INTO #Tmp_Assigner ( Assigner )
                                            VALUES ( '2419' -- Assigner - varchar(40)
)                                           ;
                                        END;
                                    ELSE
                                        BEGIN
                                            IF EXISTS ( SELECT TOP 1 1 FROM #tmp_Assinger_152 )
                                                BEGIN
                                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                                    SELECT A.EmployeeCode FROM #tmp_Assinger_152 A;
                                                END;
                                        END;
                                    DROP TABLE #tmp_Assinger_152;
                                --▲ Edit-LuanNT44-25/11/2019-152-add NXL PB 0054 
                                END;

                            ----- Chuyển CallLog theo phân công
                            IF ( @StepNo = 3 )
                                BEGIN
                                    SELECT
                                        TypeId
                                      , FromShop
                                    INTO
                                        #Request
                                    FROM
                                        dbo.Requests
                                    WHERE
                                        Id = @RequestId;

                                    SELECT
                                        Id
                                      , TypeId
                                    INTO
                                        #permission
                                    FROM
                                        dbo.Permissions
                                    WHERE
                                        FollowAssignment = 1
                                        AND TypeId = 152
                                        AND Status = 1
                                        AND StepNo = 3;

                                    SELECT
                                        A.Assigner
                                      , A.Shop
                                      , P.TypeId
                                      , R.FromShop
                                    INTO
                                        #Jobtitle_HC_TheoVungMien
                                    FROM
                                        #permission               P
                                        LEFT JOIN dbo.Assignments A ( NOLOCK )
                                          ON A.PermissionId = P.Id
                                        LEFT JOIN #Request        R
                                          ON R.TypeId = P.TypeId
                                    WHERE
                                        A.Status = 1;

                                    IF (( SELECT FromShop FROM #Request ) NOT IN ( '0009', '0010' ))
                                        BEGIN
                                            INSERT INTO #Tmp_Assigner ( Assigner )
                                            SELECT
                                                EJ.EmployeeCode
                                            FROM
                                                #Tmp__F03_EmployeeJobTitles AS EJ
                                            WHERE
                                                EJ.Status = 'A'
                                                AND EJ.EmployeeCode IN (
                                                                           SELECT
                                                                               HC.Assigner
                                                                           FROM
                                                                               #Jobtitle_HC_TheoVungMien HC
                                                                           WHERE
                                                                               HC.FromShop IN ( SELECT GiaTri FROM dbo.ufn_SplitStringToTable(HC.Shop, ',', 0) )
                                                                       )
                                            OPTION ( MAXRECURSION 1000 );
                                        END;
                                    ELSE
                                        BEGIN
                                            SELECT
                                                EmployeeCode
                                            INTO
                                                #Temp_F03_Employees_MN
                                            FROM
                                                #Tmp__F03_Employees
                                            WHERE
                                                Status = 'A';

                                            INSERT INTO #Tmp_Assigner ( Assigner )
                                            SELECT
                                                A.Assigner
                                            FROM
                                                dbo.Assignments                   AS A
                                                INNER JOIN #Temp_F03_Employees_MN AS T
                                                   ON T.EmployeeCode = A.Assigner
                                            WHERE
                                                A.PermissionId IN (
                                                                      SELECT
                                                                          Id
                                                                      FROM
                                                                          dbo.Permissions
                                                                      WHERE
                                                                          TypeId = 152
                                                                          AND FollowAssignment = 1
                                                                          AND Status = 1
                                                                          AND StepNo = 3
                                                                  )
                                                AND ( EXISTS (
                                                                 SELECT TOP 1
                                                                        1
                                                                 FROM
                                                                        dbo.fnSplitString(Region, ',')
                                                                 WHERE
                                                                        Value IN ( '00007', '00004', '00068', '00204', '00205', '00484', '00498' )
                                                             )
                                                    )
                                                AND A.Status = 1;

                                            DROP TABLE #Temp_F03_Employees_MN;
                                        END;

                                    --====== Xóa bảng tạm
                                    DROP TABLE
                                        #Jobtitle_HC_TheoVungMien
                                      , #permission
                                      , #Request;
                                END;

                            IF ( @StepNo = 4 )
                                BEGIN
                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                    SELECT
                                        EJ.EmployeeCode
                                    FROM
                                        #Tmp__F03_EmployeeJobTitles AS EJ
                                    WHERE
                                        EJ.Status = 'A'
                                        AND EJ.EmployeeCode = @Request_Sender;
                                END;

                            GOTO GOTO__Save_Assigner;
                        END;
                END;

            --	===156===
            IF ( @Request_TypeId = 156 )
                BEGIN
                    IF ( LEFT(@Request_FromShop, 1) = '7' )
                        BEGIN
                            IF ( @StepNo = 1 )
                                BEGIN
                                    -- Lấy danh sách phân quyền
                                    SELECT
                                        ROW_NUMBER() OVER ( ORDER BY P.Id ) 'RowId'
                                      , P.Jobtitle
                                      , P.FollowAssignment
                                      , P.TypeId
                                      , P.Id
                                      , P.StepNo
                                    INTO
                                        #Permission_156
                                    FROM
                                        dbo.[Permissions]      P ( NOLOCK )
                                        LEFT JOIN #Tmp_Request R
                                          ON P.TypeId = R.Request_TypeId
                                             AND P.StepNo = @StepNo
                                    WHERE
                                        R.Request_TypeId IS NOT NULL
                                        AND P.Status = 1
                                        AND P.PermissionType = 0;

                                    DECLARE
                                        @RowId_156            INT = 1
                                      , @RowTotal_156         INT = ( SELECT COUNT(1)FROM #Permission_156 )
                                      , @Jobtitle_156         VARCHAR(40)
                                      , @FollowAssignment_156 BIT;

                                    WHILE ( @RowId_156 <= @RowTotal_156 )
                                        BEGIN
                                            SELECT
                                                @Jobtitle_156         = Jobtitle
                                              , @FollowAssignment_156 = FollowAssignment
                                            FROM
                                                #Permission_156
                                            WHERE
                                                RowId = @RowId_156;

                                            IF ( @FollowAssignment_156 = 1 ) ----1: Theo người được phân công xử lý
                                                BEGIN
                                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                                    SELECT
                                                        A.Assigner
                                                    FROM
                                                        dbo.Assignments ( NOLOCK )                 A
                                                        LEFT JOIN #Permission_156                  P
                                                          ON A.PermissionId = P.Id
                                                        LEFT JOIN #Tmp_Request                     R
                                                          ON P.TypeId = R.Request_TypeId
                                                        LEFT JOIN #Tmp__F03_OrganizationHierachies AS O
                                                          ON O.ID = A.Organization
                                                             AND O.Status = 'A'
                                                        LEFT JOIN #Tmp__F03_Employees              AS EM
                                                          ON R.Request_Sender = EM.EmployeeCode
                                                        LEFT JOIN #Tmp__F03_Employees              AS EMA
                                                          ON A.Assigner = EMA.EmployeeCode
                                                    WHERE
                                                        R.Request_TypeId IS NOT NULL
                                                        AND A.Status = 1
                                                        AND P.StepNo = @StepNo
                                                        AND EM.Status = 'A'
                                                        AND EMA.Status = 'A'
                                                        AND (
                                                                ISNULL(A.Shop, '') = ''
                                                                OR R.Request_FromShop IN ( SELECT GiaTri FROM dbo.ufn_SplitStringToTable(A.Shop, ',', 0) )
                                                                OR R.Request_ToShop IN ( SELECT GiaTri FROM dbo.ufn_SplitStringToTable(A.Shop, ',', 0) )
                                                                OR (
                                                                       R.Request_TypeId <> 102
                                                                       AND ISNULL(R.Request_FromShop, '') = ''
                                                                       AND ISNULL(R.Request_ToShop, '') = ''
                                                                       AND EM.RegionHierachyCode IN ( SELECT GiaTri FROM dbo.ufn_SplitStringToTable(A.Region, ',', 0) )
                                                                   )
                                                            )
                                                        AND (
                                                                ISNULL(A.Organization, '') = ''
                                                                OR O.OrganizationHierachyCode = R.Request_FromOffice
                                                                OR O.OrganizationHierachyCode = R.Request_ToOffice
                                                                OR (
                                                                       ISNULL(R.Request_FromOffice, '') = ''
                                                                       AND ISNULL(R.Request_ToOffice, '') = ''
                                                                   )
                                                            )
                                                        AND ( A.ItemId = 0 OR A.ItemId IN ( SELECT Id FROM #Tmp_Item ))
                                                        AND ( A.SourceId = 0 OR A.SourceId IN ( SELECT Id FROM #Tmp_SourceIds ))
                                                    OPTION ( MAXRECURSION 1000 );
                                                END;
                                            ELSE ---- 0: Theo chức danh phân quyền
                                                BEGIN
                                                    PRINT N'Theo chức danh phân quyền @4';

                                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                                    SELECT
                                                        EM.EmployeeCode
                                                    FROM
                                                        #Tmp__F03_Employees                   AS EM
                                                        LEFT JOIN #Tmp__F03_EmployeeJobTitles AS EJ
                                                          ON EM.EmployeeCode = EJ.EmployeeCode
                                                             AND EJ.Status = 'A'
                                                        LEFT JOIN #Tmp__Warehouse             W
                                                          ON W.WarehouseCode = EM.WarehouseCode
                                                             AND W.Status = 'A'
                                                    WHERE
                                                        EJ.JobTitleCode = @Jobtitle_156
                                                        AND EM.Status = 'A'
                                                        AND @Jobtitle_156 <> @ASM
                                                        AND (
                                                                W.WarehouseCodeVNM = @Request_FromShop
                                                                OR ISNULL(EJ.WarehouseCode, '') = ''
                                                            );

                                                    IF ( @Jobtitle_156 = @ASM ) -- Nếu phân quyền cho ASM và check không theo phân công
                                                        BEGIN

                                                            DECLARE
                                                                @RegionL3_156 VARCHAR(40)
                                                              , @RegionL4_156 VARCHAR(40);

                                                            -- Lấy vùng miền của shop tạo
                                                            SELECT
                                                                @RegionL3_156 = RegionL3
                                                              , @RegionL4_156 = RegionL4
                                                            FROM
                                                                #Tmp__Warehouse
                                                            WHERE
                                                                WarehouseCode = @Request_FromShop
                                                                AND Status = 'A';

                                                            INSERT INTO #Tmp_Assigner ( Assigner )
                                                            SELECT
                                                                EJ.EmployeeCode
                                                            FROM
                                                                #Tmp__F03_EmployeeJobTitles   AS EJ
                                                                LEFT JOIN #Tmp__F03_JobTitles AS J
                                                                  ON EJ.JobTitleCode = J.JobTitleCode
                                                                     AND J.Status = 'A'
                                                            WHERE
                                                                EJ.Status = 'A'
                                                                AND J.JobTitleCode = @ASM
                                                                AND (
                                                                        EJ.RegionHierachyCode = @RegionL3_156
                                                                        OR EJ.RegionHierachyCode = @RegionL4_156
                                                                    );


                                                        END;
                                                END;

                                            SET @RowId_156 += 1;
                                        END;

                                    DROP TABLE #Permission_156;
                                END;

                            GOTO GOTO__Save_Assigner;
                        END;
                END;

            --	===170===
            IF ( @Request_TypeId = 170 )
                BEGIN
                    IF ( @StepNo = 1 )
                        BEGIN
                            DECLARE
                                @OrganizationHierachies_170 NVARCHAR(40) = N''
                              , @JobTitle_170               NVARCHAR(40);
                            SELECT
                                @OrganizationHierachies_170 = EJ.OrganizationHierachyCode
                              , @JobTitle_170               = J.JobTitleCode
                            FROM
                                #Tmp__F03_Employees                        E
                                LEFT JOIN #Tmp__F03_OrganizationHierachies EJ
                                  ON E.OrganizationHierachyCode = EJ.OrganizationHierachyCode
                                     AND EJ.Status = 'A'
                                LEFT JOIN #Tmp__F03_JobTitles              J
                                  ON E.JobTitle = J.JobTitleCode
                                     AND J.Status = 'A'
                            WHERE
                                E.EmployeeCode = @Request_Sender
                                AND E.Status = 'A';

                            IF (( @OrganizationHierachies_170 <> '0003' )
                                OR (
                                       @OrganizationHierachies_170 = '0003'
                                       AND ( @JobTitle_170 = '00241' OR @JobTitle_170 = '00457' )
                                   )
                               )
                                BEGIN
                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                    SELECT
                                        Leader
                                    FROM
                                        #Tmp__F03_Employees
                                    WHERE
                                        EmployeeCode = @Request_Sender
                                        AND Status = 'A';
                                END;

                            GOTO GOTO__Add_Default_Permission;
                        END;
                END;

            --	===171===
            IF ( @Request_TypeId = 171 )
                BEGIN
                    IF ( @StepNo = 1 )
                        --	171-Import calllog chờ xử lý. Bước 1
                        BEGIN
                            --Edit-LuanNT44-18/06/2018-loại 171-shop ass
                            SELECT
                                P.Id
                            INTO
                                #Tmp_171_1_Permissions
                            FROM
                                dbo.Permissions AS P ( NOLOCK )
                            WHERE
                                P.TypeId = 171
                                AND P.StepNo = 1
                                AND P.Status = 1;

                            INSERT INTO #Tmp_Assigner ( Assigner )
                            SELECT DISTINCT
                                   A.Assigner AS Assigner -- varchar(40)
                            FROM
                                   dbo.Assignments                AS A ( NOLOCK )
                                   INNER JOIN #Tmp__F03_Employees E
                                      ON A.Assigner = E.EmployeeCode
                            WHERE
                                   A.PermissionId IN ( SELECT P.Id FROM #Tmp_171_1_Permissions AS P )
                                   AND A.Status = 1
                                   AND E.Status = 'A'
                                   AND @Request_ToShop IN ( SELECT GiaTri AS Status FROM dbo.ufn_SplitStringToTable(A.Shop, ',', 0) );
                            --Edit-LuanNT44-18/06/2018-loại 171-shop ass
                            DROP TABLE #Tmp_171_1_Permissions;

                            GOTO GOTO__Save_Assigner;
                        END;
                END;

            --	===179=== ChuongNT3 - 06/08/2018 - chuyển phân công sang phân quyền
            IF ( @Request_TypeId = 179 )
                BEGIN
                    IF ( @StepNo = 1 )
                        BEGIN
                            DECLARE @p__TypeId_179__Shop NVARCHAR(20) = ( SELECT TOP 1 Request_ToShop FROM #Tmp_Request );
                            SELECT
                                P.Id
                              , P.Jobtitle
                            INTO
                                #Tmp__TypeId_179__Per
                            FROM
                                dbo.Permissions AS P ( NOLOCK )
                            WHERE
                                P.TypeId = 179
                                AND P.StepNo = @StepNo
                                AND P.Status = 1;
                            INSERT INTO #Tmp_Assigner ( Assigner )
                            SELECT DISTINCT
                                   E.EmployeeCode AS Assigner -- varchar(40)
                            FROM
                                   #Tmp__F03_Employees              E
                                   INNER JOIN #Tmp__TypeId_179__Per P
                                      ON E.JobTitle = P.Jobtitle
                                   INNER JOIN #Tmp__Warehouse       W
                                      ON W.RegionL2 = E.RegionHierachyCode
                            WHERE
                                   E.Status = 'A'
                                   AND W.WarehouseCode = @p__TypeId_179__Shop;
                            DROP TABLE #Tmp__TypeId_179__Per;
                            GOTO GOTO__Save_Assigner;
                        END;
                    IF ( @StepNo = 2 )
                        BEGIN
                            INSERT INTO #Tmp_Assigner ( Assigner )
                            VALUES ( '-3' -- Assigner - varchar(40)
)                           ;
                            GOTO GOTO__Save_Assigner;
                        END;
                END;
            --	ChuongNT3 - 06/08/2018 - chuyển phân công sang phân quyền

            --	===181:Sửa chữa lightbox (hộp đèn hãng) – demo===
            IF ( @Request_TypeId = 181 )
                BEGIN
                    IF ( @StepNo = 1 )
                        BEGIN
                            DECLARE
                                @BoPhanPhuTrach INT = 0
                              , @HangMuc        NVARCHAR(MAX)
                              , @Hang           INT
                              , @LoaiHang       INT; --ChuongNT3 - 02/10/2018 - chuyển ngươi xử lý

                            SELECT
                                @BoPhanPhuTrach = RD.Quantity3
                              , @HangMuc        = RD.Property2
                              , @Hang           = RD.Quantity2
                              , @LoaiHang       = RD.Quantity1 --ChuongNT3 - 02/10/2018 - chuyển ngươi xử lý
                            FROM
                                dbo.RequestDetails AS RD ( NOLOCK )
                            WHERE
                                RD.RequestId = @RequestId
                                AND RD.Status = 1;

                            --ChuongNT3 - 31/08/2018 - fix người xử lý theo phân công 
                            DECLARE
                                @Ma_Shop_181    NVARCHAR(20) = N''
                              , @Ma_Shop_B1_181 NVARCHAR(20) = N'';
                            SELECT
                                @Ma_Shop_181    = WarehouseCode
                              , @Ma_Shop_B1_181 = WarehouseCodeB1
                            FROM
                                dbo.Warehouse ( NOLOCK )
                            WHERE
                                WarehouseCode = @Request_FromShop;
                            --ChuongNT3 - 31/08/2018 - fix người xử lý theo phân công 

                            SELECT
                                P.Id
                            INTO
                                #Tmp_Permissions_181
                            FROM
                                dbo.Permissions AS P ( NOLOCK )
                            WHERE
                                P.TypeId = 181
                                AND P.StepNo = 1
                                AND P.Status = 1;

                            SELECT
                                A.Assigner
                            INTO
                                #Tmp_Assignments_181
                            FROM
                                dbo.Assignments AS A ( NOLOCK )
                            WHERE
                                A.PermissionId IN ( SELECT P.Id FROM #Tmp_Permissions_181 AS P )
                                AND (
                                        @Ma_Shop_181 IN ( SELECT GiaTri FROM dbo.ufn_SplitStringToTable(A.Shop, ',', 0) )
                                        OR @Ma_Shop_B1_181 IN ( SELECT GiaTri FROM dbo.ufn_SplitStringToTable(A.Shop, ',', 0) )
                                    ) --ChuongNT3 - 31/08/2018 - fix người xử lý theo phân công 
                                AND A.Status = 1;

                            IF ( @BoPhanPhuTrach = 1 )
                                BEGIN
                                    --ChuongNT3 - 02/10/2018 - chuyển ngươi xử lý
                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                    SELECT
                                        E.EmployeeCode
                                    FROM
                                        #Tmp__F03_Employees AS E
                                    WHERE
                                        E.EmployeeCode IN ( SELECT A.Assigner FROM #Tmp_Assignments_181 AS A )
                                        AND E.OrganizationHierachyCode IN ( '0032', '0033', '0034', '0035' )
                                        AND E.Status = 'A'
                                        AND E.JobTitle IN ( '00383' );
                                END;
                            ELSE IF ( @BoPhanPhuTrach = 3 )
                                     BEGIN
                                         INSERT INTO #Tmp_Assigner ( Assigner )
                                         SELECT
                                             E.EmployeeCode
                                         FROM
                                             #Tmp__F03_Employees AS E
                                         WHERE
                                             E.EmployeeCode IN ( SELECT A.Assigner FROM #Tmp_Assignments_181 AS A )
                                             AND E.OrganizationHierachyCode IN ( '00799', '0008', '00469' )
                                             AND E.Status = 'A';
                                     END;
                            ELSE IF ( @BoPhanPhuTrach = 2 )
                                     BEGIN
                                         INSERT INTO #Tmp_Assigner ( Assigner )
                                         SELECT
                                             N'H' + V.Code AS Code
                                         FROM
                                             [10.96.254.55].FRTCallLogV2.dbo.Vendors AS V WITH ( NOLOCK )
                                         WHERE
                                             V.Code = @Hang
                                             AND V.Status = 'A';
                                     END;
                            ELSE IF ( @BoPhanPhuTrach = 4 ) --ChuongNT3 - 02/10/2018 - chuyển ngươi xử lý
                                     BEGIN
                                         INSERT INTO #Tmp_Assigner ( Assigner )
                                         SELECT
                                             E.EmployeeCode
                                         FROM
                                             #Tmp__F03_Employees AS E
                                         WHERE
                                             E.EmployeeCode IN ( SELECT A.Assigner FROM #Tmp_Assignments_181 AS A )
                                             --AND E.OrganizationHierachyCode IN ( '0032', '0033', '0034', '0035' )
                                             AND E.Status = 'A'
                                             AND E.JobTitle IN ( '00053', '00073', '00175', '00176', '00279', '00385' );
                                     END;

                            DROP TABLE
                                #Tmp_Permissions_181
                              , #Tmp_Assignments_181;

                            GOTO GOTO__Save_Assigner;
                        END;

                    IF ( @StepNo = 2 )
                        BEGIN
                            INSERT INTO #Tmp_Assigner ( Assigner )
                            SELECT
                                E.EmployeeCode
                            FROM
                                #Tmp__F03_EmployeeJobTitles    AS EJ
                                INNER JOIN #Tmp__F03_Employees AS E
                                   ON E.EmployeeCode = EJ.EmployeeCode
                            WHERE
                                EJ.JobTitleCode IN ( '00004', '00407', '00005', '00447', '00448' )
                                AND EJ.WarehouseCode = @Request_FromShop
                                AND EJ.Status = 'A'
                                AND E.Status = 'A';

                            GOTO GOTO__Save_Assigner;
                        END;
                END;

            --	===184===
            --	===NgoanHT - 28/11/2017 - Thêm lấy người xử lý cho loại 184===
            IF ( @Request_TypeId = 184 )
                BEGIN
                    IF ( @StepNo = 1 )
                        BEGIN
                            --======Lấy DS Permissions
                            SELECT
                                P.Id
                              , P.ItemId
                            INTO
                                #Tmp_184_Permissions
                            FROM
                                dbo.Permissions AS P ( NOLOCK )
                            WHERE
                                P.TypeId = 184
                                AND P.Status = 1;

                            --======Lấy DS Assignments	
                            SELECT
                                A.Id
                              , A.PermissionId
                              , A.Assigner
                              , A.Shop
                              , A.ItemId
                            INTO
                                #Tmp_184_Assignments
                            FROM
                                dbo.Assignments AS A ( NOLOCK )
                            WHERE
                                A.PermissionId IN ( SELECT P.Id FROM #Tmp_184_Permissions AS P )
                                AND A.Status = 1;

                            --	===Add Người xử lý Phân công
                            INSERT INTO #Tmp_Assigner ( Assigner )
                            SELECT DISTINCT
                                   A.Assigner
                            FROM
                                   #Tmp_184_Assignments            AS A
                                   INNER JOIN #Tmp_184_Permissions AS p
                                      ON p.Id = A.PermissionId
                                   INNER JOIN #Tmp_Request         AS R
                                      ON R.Request_GroupId = A.ItemId
                                         OR A.ItemId = 0
                            WHERE
                                   (
                                       ISNULL(A.Shop, '') = ''
                                       OR (
                                              A.Shop <> ''
                                              AND @Request_ToShop IN ( SELECT GiaTri FROM dbo.ufn_SplitStringToTable(A.Shop, ',', 0) )
                                          )
                                   )
                            OPTION ( MAXRECURSION 1000 );

                            DROP TABLE
                                #Tmp_184_Assignments
                              , #Tmp_184_Permissions;

                            GOTO GOTO__Save_Assigner;
                        END;
                END;

            -- === 191 ===
            --▼ Add - ThuongNM2 - 07/11/2018 - Loại 191 Layout Shop Thường
            IF ( @Request_TypeId = 191 )
                --	Loại 191 Layout Shop Thường
                BEGIN
                    IF ( @StepNo = 1 )
                        BEGIN
                            CREATE TABLE #Temp_Ass191 ( EmployeeCode VARCHAR(40));
                            SELECT
                                P.Id
                              , P.Jobtitle
                            INTO
                                #Temp_Permission_191
                            FROM
                                dbo.Permissions P ( NOLOCK )
                            WHERE
                                P.TypeId = 191
                                AND P.StepNo = 1
                                AND P.Status = 1;
                            INSERT #Temp_Ass191 ( EmployeeCode )
                            SELECT
                                A.Assigner
                            FROM
                                #Temp_Permission_191       P
                                INNER JOIN dbo.Assignments A ( NOLOCK )
                                   ON P.Id = A.PermissionId
                            WHERE
                                P.Jobtitle <> '00002'
                                AND A.Status = 1;
                            DECLARE @Vung191 NVARCHAR(40) = N'';
                            SELECT
                                @Vung191 = RegionL2
                            FROM
                                #Tmp__Warehouse
                            WHERE
                                WarehouseCode = @FromShop;
                            INSERT #Temp_Ass191 ( EmployeeCode )
                            SELECT
                                EmployeeCode
                            FROM
                                #Tmp__F03_EmployeeJobTitles E
                            WHERE
                                E.JobTitleCode = '00002'
                                AND E.RegionHierachyCode = @Vung191
                                AND E.Status = 'A';
                            INSERT INTO #Tmp_Assigner ( Assigner )
                            SELECT DISTINCT EmployeeCode FROM #Temp_Ass191;

                            DROP TABLE
                                #Temp_Ass191
                              , #Temp_Permission_191;
                            GOTO GOTO__Save_Assigner;
                        END;
                END;
            --▲ Add - ThuongNM2 - 07/11/2018 - Loại 191 Layout Shop Thường	

            --	===198===
            IF ( @Request_TypeId = 198 )
                --	198:Chi phí BH Máy cũ
                BEGIN
                    IF ( @StepNo = 2 )
                        BEGIN
                            DECLARE @IdCalllog BIGINT = 0;
                            DECLARE @As NVARCHAR(40) = N'';
                            SELECT TOP 1
                                   @IdCalllog = Id
                                 , @As        = Sender
                            FROM
                                   dbo.Requests ( NOLOCK )
                            WHERE
                                   Id = @RequestId;

                            IF ( @As <> '' )
                                BEGIN
                                    INSERT INTO #Tmp_Assigner ( Assigner ) VALUES ( @As );

                                    SET @Request_Assigner_UuTien = @As;
                                END;

                            GOTO GOTO__Add_Default_Permission;
                        END;
                END;

            --	===200===
            -- Add - LuanNT44 - 09/03/2018 - Thêm lấy người xử lý Sale đảm trách
            IF ( @Request_TypeId = 200 )
                --	200-Chuyển cọc đơn hàng ecom
                BEGIN
                    ----PRINT (N'@Request_SaleCode: '+ISNULL(@Request_SaleCode, 'NULL'))

                    IF ( @Request_SaleCode <> '' )
                        BEGIN
                            DECLARE @TypeID_200_OrgHieCode NVARCHAR(40) = ISNULL((
                                                                                     SELECT TOP 1
                                                                                            NV.OrganizationHierachyCode
                                                                                     FROM
                                                                                            #Tmp__F03_Employees AS NV
                                                                                     WHERE
                                                                                            NV.EmployeeCode = @Request_SaleCode
                                                                                            AND Status = 'A'
                                                                                 )
                                                                               , ''
                                                                                );

                            ----PRINT (N'@TypeID_200_OrgHieCode: '+ISNULL(@TypeID_200_OrgHieCode, 'NULL'))

                            IF ( @TypeID_200_OrgHieCode <> '' )
                                BEGIN
                                    SELECT
                                        P.Id
                                    INTO
                                        #Tmp_TypeID_200_Per
                                    FROM
                                        dbo.Permissions AS P ( NOLOCK )
                                    WHERE
                                        P.TypeId = 200
                                        AND P.StepNo = 1
                                        AND P.Status = 1;

                                    SELECT
                                        A.Assigner
                                    INTO
                                        #Tmp_TypeID_200_Ass
                                    FROM
                                        dbo.Assignments AS A ( NOLOCK )
                                    WHERE
                                        A.PermissionId IN ( SELECT P.Id FROM #Tmp_TypeID_200_Per AS P )
                                        AND A.Status = 1;

                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                    SELECT
                                        E.EmployeeCode AS Assigner -- varchar(40)
                                    FROM
                                        #Tmp__F03_Employees AS E
                                    WHERE
                                        E.EmployeeCode IN ( SELECT A.Assigner FROM #Tmp_TypeID_200_Ass AS A )
                                        AND E.OrganizationHierachyCode = @TypeID_200_OrgHieCode
                                        AND E.Status = 'A';

                                    DROP TABLE #Tmp_TypeID_200_Per;
                                    DROP TABLE #Tmp_TypeID_200_Ass;
                                END;
                        END;

                    GOTO GOTO__Save_Assigner;
                END;
            -- Add - LuanNT44 - 09/03/2018 - Thêm lấy người xử lý Sale đảm trách

            --	===204===
            IF ( @Request_TypeId = 204 )
                --	204:Chốt CR qua Calllog
                BEGIN
                    IF ( @StepNo = 1 )
                        BEGIN
                            DECLARE @Assigner_TypeId_204 VARCHAR(50) = (
                                                                           SELECT TOP 1
                                                                                  Leader
                                                                           FROM
                                                                                  dbo.F03_Employees ( NOLOCK )
                                                                           WHERE
                                                                                  EmployeeCode = @Request_Sender
                                                                       );

                            IF ( @Assigner_TypeId_204 <> '' )
                                BEGIN
                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                    VALUES ( @Assigner_TypeId_204 -- Assigner - varchar(40)
)                                   ;
                                END;

                            GOTO GOTO__Save_Assigner;
                        END;

                    IF ( @StepNo = 2 OR @StepNo = 3 )
                        BEGIN
                            SELECT
                                P.Id
                            INTO
                                #Tmp__TypeId_204__StepNo_2_3
                            FROM
                                dbo.Permissions AS P ( NOLOCK )
                            WHERE
                                P.TypeId = 204
                                AND P.StepNo = @StepNo
                                AND P.Status = 1;

                            CREATE TABLE #tmp_phongban_detail_204 ( OfficeCode NVARCHAR(50), Property5 NVARCHAR(MAX));

                            IF ( EXISTS ( SELECT 1 FROM #Tmp__TypeId_204__StepNo_2_3 ))
                                BEGIN
                                    INSERT INTO #tmp_phongban_detail_204 ( OfficeCode, Property5 )
                                    SELECT
                                        D.OfficeCode AS OfficeCode
                                      , D.Property5  AS Property5
                                    FROM
                                        dbo.RequestDetails AS D ( NOLOCK )
                                    WHERE
                                        D.RequestId = @RequestId
                                        AND D.Status = 1;

                                    IF ( EXISTS ( SELECT 1 FROM #tmp_phongban_detail_204 ))
                                        BEGIN
                                            INSERT INTO #Tmp_Assigner ( Assigner )
                                            SELECT
                                                A.Assigner AS Assigner
                                            FROM
                                                dbo.Assignments_ChotCR              AS A ( NOLOCK )
                                                INNER JOIN #tmp_phongban_detail_204 D
                                                   ON A.Department = D.OfficeCode
                                                INNER JOIN #tmp_phongban_detail_204 D2
                                                   ON A.GroupSystem = D2.Property5
                                            WHERE
                                                A.PermissionId IN ( SELECT t.Id FROM #Tmp__TypeId_204__StepNo_2_3 AS t )
                                                AND A.Status = 1;
                                        END;
                                END;

                            DROP TABLE #Tmp__TypeId_204__StepNo_2_3;
                            DROP TABLE #tmp_phongban_detail_204;

                            GOTO GOTO__Save_Assigner;
                        END;
                END;

            --	===205===
            IF ( @Request_TypeId = 205 ) -- lấy phân công theo phân loại 
                BEGIN
                    DECLARE
                        @PhanLoai INT          = 0
                      , @ShopCode VARCHAR(30)  = ''
                      , @Vung     NVARCHAR(30) = N''
                      , @Tinh     NVARCHAR(30) = N'';

                    SELECT
                        @PhanLoai = ISNULL(RD.Quantity, 0)
                      , @ShopCode = ISNULL(RD.ShopCode, 0)
                    FROM
                        dbo.RequestDetails ( NOLOCK ) AS RD
                    WHERE
                        RD.RequestId = @RequestId;

                    PRINT ( N'@PhanLoai: ' + ISNULL(( TRY_CONVERT(NVARCHAR(50), @PhanLoai)), 'NULL'));

                    --lấy vùng miền của shop 
                    --ChuongNT3 - 31/08/2018 - fix người xử lý theo phân công 
                    DECLARE
                        @Ma_Shop_205    NVARCHAR(20) = N''
                      , @Ma_Shop_B1_205 NVARCHAR(20) = N''
                      , @Vung_Mien_205  NVARCHAR(20) = N'';

                    SELECT TOP 1
                           @Ma_Shop_205    = WarehouseCode
                         , @Ma_Shop_B1_205 = WarehouseCodeB1
                         , @Vung_Mien_205  = RegionL2
                    FROM
                           dbo.Warehouse ( NOLOCK )
                    WHERE
                           WarehouseCode = @ShopCode
                           AND Status = 'A';
                    --ChuongNT3 - 31/08/2018 - fix người xử lý theo phân công 

                    IF ( ISNULL(@Ma_Shop_205, '') <> '' OR ISNULL(@Ma_Shop_B1_205, '') <> '' ) --Chuyển NV HC
                        BEGIN
                            --ChuongNT3 - 30/08/2018 - fix người xử lý theo phân công 
                            IF ( @StepNo = 3 )
                                BEGIN
                                    IF ( @PhanLoai = 1 ) --Chuyển  đến KTHO và Phòng bảo hành
                                        BEGIN
                                            SELECT
                                                Jobtitle
                                              , Id
                                            INTO
                                                #Tmp_F03_JobTitles_205PL1
                                            FROM
                                                dbo.Permissions ( NOLOCK )
                                            WHERE
                                                TypeId = 205
                                                AND Status = 1
                                                AND StepNo = 3
                                                AND Jobtitle IN (   '00116'
                                                                  , '00206'
                                                                  , '00351'
                                                                  , '00352'
                                                                  , '00353'
                                                                  , '00354'
                                                                  , '00461'
                                                                  , '00499'
                                                                  , '00117'
                                                                  , '00139'
                                                                  , '00140' -- Phòng bảo hành 
                                                                  , '00138'
                                                                  , '00144'
                                                                  , '00145'
                                                                  , '00163''00164'
                                                                  , '00165'
                                                                  , '00343'
                                                                  , '00344'
                                                                  , '00345'
                                                                  , '00346'
                                                                  , '00347'
                                                                  , '00161' -- kế toán HO
                                                                  , '00344' -- ChuongNT3 - 11/12/2018 - Nhân Viên Kế Toán Chi Nhánh
                                                                );

                                            INSERT INTO #Tmp_Assigner ( Assigner )
                                            SELECT
                                                Assigner
                                            FROM
                                                dbo.Assignments ( NOLOCK )
                                            WHERE
                                                PermissionId IN ( SELECT Id FROM #Tmp_F03_JobTitles_205PL1 )
                                                AND Status = 1
                                                AND EXISTS (
                                                               SELECT
                                                                   Value
                                                               FROM
                                                                   dbo.fnSplitString(Region, ',')
                                                               WHERE
                                                                   Value = @Vung_Mien_205
                                                           );
                                            --SELECT
                                            --                     JobTitleCode
                                            --                 INTO
                                            --                     #Tmp_F03_JobTitles_205PL11
                                            --                 FROM
                                            --                     dbo.F03_JobTitles(NOLOCK)
                                            --                 WHERE
                                            --                     JobTitleCode IN ( '00116', '00206', '00351', '00352', '00353', '00354', '00461', '00499', '00117', '00139', '00140',-- Phòng bảo hành 
                                            --                                       '00138', '00144', '00145', '00163''00164', '00165', '00343', '00344', '00345', '00346', '00347'-- kế toán HO
                                            --				  , '00344' -- ChuongNT3 - 11/12/2018 - Nhân Viên Kế Toán Chi Nhánh
                                            --      )
                                            --                     AND Status = 'A';
                                            --                 INSERT  #Tmp_Assigner
                                            --                         (
                                            --                           Assigner
                                            --                         )
                                            --                 SELECT
                                            --                     EM.EmployeeCode
                                            --                 FROM
                                            --                     dbo.F03_Employees (NOLOCK) EM
                                            --                 WHERE
                                            --                     EM.JobTitle IN ( SELECT
                                            --                                         JobTitleCode
                                            --                                      FROM
                                            --                                         #Tmp_F03_JobTitles_205PL11 )
                                            --                     AND EM.Status = 'A'
                                            --                     AND EM.RegionHierachyCode = @Vung_Mien_205;

                                            DROP TABLE #Tmp_F03_JobTitles_205PL1;

                                            GOTO GOTO__Save_Assigner;
                                        END;

                                    IF ( @PhanLoai = 2 ) -- Chuyển đến KTHO
                                        BEGIN
                                            SELECT
                                                Jobtitle
                                              , Id
                                            INTO
                                                #Tmp_F03_JobTitles_205PL2
                                            FROM
                                                dbo.Permissions ( NOLOCK )
                                            WHERE
                                                TypeId = 205
                                                AND Status = 1
                                                AND StepNo = 3
                                                AND Jobtitle IN (   '00138'
                                                                  , '00144'
                                                                  , '00145'
                                                                  , '00163''00164'
                                                                  , '00165'
                                                                  , '00343'
                                                                  , '00344'
                                                                  , '00345'
                                                                  , '00346'
                                                                  , '00347'
                                                                  , '00161' -- kế toán HO
                                                                  , '00344' -- ChuongNT3 - 11/12/2018 - Nhân Viên Kế Toán Chi Nhánh
                                                                );
                                            INSERT INTO #Tmp_Assigner ( Assigner )
                                            SELECT
                                                Assigner
                                            FROM
                                                dbo.Assignments ( NOLOCK )
                                            WHERE
                                                PermissionId IN ( SELECT Id FROM #Tmp_F03_JobTitles_205PL2 )
                                                AND Status = 1
                                                AND EXISTS (
                                                               SELECT
                                                                   Value
                                                               FROM
                                                                   dbo.fnSplitString(Region, ',')
                                                               WHERE
                                                                   Value = @Vung_Mien_205
                                                           );
                                            --SELECT
                                            --                     JobTitleCode
                                            --                 INTO
                                            --                     #Tmp_F03_JobTitles_205PL22
                                            --                 FROM
                                            --                     dbo.F03_JobTitles(NOLOCK)
                                            --                 WHERE
                                            --                     JobTitleCode IN ( '00138', '00144', '00145', '00163''00164', '00165', '00343', '00344', '00345', '00346', '00347'-- kế toán HO
                                            --, '00344' -- ChuongNT3 - 11/12/2018 - Nhân Viên Kế Toán Chi Nhánh
                                            --)
                                            --                     AND Status = 'A';

                                            --                 INSERT  #Tmp_Assigner
                                            --                         (
                                            --                           Assigner
                                            --                         )
                                            --                 SELECT
                                            --                     EM.EmployeeCode
                                            --                 FROM
                                            --                     dbo.F03_Employees (NOLOCK) EM
                                            --                 WHERE
                                            --                     EM.JobTitle IN ( SELECT
                                            --                                         JobTitleCode
                                            --                                      FROM
                                            --                                         #Tmp_F03_JobTitles_205PL22 )
                                            --                     AND EM.Status = 'A'
                                            ----ChuongNT3 - 30/08/2018 - fix người xử lý theo phân công 
                                            --                     AND EM.RegionHierachyCode = @Vung_Mien_205;
                                            DROP TABLE #Tmp_F03_JobTitles_205PL2;

                                            GOTO GOTO__Save_Assigner;
                                        END;

                                    IF ( @PhanLoai = 3 ) -- CHuyển đến CSVC
                                        BEGIN
                                            SELECT
                                                Jobtitle
                                              , Id
                                            INTO
                                                #Tmp_F03_JobTitles_205PL3
                                            FROM
                                                dbo.Permissions ( NOLOCK )
                                            WHERE
                                                TypeId = 205
                                                AND Status = 1
                                                AND StepNo = 3
                                                AND Jobtitle IN ( '00058', '00673', '00383' );
                                            INSERT INTO #Tmp_Assigner ( Assigner )
                                            SELECT
                                                Assigner
                                            FROM
                                                dbo.Assignments ( NOLOCK )
                                            WHERE
                                                PermissionId IN ( SELECT Id FROM #Tmp_F03_JobTitles_205PL3 )
                                                AND Status = 1
                                                AND EXISTS (
                                                               SELECT
                                                                   Value
                                                               FROM
                                                                   dbo.fnSplitString(Region, ',')
                                                               WHERE
                                                                   Value = @Vung_Mien_205
                                                           );
                                            --	 SELECT
                                            --                       JobTitleCode
                                            --                   INTO
                                            --                       #Tmp_F03_JobTitles_205PL33
                                            --                   FROM
                                            --                       dbo.F03_JobTitles(NOLOCK)
                                            --                   WHERE
                                            --                       JobTitleCode IN ( '00383' ,'00058','00673' -- CSVC
                                            --)
                                            --                       AND Status = 'A';
                                            --                   INSERT  #Tmp_Assigner
                                            --                           (
                                            --                             Assigner
                                            --                           )
                                            --                   SELECT
                                            --                       EM.EmployeeCode
                                            --                   FROM
                                            --                       dbo.F03_Employees (NOLOCK) EM
                                            --                   WHERE
                                            --                       EM.JobTitle IN ( SELECT
                                            --                                           JobTitleCode
                                            --                                        FROM
                                            --                                           #Tmp_F03_JobTitles_205PL33 )
                                            --                       AND EM.Status = 'A'
                                            --		--ChuongNT3 - 30/08/2018 - fix người xử lý theo phân công 
                                            --                       AND EM.RegionHierachyCode = @Vung_Mien_205;
                                            DROP TABLE #Tmp_F03_JobTitles_205PL3;
                                            GOTO GOTO__Save_Assigner;
                                        END;
                                END;
                            ELSE
                                BEGIN
                                    INSERT #Tmp_Assigner ( Assigner )
                                    SELECT
                                        Assigner
                                    FROM
                                        dbo.Assignments ( NOLOCK )
                                    WHERE
                                        PermissionId IN (
                                                            SELECT
                                                                Id
                                                            FROM
                                                                dbo.Permissions ( NOLOCK )
                                                            WHERE
                                                                TypeId = @Request_TypeId
                                                                AND StepNo = @StepNo
                                                                AND Status = 1
                                                        )
                                        AND (
                                                @Ma_Shop_B1_205 IN ( SELECT GiaTri FROM dbo.ufn_SplitStringToTable(Shop, ',', 0) )
                                                OR @Ma_Shop_205 IN ( SELECT GiaTri FROM dbo.ufn_SplitStringToTable(Shop, ',', 0) )
                                            ) --ChuongNT3 - 31/08/2018 - fix người xử lý theo phân công 
                                        AND Status = 1;
                                END;

                            GOTO GOTO__Save_Assigner;
                        END;
                    ELSE
                        BEGIN
                            GOTO GOTO__Add_Default_Permission;
                        END;
                END;

            --	===207===
            --▼ Add - ThuongNM2 - 02/08/2018 - Loại 207 Chiến giá đại bàng
            IF ( @Request_TypeId = 207 )
                --	207:CallLog Chiến Giá Đại Bàng
                BEGIN
                    IF ( @StepNo = 1 )
                        BEGIN
                            INSERT INTO #Tmp_Assigner ( Assigner )
                            SELECT
                                E.EmployeeCode
                            FROM
                                #Tmp__F03_EmployeeJobTitles   AS EJ
                                LEFT JOIN #Tmp__F03_Employees AS E
                                  ON E.EmployeeCode = EJ.EmployeeCode
                            WHERE
                                EJ.JobTitleCode IN ( '00004', '00005' )
                                AND EJ.WarehouseCode IN ( SELECT Request_ToShop FROM #Tmp_Request )
                                AND EJ.Status = 'A'
                                AND E.Status = 'A';

                            GOTO GOTO__Save_Assigner;
                        END;
                END;
            --▲ Add - ThuongNM2 - 02/08/2018 - Loại 207 Chiến giá đại bàng

            --▼ Add - TuanNA89 - 26/11/2019 - Calllog Duyệt công nợ KH VNPT - Loại 221
            IF ( @Request_TypeId = 221 )
                BEGIN
                    IF ( @StepNo = 1 )
                        BEGIN
                            SELECT
                                P.Jobtitle
                            INTO
                                #tmp_Permissions_221
                            FROM
                                dbo.Permissions AS P ( NOLOCK )
                            WHERE
                                P.TypeId = @Request_TypeId;

                            DECLARE @Vung_221 VARCHAR(50) = '';
                            SELECT
                                @Vung_221 = TW.RegionL2
                            FROM
                                #Tmp__Warehouse AS TW
                            WHERE
                                TW.WarehouseCode = @Request_FromShop;

                            INSERT INTO #Tmp_Assigner ( Assigner )
                            SELECT
                                E.EmployeeCode
                            FROM
                                #Tmp__F03_Employees AS E
                            WHERE
                                E.JobTitle IN ( SELECT TP.Jobtitle FROM #tmp_Permissions_221 AS TP )
                                AND E.RegionHierachyCode = @Vung_221
                                AND E.Status = 'A';

                            DROP TABLE #tmp_Permissions_221;
                            GOTO GOTO__Save_Assigner;
                        END;
                END;
            --▲ Add - TuanNA89 - 26/11/2019 - Calllog Duyệt công nợ KH VNPT - Loại 221

            --▼ Add - LuanNT44 - 10/02/2020 - Loại 226 - Duyệt hạn mức thẻ cào/Momo/Viettel pay
            --IF ( @Request_TypeId = 226 )
            --    BEGIN
            --        IF ( @StepNo = 1 )
            --            BEGIN
            --                SELECT
            --                    P.Jobtitle
            --                INTO
            --                    #tmp_Permissions_226
            --                FROM
            --                    dbo.Permissions AS P ( NOLOCK )
            --                WHERE
            --                    P.TypeId = @Request_TypeId
            --                    AND P.StepNo = 1
            --                    AND P.Status = 1;

            --                DECLARE
            --                    @VungRegionL2_226 VARCHAR(50) = ''
            --                  , @VungRegionL3_226 VARCHAR(50) = ''
            --                  , @VungRegionL4_226 VARCHAR(50) = '';
            --                SELECT TOP 1
            --                    @VungRegionL2_226 = TW.RegionL2
            --                  , @VungRegionL3_226 = TW.RegionL3
            --                  , @VungRegionL4_226 = TW.RegionL4
            --                FROM
            --                    #Tmp__Warehouse AS TW
            --                WHERE
            --                    TW.WarehouseCode = @Request_FromShop;

            --                INSERT INTO #Tmp_Assigner ( Assigner )
            --                SELECT
            --                    EJ.EmployeeCode
            --                FROM
            --                    #Tmp__F03_EmployeeJobTitles AS EJ
            --                WHERE
            --                    EJ.JobTitleCode IN ( SELECT P.Jobtitle FROM #tmp_Permissions_226 P )
            --                    AND EJ.RegionHierachyCode IN ( @VungRegionL2_226, @VungRegionL3_226, @VungRegionL4_226 )
            --                    AND EJ.Status = 'A';

            --                DROP TABLE #tmp_Permissions_226;
            --                GOTO GOTO__Save_Assigner;
            --            END;
            --    END;
            --▲ Add - LuanNT44 - 10/02/2020 - Loại 226 - Duyệt hạn mức thẻ cào/Momo/Viettel pay

            --	====================================================================================================
            --	==========ADD CC==========
            IF ( 1 = 1 )
                BEGIN

                    IF ( @Request_TypeId = 22 )
                        BEGIN
                            IF ( @StepNo = 1 )
                                BEGIN
                                    INSERT dbo.Assigners
                                    (
                                        RequestId
                                      , EmployeeCode
                                      , StepNo
                                      , Type
                                      , Status
                                      , TimeCreate
                                      , GroupMail
                                      , IsRead
                                      , Requests_ARCH_Id
                                      , CreateBy
                                      , TimeUpdate
                                      , UpdateBy
                                    )
                                    SELECT DISTINCT
                                           @RequestId     AS RequestId
                                         , E.EmployeeCode AS EmployeeCode
                                         , 1              AS StepNo
                                         , 2              AS Type
                                         , 1              AS Status
                                         , GETDATE()      AS TimeCreate
                                         , NULL           AS GroupMail
                                         , 0              AS IsRead
                                         , NULL           AS Requests_ARCH_Id
                                         , N'-1'          AS CreateBy
                                         , GETDATE()      AS TimeUpdate
                                         , N'-1'          AS UpdateBy -- nvarchar(50)
                                    FROM
                                           #Tmp__F03_EmployeeJobTitles   AS EJ
                                           LEFT JOIN #Tmp__F03_Employees AS E
                                             ON E.EmployeeCode = EJ.EmployeeCode
                                    WHERE
                                           EJ.JobTitleCode IN ( '00004', '00005', '00407', '00447' )
                                           AND EJ.WarehouseCode IN ( SELECT Request_FromShop FROM #Tmp_Request )
                                           AND EJ.Status = 'A'
                                           AND E.Status = 'A';

                                    GOTO GOTO__Add_Default_Permission;
                                END;
                        END;
                    --Edit-LuanNT44-18/12/2018-Loại 92-Bỏ add cc cho user
                    --IF ( @Request_TypeId = 92 )
                    --    BEGIN
                    --        IF (
                    --             @StepNo = 3
                    --             OR @StepNo = 5
                    --           )
                    --            BEGIN
                    --                BEGIN TRY
                    --                    CREATE TABLE #Table_Tam_CC
                    --                    (
                    --                      EmployeeCode VARCHAR(40)
                    --                    , GroupMail NVARCHAR(3000)
                    --                    );
                    --                    INSERT  INTO #Table_Tam_CC
                    --                            (
                    --                              EmployeeCode
                    --                            , GroupMail
                    --                            )
                    --                            EXEC dbo.Assigner_Insert
                    --                                @RequestId = @RequestId
                    --                              , @StepNo = @StepNo
                    --                              , @Assigner = N'2198'
                    --                              , @Type = 2
                    --                              , @RemoveAssignerOld = 0;

                    --                    DROP TABLE #Table_Tam_CC;
                    --                END TRY
                    --                BEGIN CATCH
                    --                    PRINT N'Lỗi insert bảng tạm!';
                    --                END CATCH;

                    --                GOTO GOTO__Add_Default_Permission;
                    --            END;
                    --    END;
                    --▼ Edit-LuanNT44-18/01/2019-Loại 94-Bỏ add cc cho user
                    --IF ( @Request_TypeId = 94 )
                    --    BEGIN
                    --        IF ( @StepNo = 3 )
                    --            BEGIN
                    --                BEGIN TRY
                    --                    CREATE TABLE #Table_Tam_CC_94
                    --                    (
                    --                      EmployeeCode VARCHAR(40)
                    --                    , GroupMail NVARCHAR(3000)
                    --                    );

                    --                    INSERT  INTO #Table_Tam_CC_94
                    --                            (
                    --                              EmployeeCode
                    --                            , GroupMail
                    --                            )
                    --                            EXEC dbo.Assigner_Insert
                    --                                @RequestId = @RequestId
                    --                              , @StepNo = @StepNo
                    --                              , @Assigner = '2198'
                    --                              , @Type = 2
                    --                              , @RemoveAssignerOld = 0;

                    --                    DROP TABLE #Table_Tam_CC_94;
                    --                END TRY
                    --                BEGIN CATCH
                    --                    PRINT N'Lỗi insert bảng tạm!';
                    --                END CATCH;

                    --                GOTO GOTO__Add_Default_Permission;
                    --            END;
                    --    END;
                    --▲ Edit-LuanNT44-18/01/2019-Loại 94-Bỏ add cc cho user
                    --▼ ChuongNT3 - 29/10/2018 - add CC SM shop
                    IF ( @Request_TypeId = 134 )
                        BEGIN
                            EXEC dbo.Change_CC_SM_Shop @RequestId = @RequestId;
                            GOTO GOTO__Add_Default_Permission;
                        END;
                    --▲ ChuongNT3 - 29/10/2018 - add CC SM shop

                    IF ( @Request_TypeId = 179 )
                        BEGIN
                            IF ( @StepNo = 2 )
                                BEGIN
                                    INSERT INTO #Tmp_Assigner ( Assigner ) VALUES ( '-3' );
                                    INSERT INTO dbo.Assigners
                                    (
                                        RequestId
                                      , EmployeeCode
                                      , StepNo
                                      , Type
                                      , Status
                                      , TimeCreate
                                      , GroupMail
                                      , IsRead
                                      , Requests_ARCH_Id
                                      , CreateBy
                                      , TimeUpdate
                                      , UpdateBy
                                    )
                                    SELECT DISTINCT
                                           @RequestId      AS RequestId
                                         , EJ.EmployeeCode AS EmployeeCode
                                         , 2               AS StepNo
                                         , 2               AS Type
                                         , 1               AS Status
                                         , GETDATE()       AS TimeCreate
                                         , NULL            AS GroupMail
                                         , 0               AS IsRead
                                         , NULL            AS Requests_ARCH_Id
                                         , N'-1'           AS CreateBy
                                         , GETDATE()       AS TimeUpdate
                                         , N'-1'           AS UpdateBy -- nvarchar(50)
                                    FROM
                                           #Tmp__F03_EmployeeJobTitles AS EJ
                                    WHERE
                                           EJ.WarehouseCode IN ( SELECT S.Request_ToShop FROM #Tmp_Request AS S )
                                           AND EJ.Status = 'A'
                                           AND EJ.JobTitleCode IN ( '00004', '00005' );

                                    GOTO GOTO__Add_Default_Permission;
                                END;
                        END;

                    IF ( @Request_TypeId = 183 )
                        BEGIN
                            IF ( @StepNo = 2 )
                                BEGIN
                                    DECLARE @MaNganh NVARCHAR(254) = N'';
                                    SELECT TOP 1
                                           @MaNganh = Property2
                                    FROM
                                           dbo.RequestDetails ( NOLOCK )
                                    WHERE
                                           RequestId = @RequestId;
                                    IF ( @MaNganh = '01' )
                                        BEGIN
                                            INSERT INTO #Tmp_Assigner ( Assigner )
                                            VALUES ( '4345' -- Assigner - varchar(40)
)                                           ;
                                        END;
                                    ELSE
                                        BEGIN
                                            INSERT INTO #Tmp_Assigner ( Assigner )
                                            EXEC [10.96.254.143].FRTInsideV2.[dbo].[CallLog_GetListEmployeesByNghanhHang]
                                                @HierarchyCodeL4 = @MaNganh; -- varchar(40)
                                        END;

                                    INSERT INTO dbo.Assigners
                                    (
                                        RequestId
                                      , EmployeeCode
                                      , StepNo
                                      , Type
                                      , Status
                                      , TimeCreate
                                      , GroupMail
                                      , IsRead
                                      , Requests_ARCH_Id
                                      , CreateBy
                                      , TimeUpdate
                                      , UpdateBy
                                    )
                                    SELECT
                                        @RequestId AS RequestId
                                      , A.Assigner AS EmployeeCode
                                      , 2          AS StepNo
                                      , 2          AS Type
                                      , 1          AS Status
                                      , GETDATE()  AS TimeCreate
                                      , NULL       AS GroupMail
                                      , 0          AS IsRead
                                      , NULL       AS Requests_ARCH_Id
                                      , N'-1'      AS CreateBy
                                      , GETDATE()  AS TimeUpdate
                                      , N'-1'      AS UpdateBy -- nvarchar(50)
                                    FROM
                                        #Tmp_Assigner AS A;

                                    GOTO GOTO__Add_Default_Permission;
                                END;
                        END;

                    IF ( @Request_TypeId = 192 )
                        BEGIN
                            INSERT dbo.Assigners
                            (
                                RequestId
                              , EmployeeCode
                              , StepNo
                              , Type
                              , Status
                              , TimeCreate
                              , GroupMail
                              , IsRead
                              , Requests_ARCH_Id
                              , CreateBy
                              , TimeUpdate
                              , UpdateBy
                            )
                            VALUES (
                                       @RequestId -- RequestId - bigint
                                     , N'3160'    -- EmployeeCode - nvarchar(40)
                                     , @StepNo    -- StepNo - int
                                     , 2          -- Type - int
                                     , 1          -- Status - tinyint
                                     , GETDATE()  -- TimeCreate - datetime
                                     , NULL       -- GroupMail - nvarchar(300)
                                     , 0          -- IsRead - bit
                                     , NULL       -- Requests_ARCH_Id - bigint
                                     , N'-1'      -- CreateBy - nvarchar(50)
                                     , GETDATE()  -- TimeUpdate - datetime
                                     , N'-1'      -- UpdateBy - nvarchar(50)
                                   );

                            GOTO GOTO__Add_Default_Permission;
                        END;

                    IF ( @Request_TypeId = 196 OR @Request_TypeId = 197 )
                        BEGIN
                            INSERT dbo.Assigners
                            (
                                RequestId
                              , EmployeeCode
                              , StepNo
                              , Type
                              , Status
                              , TimeCreate
                              , GroupMail
                              , IsRead
                              , Requests_ARCH_Id
                              , CreateBy
                              , TimeUpdate
                              , UpdateBy
                            )
                            SELECT
                                @RequestId
                                      -- RequestId - bigint
                              , E.EmployeeCode
                                      -- EmployeeCode - nvarchar(40)
                              , @StepNo
                                      -- StepNo - int
                              , 2
                                      -- Type - int
                              , 1
                                      -- Status - tinyint
                              , GETDATE()
                                      -- TimeCreate - datetime
                              , NULL
                                      -- GroupMail - nvarchar(300)
                              , 0
                                      -- IsRead - bit
                              , NULL
                                      -- Requests_ARCH_Id - bigint
                              , N'-1'
                                      -- CreateBy - nvarchar(50)
                              , GETDATE()
                                      -- TimeUpdate - datetime
                              , N'-1' -- UpdateBy - nvarchar(50)
                            FROM
                                dbo.F03_Employees AS E ( NOLOCK )
                            WHERE
                                --	KSNB
                                (
                                    E.JobTitle IN ( '00167', '00358', '00375' )
                                    OR E.EmployeeCode = '9177'
                                       AND E.JobTitle = '00292'
                                )
                                AND Status = 'A';

                            GOTO GOTO__Add_Default_Permission;
                        END;
                END;

            --	====================================================================================================
            --	==========ADD PHÂN QUYỀN MẶC ĐỊNH==========
            GOTO__Add_Default_Permission:
            IF ( 1 = 1 )
                --	1:PHÂN QUYỀN MẶC ĐỊNH
                BEGIN
                    CREATE TABLE #Tmp_Permission
                    (
                        RowId INT IDENTITY(1, 1)
                      , Jobtitle VARCHAR(40)
                      , FollowAssignment BIT
                      , TypeId INT
                      , Id BIGINT
                      , StepNo INT
                      , BI_PhongBanPhuTrach NVARCHAR(3000) -- Edit - ThuongNM2 - 06/03/2019 - Thay đổi yêu cầu CL 23=====
                    );
                    INSERT INTO #Tmp_Permission
                    (
                        Jobtitle
                      , FollowAssignment
                      , TypeId
                      , Id
                      , StepNo
                      , BI_PhongBanPhuTrach -- Edit - ThuongNM2 - 06/03/2019 - Thay đổi yêu cầu CL 23=====
                    )
                    SELECT
                        P.Jobtitle            -- Jobtitle - varchar(40)
                      , P.FollowAssignment    -- FollowAssignment - bit
                      , P.TypeId              -- TypeId - int
                      , P.Id                  -- Id - bigint
                      , P.StepNo              -- StepNo - int
                      , P.BI_PhongBanPhuTrach -- Edit - ThuongNM2 - 06/03/2019 - Thay đổi yêu cầu CL 23=====
                    FROM
                        dbo.Permissions AS P ( NOLOCK )
                    WHERE
                        P.TypeId = @Request_TypeId
                        AND P.StepNo = @StepNo
                        AND P.Status = 1
                        AND P.PermissionType = 0
                        AND (
                                (
                                    P.TypeId = 23
                                    AND ISNULL(P.BI_PhongBanPhuTrach, '') = ISNULL(( SELECT TOP 1 BI_PhongBanPhuTrach FROM #Tmp_Request ), '')
                                )
                                OR ( P.TypeId <> 23 )
                            );
                    -- Edit - ThuongNM2 - 06/03/2019 - Thay đổi yêu cầu CL 23=====
                    --SELECT
                    --    *
                    --FROM
                    --    #Tmp_Permission;
                    DECLARE
                        @RowId            INT        = 1
                      , @RowTotal         INT        = ISNULL(( SELECT MAX(RowId)FROM #Tmp_Permission ), 0)
                      , @Jobtitle         VARCHAR(40)
                      , @FollowAssignment BIT
                      , @LoaiDonHang109   CHAR(1)    = ISNULL((
                                                                  SELECT TOP 1
                                                                         Property2
                                                                  FROM
                                                                         dbo.RequestDetails ( NOLOCK )
                                                                  WHERE
                                                                         RequestId = @RequestId
                                                                         AND Status = 1
                                                              )
                                                            , ''
                                                             );
                    --- ChuongNT3 - 09/07/2018 - thêm CC ASM tại bước 1
                    DECLARE
                        @LoaiKhieuNai           NVARCHAR(300) = N''
                      , @ListShop_19            VARCHAR(300)  = ''
                      , @LoaiKhieuNaiCha        NVARCHAR(300) = N''
                      , @Ds_nhan_vien_khieu_nai NVARCHAR(500) = N'' --ChuongNT3 - 25/08/2018 - nhân viên khiếu nại
                      , @Phan_nhanh             INT;                --ChuongNT3 - 10/23/2018 - thêm nhánh
                    SELECT
                        @ListShop_19            = Property6
                      , @LoaiKhieuNai           = Property3
                      , @LoaiKhieuNaiCha        = Property1
                      , @Ds_nhan_vien_khieu_nai = Property12 --ChuongNT3 - 25/08/2018 - nhân viên khiếu nại
                      , @Phan_nhanh             = Quantity1  --ChuongNT3 - 10/23/2018 - thêm nhánh
                    FROM
                        dbo.RequestDetails ( NOLOCK )
                    WHERE
                        RequestId = @RequestId;
                    --- ChuongNT3 - 09/07/2018 - thêm CC ASM tại bước 1

                    CREATE TABLE #ShopOrOffice ( VALUE VARCHAR(50));

                    IF ( @Request_TypeId = 109 AND @StepNo = 1 )
                        BEGIN
                            DECLARE @ListCC109 VARCHAR(1000) = '';

                            SELECT
                                EM.EmployeeCode
                            INTO
                                #ListCCSMPSM109
                            FROM
                                #Tmp__F03_Employees                    AS EM
                                INNER JOIN #Tmp__F03_EmployeeJobTitles AS EJ
                                   ON EM.EmployeeCode = EJ.EmployeeCode
                                      AND EM.Status = 'A'
                                      AND EJ.Status = 'A'
                            WHERE
                                EJ.JobTitleCode IN ( '00004', '00005' )
                                AND ( EJ.WarehouseCode = @FromShop OR ISNULL(EJ.WarehouseCode, '') = '' )
                                AND EM.EmployeeCode NOT IN (
                                                               SELECT
                                                                   EmployeeCode
                                                               FROM
                                                                   dbo.Assigners ( NOLOCK )
                                                               WHERE
                                                                   RequestId = @RequestId
                                                                   AND Type = 2
                                                           );

                            IF ( EXISTS ( SELECT 1 FROM #ListCCSMPSM109 ))
                                BEGIN
                                    INSERT INTO dbo.Assigners
                                    (
                                        RequestId
                                      , EmployeeCode
                                      , StepNo
                                      , Type
                                      , Status
                                      , TimeCreate
                                      , GroupMail
                                      , IsRead
                                      , Requests_ARCH_Id
                                      , CreateBy
                                      , TimeUpdate
                                      , UpdateBy
                                    )
                                    SELECT
                                        @RequestId   AS RequestId
                                      , EmployeeCode AS EmployeeCode
                                      , @StepNo      AS StepNo
                                      , 2            AS Type
                                      , 1            AS Status
                                      , GETDATE()    AS TimeCreate
                                      , NULL         AS GroupMail
                                      , 0            AS IsRead
                                      , NULL         AS Requests_ARCH_Id
                                      , N'-1'        AS CreateBy
                                      , GETDATE()    AS TimeUpdate
                                      , N'-1'        AS UpdateBy -- nvarchar(50)
                                    FROM
                                        #ListCCSMPSM109;
                                END;

                            IF ( @LoaiDonHang109 = 'A' )
                                BEGIN
                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                    SELECT GiaTri FROM dbo.ufn_SplitStringToTable('5412,29085', ',', 0); -- VietMXH - 23/07/2019 - Đổi user nhận, VietNV2, ThinhDD4 yc

                                    INSERT INTO dbo.Assigners
                                    (
                                        RequestId
                                      , EmployeeCode
                                      , StepNo
                                      , Type
                                      , Status
                                      , TimeCreate
                                      , GroupMail
                                      , IsRead
                                      , Requests_ARCH_Id
                                      , CreateBy
                                      , TimeUpdate
                                      , UpdateBy
                                    )
                                    SELECT DISTINCT
                                           @RequestId      AS RequestId
                                         , EM.EmployeeCode AS EmployeeCode
                                         , @StepNo         AS StepNo
                                         , 2               AS Type
                                         , 1               AS Status
                                         , GETDATE()       AS TimeCreate
                                         , NULL            AS GroupMail
                                         , 0               AS IsRead
                                         , NULL            AS Requests_ARCH_Id
                                         , N'-1'           AS CreateBy
                                         , GETDATE()       AS TimeUpdate
                                         , N'-1'           AS UpdateBy -- nvarchar(50)
                                    FROM
                                           dbo.F03_Employees ( NOLOCK )                    AS EM
                                           INNER JOIN dbo.F03_EmployeeJobTitles ( NOLOCK ) AS EJ
                                              ON EM.EmployeeCode = EJ.EmployeeCode
                                                 AND EM.Status = 'A'
                                                 AND EJ.Status = 'A'
                                    WHERE
                                           EJ.JobTitleCode IN ( '00344', '00165', '00163', '00345', '00290', '00164', '00144' )
                                           AND ( EJ.WarehouseCode = @FromShop OR ISNULL(EJ.WarehouseCode, '') = '' )
                                           AND EM.EmployeeCode NOT IN (
                                                                          SELECT
                                                                              EmployeeCode
                                                                          FROM
                                                                              dbo.Assigners ( NOLOCK )
                                                                          WHERE
                                                                              RequestId = @RequestId
                                                                              AND Type = 2
                                                                              AND Status = 1
                                                                      )
                                    UNION
                                    SELECT DISTINCT
                                           @RequestId AS RequestId
                                         , D.CCer     AS EmployeeCode
                                         , @StepNo    AS StepNo
                                         , 2          AS Type
                                         , 1          AS Status
                                         , GETDATE()  AS TimeCreate
                                         , NULL       AS GroupMail
                                         , 0          AS IsRead
                                         , NULL       AS Requests_ARCH_Id
                                         , N'-1'      AS CreateBy
                                         , GETDATE()  AS TimeUpdate
                                         , N'-1'      AS UpdateBy -- nvarchar(50)
                                    FROM
                                           dbo.DefaultCC ( NOLOCK ) D
                                    WHERE
                                           D.CategoryId = @Request_TypeId
                                           AND StepNo = @StepNo
                                           AND Status = 1
                                           AND (
                                                   ISNULL(@FromShop, '') = ''
                                                   OR @FromShop IN ( SELECT VALUE FROM dbo.ufn_StringToTable(D.Shop, ',', 0) )
                                               )
                                           AND D.CCer NOT IN (
                                                                 SELECT
                                                                     EmployeeCode
                                                                 FROM
                                                                     dbo.Assigners ( NOLOCK )
                                                                 WHERE
                                                                     RequestId = @RequestId
                                                                     AND Type = 2
                                                                     AND Status = 1
                                                             );
                                END;

                            INSERT INTO #Tmp_Assigner ( Assigner )
                            SELECT GiaTri FROM dbo.ufn_SplitStringToTable('6654,18319', ',', 0); -- VietMXH - 25/09/2019 - Thêm Assigner cho ĐH A và B, Yennt19 yc

                            DROP TABLE #ListCCSMPSM109;
                        END;
                    ELSE IF ( @Request_TypeId = 19 AND @StepNo IN ( 2, 3 ))
                             BEGIN

                                 DECLARE --@ListShopOff VARCHAR(3000) ,
                                 @ListAssStep3 VARCHAR(3000);
                                 SELECT
                                     @ListShop_19  = Property6
                                   , @LoaiKhieuNai = Property3
                                 FROM
                                     dbo.RequestDetails ( NOLOCK )
                                 WHERE
                                     RequestId = @RequestId;

                                 INSERT INTO #ShopOrOffice ( VALUE )
                                 SELECT VALUE FROM dbo.ufn_StringToTable(@ListShop_19, ',', 0);

                                 SELECT
                                     EM.EmployeeCode
                                 INTO
                                     #ListSMPSMShop
                                 FROM
                                     #Tmp__F03_Employees                    AS EM
                                     INNER JOIN #Tmp__F03_EmployeeJobTitles AS EJ
                                        ON EM.EmployeeCode = EJ.EmployeeCode
                                           AND EM.Status = 'A'
                                           AND EJ.Status = 'A'
                                 WHERE
                                     EJ.JobTitleCode IN (
                                                            SELECT
                                                                Jobtitle
                                                            FROM
                                                                dbo.Permissions ( NOLOCK ) P
                                                            WHERE
                                                                P.TypeId = 19
                                                                AND P.StepNo = 3
                                                                AND P.Status = 1
                                                                AND P.PermissionType = 0
                                                        )
                                     AND (
                                             EJ.WarehouseCode IN ( SELECT VALUE FROM #ShopOrOffice WHERE VALUE NOT LIKE N'***%' )
                                             OR ISNULL(EJ.WarehouseCode, '') = ''
                                         );

                                 IF (
                                        ISNULL(@LoaiKhieuNai, '') IN ( N'Bảo hành', N'Bảo hành vàng' )
                                        AND @StepNo = 2
                                    )
                                     BEGIN
                                         INSERT INTO dbo.Assigners
                                         (
                                             RequestId
                                           , EmployeeCode
                                           , StepNo
                                           , Type
                                           , Status
                                           , TimeCreate
                                           , GroupMail
                                           , IsRead
                                           , Requests_ARCH_Id
                                           , CreateBy
                                           , TimeUpdate
                                           , UpdateBy
                                         )
                                         SELECT
                                             @RequestId   AS RequestId
                                           , EmployeeCode AS EmployeeCode
                                           , @StepNo      AS StepNo
                                           , 2            AS Type
                                           , 1            AS Status
                                           , GETDATE()    AS TimeCreate
                                           , NULL         AS GroupMail
                                           , 0            AS IsRead
                                           , NULL         AS Requests_ARCH_Id
                                           , N'-1'        AS CreateBy
                                           , GETDATE()    AS TimeUpdate
                                           , N'-1'        AS UpdateBy -- nvarchar(50)
                                         FROM
                                             #ListSMPSMShop
                                         WHERE
                                             EmployeeCode NOT IN (
                                                                     SELECT
                                                                         EmployeeCode
                                                                     FROM
                                                                         dbo.Assigners ( NOLOCK )
                                                                     WHERE
                                                                         RequestId = @RequestId
                                                                         AND Type = 2
                                                                         AND Status = 1
                                                                 );
                                     END;
                                 ELSE
                                     BEGIN
                                         INSERT INTO #Tmp_Assigner ( Assigner )
                                         SELECT EmployeeCode FROM #ListSMPSMShop;
                                     END;
                                 DROP TABLE #ListSMPSMShop;

                             END;
                    ---▼ ChuongNT3 - 15/02/2019 - CC 
                    ELSE
                    -- ThuongNM2 - 2019/04/19 -- Add Thu hộ
                    IF (
                           @Request_TypeId = 19
                           AND @StepNo = 1
                           AND @Phan_nhanh = 0 --ChuongNT3 - 10/23/2018 - thêm nhánh
                           AND ISNULL(@Ds_nhan_vien_khieu_nai, '') <> ''
                           AND (
                                   @LoaiKhieuNai IN ( N'Thái độ', N'Nghiệp vụ' ) -- Edit - ThuongNM2 - 08/07/2019 - Thay đổi yêu cầu CL 19=====
                                   OR @LoaiKhieuNaiCha IN ( N'Thái độ', N'Nghiệp vụ' ) --// Edit - ThuongNM2 - 08/07/2019 - Thay đổi yêu cầu CL 19=====
                               )
                       )
                        BEGIN
                            INSERT INTO #Tmp_Assigner ( Assigner )
                            SELECT
                                EmployeeCode
                            FROM
                                #Tmp__F03_Employees
                            WHERE
                                Status = 'A'
                                AND JobTitle IN ( '00004', '00005', '00256', '00257', '00447', '00448', '00407', '00644', '00514' )
                                AND WarehouseCode IN ( SELECT GiaTri FROM dbo.ufn_SplitStringToTable(@ListShop_19, ',', 0) );

                            INSERT INTO dbo.Assigners
                            (
                                RequestId
                              , EmployeeCode
                              , StepNo
                              , Type
                              , Status
                              , TimeCreate
                              , GroupMail
                              , IsRead
                              , Requests_ARCH_Id
                              , CreateBy
                              , TimeUpdate
                              , UpdateBy
                            )
                            SELECT DISTINCT
                                   @RequestId   AS RequestId
                                 , EmployeeCode AS EmployeeCode
                                 , 1            AS StepNo
                                 , 2            AS Type
                                 , 1            AS Status
                                 , GETDATE()    AS TimeCreate
                                 , NULL         AS GroupMail
                                 , 0            AS IsRead
                                 , NULL         AS Requests_ARCH_Id
                                 , N'-1'        AS CreateBy
                                 , GETDATE()    AS TimeUpdate
                                 , N'-1'        AS UpdateBy -- nvarchar(50)
                            FROM
                                   dbo.F03_Employees ( NOLOCK )
                            WHERE
                                --▼ ChuongNT3 - 10/23/2018 - thêm nhánh
                                   EmployeeCode IN (
                                                       SELECT
                                                           GiaTri
                                                       FROM
                                                           dbo.ufn_SplitStringToTable((
                                                                                          SELECT TOP 1
                                                                                                 Property12
                                                                                          FROM
                                                                                                 dbo.RequestDetails ( NOLOCK )
                                                                                          WHERE
                                                                                                 RequestId = @RequestId
                                                                                      )
                                                                                    , '.'
                                                                                    , 0
                                                                                     )
                                                   );
                            --▲ ChuongNT3 - 10/23/2018 - thêm nhánh

                            GOTO GOTO__Save_Assigner;
                        END;
                    ----▲ ChuongNT3 - 15/02/2019 - CC 
                    -- ThuongNM2 - 2019/04/19 -- Add Thu hộ CC SM/PSM
                    PRINT '@LoaiKhieuNai:' + @LoaiKhieuNai;
                    PRINT '@@LoaiKhieuNaiCha:' + @LoaiKhieuNaiCha;
                    IF (
                           @Request_TypeId IN ( 19, 157 )
                           AND @StepNo = 1
                           AND ( @LoaiKhieuNai = N'Thu hộ' OR @LoaiKhieuNaiCha = N'Thu hộ' )
                       )
                        BEGIN
                            INSERT INTO dbo.Assigners
                            (
                                RequestId
                              , EmployeeCode
                              , StepNo
                              , Type
                              , Status
                              , TimeCreate
                              , GroupMail
                              , IsRead
                              , Requests_ARCH_Id
                              , CreateBy
                              , TimeUpdate
                              , UpdateBy
                            )
                            SELECT DISTINCT
                                   @RequestId   AS RequestId
                                 , EmployeeCode AS EmployeeCode
                                 , 1            AS StepNo
                                 , 2            AS Type
                                 , 1            AS Status
                                 , GETDATE()    AS TimeCreate
                                 , NULL         AS GroupMail
                                 , 0            AS IsRead
                                 , NULL         AS Requests_ARCH_Id
                                 , N'-1'        AS CreateBy
                                 , GETDATE()    AS TimeUpdate
                                 , N'-1'        AS UpdateBy -- nvarchar(50)
                            FROM
                                   #Tmp__F03_Employees
                            WHERE
                                   Status = 'A'
                                   AND JobTitle IN ( '00004', '00005' )
                                   AND WarehouseCode IN ( SELECT GiaTri FROM dbo.ufn_SplitStringToTable(@ListShop_19, ',', 0) );

                        END;
                    -- ThuongNM2 - 2019/04/19 -- Add Thu hộ CC SM/PSM

                    ---CC ASM                         
                    IF (
                           @Request_TypeId = 19
                           AND @StepNo = 1
                           AND (
                                   --▼	Cụm 1
                                   (( @LoaiKhieuNai = N'Thái độ' OR @LoaiKhieuNai = N'Nghiệp vụ' )
                                    AND ( @LoaiKhieuNaiCha = N'Thái độ' OR @LoaiKhieuNaiCha = N'Nghiệp vụ' )
                                   )
                                   --▲	Cụm 1
                                   -- ThuongNM2 - 2019/04/19 -- Add Thu hộ
                                   --▼	Cụm 2
                                   OR @LoaiKhieuNai = N'Thu hộ'
                                   OR @LoaiKhieuNaiCha = N'Thu hộ'
                               --▲	Cụm 2                           
                               -- ThuongNM2 - 2019/04/19 -- Add Thu hộ
                               )
                       )
                        BEGIN
                            PRINT @ListShop_19;
                            PRINT 'AAAAAA';
                            IF ( ISNULL(@ListShop_19, '') <> '' )
                                BEGIN
                                    SELECT
                                        GiaTri
                                    INTO
                                        #Shop_Emp_ASM
                                    FROM
                                        dbo.ufn_SplitStringToTable(@ListShop_19, ',', 0);
                                    SELECT
                                        RegionL2
                                      , RegionL3
                                      , RegionL4
                                    INTO
                                        #Tmp_Emp_ASM
                                    FROM
                                        dbo.Warehouse
                                    WHERE
                                        WarehouseCode IN ( SELECT GiaTri FROM #Shop_Emp_ASM );

                                    INSERT INTO dbo.Assigners
                                    (
                                        RequestId
                                      , EmployeeCode
                                      , StepNo
                                      , Type
                                      , Status
                                      , TimeCreate
                                      , GroupMail
                                      , IsRead
                                      , Requests_ARCH_Id
                                      , CreateBy
                                      , TimeUpdate
                                      , UpdateBy
                                    )
                                    SELECT
                                        @RequestId   AS RequestId
                                      , EmployeeCode AS EmployeeCode
                                      , 1            AS StepNo
                                      , 2            AS Type
                                      , 1            AS Status
                                      , GETDATE()    AS TimeCreate
                                      , NULL         AS GroupMail
                                      , 0            AS IsRead
                                      , NULL         AS Requests_ARCH_Id
                                      , N'-1'        AS CreateBy
                                      , GETDATE()    AS TimeUpdate
                                      , N'-1'        AS UpdateBy -- nvarchar(50)
                                    FROM
                                        dbo.F03_Employees
                                    WHERE
                                        JobTitle = '00241'
                                        AND (
                                                RegionHierachyCode IN ( SELECT RegionL2 FROM #Tmp_Emp_ASM )
                                                OR RegionHierachyCode IN ( SELECT RegionL3 FROM #Tmp_Emp_ASM )
                                                OR RegionHierachyCode IN ( SELECT RegionL4 FROM #Tmp_Emp_ASM )
                                            );
                                    DROP TABLE
                                        #Shop_Emp_ASM
                                      , #Tmp_Emp_ASM;
                                END;
                        END;

                    WHILE ( @RowId <= @RowTotal )
                        BEGIN
                            SELECT
                                @Jobtitle         = Jobtitle
                              , @FollowAssignment = FollowAssignment
                            FROM
                                #Tmp_Permission
                            WHERE
                                RowId = @RowId;

                            IF (( @FollowAssignment = 1 AND @Request_TypeId NOT IN ( 109, 19 ))
                                OR (
                                       @FollowAssignment = 1
                                       AND @Request_TypeId = 109
                                       AND @StepNo = 1
                                       AND @LoaiDonHang109 = 'B'
                                   )
                                OR ( @FollowAssignment = 1 AND @Request_TypeId = 109 AND @StepNo <> 1 )
                                OR (
                                       @FollowAssignment = 1
                                       AND @Request_TypeId = 19
                                       AND (
                                               ISNULL(@LoaiKhieuNai, '') IN ( N'Bảo hành', N'Bảo hành vàng' )
                                               OR @StepNo = 1
                                           )
                                   )
                               )
                                ----1: Theo người được phân công xử lý
                                BEGIN
                                    PRINT N'Theo người được phân công xử lý';
                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                    SELECT
                                        A.Assigner
                                    FROM
                                        #Tmp_Request                               AS R
                                        INNER JOIN #Tmp_Permission                 AS P
                                           ON R.Request_TypeId = P.TypeId
                                        INNER JOIN dbo.Assignments                 AS A ( NOLOCK )
                                           ON P.Id = A.PermissionId
                                              AND A.Status = 1
                                        LEFT JOIN #Tmp__F03_OrganizationHierachies AS O
                                          ON O.ID = A.Organization
                                             AND O.Status = 'A'
                                        LEFT JOIN #Tmp__F03_Employees              AS EM
                                          ON R.Request_Sender = EM.EmployeeCode
                                        LEFT JOIN #Tmp__F03_Employees              AS EMA
                                          ON A.Assigner = EMA.EmployeeCode
                                    WHERE
                                        P.StepNo = @StepNo
                                        AND EMA.Status = 'A'
                                        AND (
                                                ISNULL(A.Shop, '') = ''
                                                OR R.Request_FromShop IN ( SELECT FS.GiaTri FROM dbo.ufn_SplitStringToTable(A.Shop, ',', 0) AS FS )
                                                OR R.Request_ToShop IN ( SELECT TS.GiaTri FROM dbo.ufn_SplitStringToTable(A.Shop, ',', 0) AS TS )
                                                OR ( EXISTS (
                                                                SELECT
                                                                     1
                                                                FROM (
                                                                         SELECT
                                                                             VALUE
                                                                         FROM
                                                                             #ShopOrOffice
                                                                         INTERSECT
                                                                         SELECT
                                                                             SOO.GiaTri
                                                                         FROM
                                                                             dbo.ufn_SplitStringToTable(A.Shop, ',', 0) AS SOO
                                                                     ) AS tb
                                                            )
                                                   ) -- loai 19
                                                OR (
                                                       R.Request_TypeId NOT IN ( 102, 19 )
                                                       AND ISNULL(R.Request_FromShop, '') = ''
                                                       AND ISNULL(R.Request_ToShop, '') = ''
                                                       AND EM.RegionHierachyCode IN (
                                                                                        SELECT
                                                                                            RHC.GiaTri
                                                                                        FROM
                                                                                            dbo.ufn_SplitStringToTable(A.Region, ',', 0) AS RHC
                                                                                    )
                                                   )
                                            )
                                        AND (
                                                ISNULL(A.Organization, '') = ''
                                                OR O.OrganizationHierachyCode = R.Request_FromOffice
                                                OR O.OrganizationHierachyCode = R.Request_ToOffice
                                                OR (
                                                       ISNULL(R.Request_FromOffice, '') = ''
                                                       AND ISNULL(R.Request_ToOffice, '') = ''
                                                   )
                                            )
                                        AND ( A.ItemId = 0 OR A.ItemId IN ( SELECT Id FROM #Tmp_Item ))
                                        AND ( A.SourceId = 0 OR A.SourceId IN ( SELECT Id FROM #Tmp_SourceIds ))
                                        AND --//TrungNC3 - 20/12/2017 - Fix hành chính gán người xử lý
                                        (
                                            (
                                                P.TypeId = 23
                                                AND A.TypeId = 1
                                            --AND ISNULL(R.BI_PhongBanPhuTrach, '') = ISNULL(P.BI_PhongBanPhuTrach, '') -- Edit - ThuongNM2 - 06/03/2019 - Thay đổi yêu cầu CL 23=====
                                            )
                                            OR ( P.TypeId <> 23 )
                                        )
                                    OPTION ( MAXRECURSION 1000 );
                                END;
                            ELSE IF (( @FollowAssignment = 0 AND @Request_TypeId NOT IN ( 109, 19 ))
                                     OR (
                                            @FollowAssignment = 0
                                            AND @Request_TypeId = 109
                                            AND @StepNo = 1
                                            AND @LoaiDonHang109 = 'A'
                                        )
                                     OR ( @FollowAssignment = 0 AND @Request_TypeId = 109 AND @StepNo <> 1 )
                                     OR (
                                            @FollowAssignment = 0
                                            AND @Request_TypeId = 19
                                            AND (
                                                    ISNULL(@LoaiKhieuNai, '') IN ( N'Bảo hành', N'Bảo hành vàng' )
                                                    OR @StepNo = 1
                                                )
                                        )
                                    )
                                     ---- 0: Theo chức danh phân quyền
                                     BEGIN
                                         PRINT @Jobtitle;
                                         PRINT @ASM;
                                         PRINT N'Theo chức danh phân quyền @5';

                                         INSERT INTO #Tmp_Assigner ( Assigner )
                                         SELECT
                                             EM.EmployeeCode
                                         FROM
                                             #Tmp__F03_Employees                    AS EM
                                             INNER JOIN #Tmp__F03_EmployeeJobTitles AS EJ
                                                ON EM.EmployeeCode = EJ.EmployeeCode
                                                   AND EM.Status = 'A'
                                                   AND EJ.Status = 'A'
                                         WHERE
                                             (
                                                 EJ.JobTitleCode = @Jobtitle
                                                 AND @Jobtitle <> @ASM
                                                 AND @Request_TypeId <> 188 --TrungNC3 - 03/01/2018 - add phân công loại 188
                                                 AND ( EJ.WarehouseCode = @FromShop OR ISNULL(EJ.WarehouseCode, '') = '' )
                                             )
                                             --TrungNC3 - 03/01/2018 - add phân công loại 188
                                             OR (
                                                    EJ.JobTitleCode = @Jobtitle
                                                    AND @Jobtitle <> @ASM
                                                    AND @Request_TypeId = 188
                                                    AND @StepNo = 2
                                                    AND ( EJ.WarehouseCode = @FromShop OR ISNULL(EJ.WarehouseCode, '') = '' )
                                                );

                                         IF ( @Request_TypeId = 188 AND @Jobtitle <> @ASM AND @StepNo = 1 )
                                             BEGIN
                                                 DECLARE @RegionL2 VARCHAR(40);
                                                 --, @RegionL4 VARCHAR(40);

                                                 -- Lấy vùng miền của shop tạo
                                                 SELECT
                                                     @RegionL2 = RegionL2
                                                 --, @RegionL4 = RegionL4
                                                 FROM
                                                     #Tmp__Warehouse
                                                 WHERE
                                                     WarehouseCode = @FromShop
                                                     AND Status = 'A';

                                                 INSERT INTO #Tmp_Assigner ( Assigner )
                                                 SELECT
                                                     EJ.EmployeeCode
                                                 FROM
                                                     #Tmp__F03_JobTitles                    AS J
                                                     INNER JOIN #Tmp__F03_EmployeeJobTitles AS EJ
                                                        ON J.JobTitleCode = EJ.JobTitleCode
                                                           AND J.Status = 'A'
                                                           AND EJ.Status = 'A'
                                                 WHERE
                                                     J.JobTitleCode <> @ASM
                                                     AND EJ.JobTitleCode IN ( '00002', '00457' )
                                                     AND ( EJ.RegionHierachyCode = @RegionL2
-- OR EJ.RegionHierachyCode = @RegionL4
)                                                ;
                                             END;
                                         --TrungNC3 - 03/01/2018 - add phân công loại 188

                                         IF ( @Jobtitle = @ASM )
                                             -- Nếu phân quyền cho ASM và check không theo phân công
                                             BEGIN
                                                 DECLARE
                                                     @RegionL3 VARCHAR(40)
                                                   , @RegionL4 VARCHAR(40);

                                                 -- Lấy vùng miền của shop tạo
                                                 SELECT
                                                     @RegionL3 = RegionL3
                                                   , @RegionL4 = RegionL4
                                                 FROM
                                                     #Tmp__Warehouse
                                                 WHERE
                                                     WarehouseCode = @FromShop
                                                     AND Status = 'A';

                                                 INSERT INTO #Tmp_Assigner ( Assigner )
                                                 SELECT
                                                     EJ.EmployeeCode
                                                 FROM
                                                     #Tmp__F03_JobTitles                    AS J
                                                     INNER JOIN #Tmp__F03_EmployeeJobTitles AS EJ
                                                        ON J.JobTitleCode = EJ.JobTitleCode
                                                           AND J.Status = 'A'
                                                           AND EJ.Status = 'A'
                                                 WHERE
                                                     J.JobTitleCode = @ASM
                                                     AND ( EJ.RegionHierachyCode = @RegionL3 OR EJ.RegionHierachyCode = @RegionL4 );
                                             END;
                                     END;

                            SET @RowId += 1;
                        END;

                    DROP TABLE
                        #Tmp_Permission
                      , #ShopOrOffice;
                END;

            --	====================================================================================================
            --	==========Gán thêm Người xử lý Ngoài Phân quyền đối với các Loại CallLog chỉ định==========
            IF ( 1 = 1 )
                BEGIN
                    IF ( @Request_TypeId = 28 )
                        --	28-Quỹ
                        BEGIN
                            IF (
                                   @Request_Status < 4 --	Chưa 4-Hoàn tất
                                   AND DATEADD(DAY, 6, CONVERT(DATE, @Request_TimeCreate)) <= CONVERT(DATE, GETDATE()) --	Ngày tạo quá 6 ngày
                               )
                                BEGIN
                                    DECLARE @Request_TypeId_28_Bonus_RegionL2 NVARCHAR(50) = ISNULL((
                                                                                                        SELECT TOP 1
                                                                                                               W.RegionL2
                                                                                                        FROM
                                                                                                               #Tmp__Warehouse AS W
                                                                                                        WHERE
                                                                                                               W.WarehouseCode = @Request_ToShop
                                                                                                               AND W.Status = 'A'
                                                                                                    )
                                                                                                  , ''
                                                                                                   );

                                    DECLARE @p_Request_TypeId_28__Assigner_String NVARCHAR(MAX) = ISNULL(   ( CASE
                                                                                                                  WHEN ( @Request_TypeId_28_Bonus_RegionL2 IN (   '00002' --	00002-Miền Bắc 1
                                                                                                                                                                , '00003' --	00003-Miền Bắc 2
                                                                                                                                                                , '00067' --	00067-APR Miền Bắc 
                                                                                                                                                              )
                                                                                                                       ) THEN N'2770' --	2770-NgaTT8
                                                                                                                  WHEN ( @Request_TypeId_28_Bonus_RegionL2 IN ( '00006' --	00006-Hà Nội
)
                                                                                                                       ) THEN N'9163' --	9163-ANhNTT15
                                                                                                                  WHEN ( @Request_TypeId_28_Bonus_RegionL2 IN ( '00007' --	00007-Hồ Chí Minh
)
                                                                                                                       ) THEN N'3728' --	3728-TrangNNT
                                                                                                                  WHEN ( @Request_TypeId_28_Bonus_RegionL2 IN (   '00005' --	00005-Miền Trung
                                                                                                                                                                , '00216' --	00216-APR Miền Trung
                                                                                                                                                              )
                                                                                                                       ) THEN N'0197' --	0197-NhungVTV
                                                                                                                  WHEN ( @Request_TypeId_28_Bonus_RegionL2 IN (   '00004' --	00004-Miền Nam
                                                                                                                                                                , '00204' --	00204-Miền Tây Nam Bộ
                                                                                                                                                                , '00205' --	00205-Miền Đông Nam Bộ
                                                                                                                                                                , '00484' --	00484-Miền Tây Nam Bộ 2
                                                                                                                                                                , '00498' --	00498-Miền Tây Nam Bộ 1
                                                                                                                                                                , '00068' --	00068-APR Miền Nam
                                                                                                                                                              )
                                                                                                                       ) THEN N'2868' --	2868-PhuongHV2
                                                                                                                  ELSE N''            --	-
                                                                                                              END
                                                                                                            )
                                                                                                          , ''
                                                                                                        );

                                    INSERT INTO #Tmp_Assigner ( Assigner )
                                    SELECT
                                        GiaTri AS Assigner
                                    FROM
                                        dbo.ufn_SplitStringToTable(@p_Request_TypeId_28__Assigner_String, ',', 0);

                                    GOTO GOTO__Save_Assigner;
                                END;
                        END;

                    IF ( @Request_TypeId = 183 )
                        BEGIN
                            IF ( @StepNo = 1 )
                                BEGIN
                                    --Code Lấy mail ASM
                                    DECLARE @Sender_183 NVARCHAR(40) = ( SELECT Sender FROM dbo.Requests ( NOLOCK ) WHERE Id = @RequestId );
                                    DECLARE
                                        @RegionShop3 VARCHAR(40) = ''
                                      , @RegionShop4 VARCHAR(40) = '';
                                    SELECT TOP 1
                                           @RegionShop4 = A.RegionL4
                                         , @RegionShop3 = A.RegionL3
                                    FROM
                                           dbo.Warehouse ( NOLOCK ) A
                                    WHERE
                                           A.Status = 'A'
                                           AND A.WarehouseCode = (
                                                                     SELECT
                                                                         WarehouseCode
                                                                     FROM
                                                                         #Tmp__F03_Employees
                                                                     WHERE
                                                                         EmployeeCode = @Sender_183
                                                                 );
                                    INSERT dbo.Assigners
                                    (
                                        RequestId
                                      , EmployeeCode
                                      , StepNo
                                      , Type
                                      , Status
                                      , TimeCreate
                                      , GroupMail
                                      , IsRead
                                      , Requests_ARCH_Id
                                      , CreateBy
                                      , TimeUpdate
                                      , UpdateBy
                                    )
                                    SELECT
                                        @RequestId     AS RequestId
                                      , A.EmployeeCode AS EmployeeCode
                                      , 1              AS StepNo
                                      , 2              AS Type
                                      , 1              AS Status
                                      , GETDATE()      AS TimeCreate
                                      , NULL           AS GroupMail
                                      , 0              AS IsRead
                                      , NULL           AS Requests_ARCH_Id
                                      , N'-1'          AS CreateBy
                                      , GETDATE()      AS TimeUpdate
                                      , N'-1'          AS UpdateBy -- nvarchar(50)
                                    FROM
                                        #Tmp__F03_Employees ( NOLOCK )                 A
                                        INNER JOIN dbo.F03_RegionHierachies ( NOLOCK ) B
                                           ON A.RegionHierachyCode = B.RegionHierachyCode
                                    WHERE
                                        JobTitle = '00241'
                                        AND A.Status = 'A'
                                        AND ( A.RegionHierachyCode = @RegionShop3 OR A.RegionHierachyCode = @RegionShop4 );

                                    GOTO GOTO__Save_Assigner;
                                END;
                        END;
                END;

            ----SELECT * FROM #Tmp_Assigner

            --	====================================================================================================
            --	==========Save Assigners==========
            GOTO__Save_Assigner:
            IF ( 1 = 1 )
                BEGIN
                    --	===Lấy NXL hiện tại===
                    CREATE TABLE #Tmp__Ass ( AssignerId BIGINT, Assigner NVARCHAR(50), Status INT );
                    INSERT INTO #Tmp__Ass ( AssignerId, Assigner, Status )
                    SELECT
                        A.Id           AS AssignerId
                      , A.EmployeeCode AS Assigner
                      , A.Status       AS Status
                    FROM
                        dbo.Assigners AS A ( NOLOCK )
                    WHERE
                        A.RequestId = @RequestId
                        AND A.StepNo = @StepNo
                        AND -- 1:Người xử lý
                        A.Type = 1;

                    --	===Lấy Status NXL hiện tại===
                    UPDATE
                        A
                    SET
                        A.Status = CASE WHEN ( N.Assigner <> '' ) THEN 1 ELSE 0 END
                    FROM
                        #Tmp__Ass               AS A
                        LEFT JOIN #Tmp_Assigner AS N
                          ON A.Assigner = N.Assigner;

                    --	===Update Status NXL hiện tại===
                    UPDATE
                        A
                    SET
                        A.Status = N.Status
                      , A.UpdateBy = N'-1'
                      , A.TimeUpdate = GETDATE()
                    FROM
                        dbo.Assigners        AS A ( NOLOCK )
                        INNER JOIN #Tmp__Ass AS N
                           ON A.Id = N.AssignerId
                    WHERE
                        A.Id IN ( SELECT C.AssignerId FROM #Tmp__Ass AS C );

                    DROP TABLE #Tmp__Ass;

                    --	===Insert thêm đối với trường hợp thêm mới===
                    INSERT INTO dbo.Assigners
                    (
                        RequestId
                      , EmployeeCode
                      , StepNo
                      , Type
                      , Status
                      , TimeCreate
                      , GroupMail
                      , IsRead
                      , Requests_ARCH_Id
                      , CreateBy
                      , TimeUpdate
                      , UpdateBy
                    )
                    SELECT DISTINCT
                           @RequestId AS RequestId
                         , T.Assigner AS EmployeeCode
                         , @StepNo    AS StepNo
                         , 1          AS Type
                         , 1          AS Status
                         , GETDATE()  AS TimeCreate
                         , NULL       AS GroupMail
                         , 0          AS IsRead
                         , NULL       AS Requests_ARCH_Id
                         , N'-1'      AS CreateBy
                         , GETDATE()  AS TimeUpdate
                         , N'-1'      AS UpdateBy -- nvarchar(50)
                    FROM
                           #Tmp_Assigner                AS T
                           INNER JOIN dbo.F03_Employees AS E ( NOLOCK )
                              ON T.Assigner = E.EmployeeCode
                                 AND E.Status = 'A'
                           LEFT JOIN dbo.Assigners      AS A ( NOLOCK )
                             ON A.RequestId = @RequestId
                                AND A.StepNo = @StepNo
                                AND A.Type = 1 --	1-Người xử lý
                                AND T.Assigner = A.EmployeeCode
                    WHERE
                           T.Assigner <> '' --	Có DL Assigner
                           AND --	Chỉ lấy những line có trong bảng #Tmp_Assigner mà không có trong bảng Assigners
                        A.Id IS NULL;
                END;

            --	====================================================================================================
            --	==========UPDATE Assigner Requests==========
            IF ( 1 = 1 )
                BEGIN
                    --	===Update Người xử lý Default cho CallLog===
                    DECLARE @Tmp_Assigner VARCHAR(50) = ISNULL(( SELECT TOP 1 A.Assigner FROM #Tmp_Assigner AS A WHERE A.Assigner <> '' ), '');

                    IF ( @Request_TypeId IN ( 198 --	198:Chi phí BH Máy cũ
)
                       )
                        BEGIN
                            IF ( @Request_Assigner_UuTien <> '' )
                                BEGIN
                                    SET @Tmp_Assigner = @Request_Assigner_UuTien;
                                END;

                            GOTO GOTO_UpdateAssignerToRequest;
                        END;

                    --▼	Edit - VietMXH - 07/03/2018 - 203:We Love Nội bộ==================================================
                    IF ( @Request_TypeId = 203 )
                        BEGIN
                            --	===Ưu tiên Acc Chị QuyênND2===
                            IF ( EXISTS ( SELECT TOP 1 1 FROM #Tmp_Assigner AS A WHERE A.Assigner = '6861' ))
                                BEGIN
                                    SET @Tmp_Assigner = '6861';
                                END;

                            GOTO GOTO_UpdateAssignerToRequest;
                        END;
                    --▲	Edit - VietMXH - 07/03/2018 - 203:We Love Nội bộ==================================================

                    --▼	Edit - TuanNA89 - 13/08/2019 - Loại 214 - Duyệt chuyển hàng phụ kiện bảo hành
                    IF ( @Request_TypeId = 214 )
                        BEGIN
                            IF ( @StepNo IN ( 2, 4 ))
                                BEGIN
                                    IF ( @StepNo <> @StepNo_Tmp )
                                        BEGIN
                                            SET @Tmp_Assigner = @Request_Assigner;
                                        END;
                                END;

                            GOTO GOTO_UpdateAssignerToRequest;
                        END;
                    --▲	Edit - TuanNA89 - 13/08/2019 - Loại 214 - Duyệt chuyển hàng phụ kiện bảo hành
                    --▼	Add - TuanNA89 - 04/10/2019 - Calllog hoàn tiền KH - Loại 217
                    IF ( @Request_TypeId = 217 )
                        BEGIN

                            GOTO GOTO_UpdateAssignerToRequest;
                        END;
                    --▲	Add - TuanNA89 - 04/10/2019 - Calllog hoàn tiền KH - Loại 217

                    --------------------------------------------------
                    --	===GOTO Update Người xử lý cho Requests=== 
                    GOTO_UpdateAssignerToRequest:

                    IF ( @Tmp_Assigner <> '' )
                        --	Có Người xử lý Default
                        BEGIN
                            UPDATE
                                dbo.Requests
                            SET
                                Assigner = @Tmp_Assigner
                              , Remark = REPLACE(Remark, N'Assigners_InsertForRequest-NULL Assigner-FollowAssignment', N'...') --	VietMXH: Bỏ để thu ngắn lại Remark
                            WHERE
                                Id = @RequestId;
                        END;
                    ELSE
                        BEGIN
                            PRINT CONCAT(N'Msg:', ISNULL(( N' - (' + CONVERT(NVARCHAR(50), GETDATE(), 121) + N'): Assigners_InsertForRequest-NULL Assigner-FollowAssignment' + CONVERT(NVARCHAR(10), ISNULL(@FollowAssignment, 0)) + N'!' ), ''));
                            UPDATE
                                dbo.Requests
                            SET
                                Remark = CASE
                                             WHEN ( CHARINDEX(N'Assigners_InsertForRequest', Remark) > 0 ) THEN Remark
                                             ELSE ( ISNULL(Remark, '') + ISNULL(( N' - (' + CONVERT(NVARCHAR(50), GETDATE(), 121) + N'): Assigners_InsertForRequest-NULL Assigner-FollowAssignment' + CONVERT(NVARCHAR(10), ISNULL(@FollowAssignment, 0)) + N'!' ), ''))
                                         END
                              , Assigner = NULL
                            WHERE
                                Id = @RequestId;
                        END;
                END;

            --	====================================================================================================
            --	==========SELECT Assigners==========
            IF ( ISNULL(@Is_NotView, 0) = 0 )
                BEGIN
                    SELECT
                        A.Id
                      , A.RequestId
                      , A.StepNo
                      , A.EmployeeCode
                    INTO
                        #Tmp__AssView
                    FROM
                        dbo.Assigners AS A ( NOLOCK )
                    WHERE
                        A.RequestId = @RequestId
                        AND A.StepNo = @StepNo
                        AND A.Type = 1
                        AND A.Status = 1;

                    SELECT DISTINCT
                           A.RequestId
                         , A.EmployeeCode                              AS 'Assigner'
                         , A.StepNo
                         , EM.EmployeeName
                         , REPLACE(LOWER(EM.Email), '@fpt.com.vn', '') AS 'EmailShort'
                         , EM.Email
                    FROM
                           #Tmp__AssView                 AS A
                           LEFT JOIN #Tmp__F03_Employees AS EM
                             ON EM.EmployeeCode = A.EmployeeCode;

                    DROP TABLE #Tmp__AssView;
                END;

            --	====================================================================================================
            --	==========Thêm gán default CC tại các bước==========
            EXEC dbo.Employees_InsertForAssigner @RequestId = @RequestId;

            --	====================================================================================================
            --	==========Remove bảng tạm==========
            DROP TABLE
                #Tmp__F03_Employees
              , #Tmp__F03_EmployeeJobTitles
              , #Tmp__F03_OrganizationHierachies
              , #Tmp__F03_JobTitles
              , #Tmp__Warehouse;
            DROP TABLE
                #Tmp_Request
              , #Tmp_SourceIds
              , #Tmp_Assigner
              , #Tmp_Item;

        /*
        DROP TABLE #Tmp__F03_Employees, #Tmp__F03_EmployeeJobTitles, #Tmp__F03_OrganizationHierachies, #Tmp__F03_JobTitles, #Tmp__Warehouse;
        DROP TABLE #Tmp_Request, #Tmp_SourceIds, #Tmp_Assigner, #Tmp_Item;
		*/
        END TRY
        BEGIN CATCH
            DECLARE @ErrorMessage NVARCHAR(2000);
            SET @ErrorMessage = N'Lỗi: [Assigners_InsertForRequest]';
            SET @ErrorMessage += N', @RequestId=''' + ISNULL(CONVERT(NVARCHAR(50), @RequestId), 'NULL') + N'''';
            SET @ErrorMessage += N', @StepNo=''' + ISNULL(CONVERT(NVARCHAR(50), @StepNo), 'NULL') + N'''';
            SET @ErrorMessage += N', @Is_NotView=''' + ISNULL(CONVERT(NVARCHAR(50), @Is_NotView), 'NULL') + N'''';
            SET @ErrorMessage += N' - ERROR_MESSAGE: ' + ERROR_MESSAGE() + N' - ERROR_LINE: ' + CONVERT(NVARCHAR, ERROR_LINE());

            --	===Ghi Log===
            INSERT INTO dbo.Logs ( Title, Error, Status, TimeCreate )
            VALUES (
                       N'Assigners_InsertForRequest' -- Title - nvarchar(300)
                     , @ErrorMessage                 -- Error - nvarchar(max)
                     , 1                             -- Status - tinyint
                     , GETDATE()                     -- TimeCreate - datetime
                   );
        END CATCH;
    END;

----SELECT * FROM dbo.Logs(NOLOCK) WHERE Title='Assigners_InsertForRequest' ORDER BY Id DESC
----SELECT * FROM dbo.Logs(NOLOCK) WHERE TimeCreate>'2018-05-26 13:15' AND Title='Assigners_InsertForRequest' ORDER BY Id DESC
----DELETE FROM dbo.Logs WHERE Title='Assigners_InsertForRequest'

GO

