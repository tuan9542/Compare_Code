SET QUOTED_IDENTIFIER ON;
SET ANSI_NULLS ON;
GO
ALTER PROC dbo.sp_MDELPHAR_API_ChangeTransportStatus_DangGiaoHang ( @IDMdel INT, @EcomNum VARCHAR(50), @TransportBy VARCHAR(40))
AS
BEGIN
    --RETURN;--ANHTVH - 20180521 - K XAI - Su dung store upload img de chuyen trang thai khi up anh thanh cong
    --20180526 SU dung lai do user k upload hinh 1
    --20180808 Edit AnhTVH -Chon nhieu NV GH , huy quyen cua cac NVGH con lai , khi DH da co nguoi GH
    INSERT INTO dbo.Logs ( Store, Message, CreateBy, CreateDate, IsSendMail )
    VALUES (
               N'sp_MDELPHAR_API_ChangeTransportStatus_DangGiaoHang' -- Store - nvarchar(max)
             , CONCAT('@IDMdel = ', @IDMdel, ', @EcomNum = ', @EcomNum, ', @TransportBy = ', @TransportBy) -- Message - nvarchar(max)
             , '-1' -- CreateBy - varchar(50)
             , GETDATE() -- CreateDate - datetime
             , NULL -- IsSendMail - bit
           );

    DECLARE
        @ResultID INT
      , @Message  NVARCHAR(MAX)
      , @ID       INT          = 0
      , @PosNum   INT;

    IF EXISTS (
                  SELECT TOP 1
                         1
                  FROM
                      dbo.PE_ORDR a ( NOLOCK )
                  WHERE
                      a.ID = @IDMdel
                      AND a.EcomNum = @EcomNum
              )
    BEGIN
        IF EXISTS (
                      SELECT TOP 1
                             1
                      FROM
                          dbo.PE_ORDR a ( NOLOCK )
                      WHERE
                          a.ID = @IDMdel
                          AND a.EcomNum = @EcomNum
                          AND TransportStatus IN (4, 14)
                  ) --Cho giao hang
        BEGIN
            IF EXISTS (
                          SELECT TOP 1
                                 1
                          FROM
                              dbo.Assign_ORDR a ( NOLOCK )
                          WHERE
                              a.IDORDR = @IDMdel
                              AND a.EcomNum = @EcomNum
                              AND EmployeeCode = @TransportBy
                              AND ISNULL(IsDelete, 0) = 0
                              AND EmployeeType IN (3)
                      ) -- Nguoi giao hang
            BEGIN
                DECLARE @EmployeeName NVARCHAR(255) = (
                                                          SELECT TOP 1
                                                                 EmployeeName
                                                          FROM
                                                              dbo.Assign_ORDR a ( NOLOCK )
                                                          WHERE
                                                              a.IDORDR = @IDMdel
                                                              AND a.EcomNum = @EcomNum
                                                              AND EmployeeCode = @TransportBy
                                                      );

                --5 Dang giao hang                
                UPDATE
                    dbo.PE_ORDR
                SET
                    TransportStatus = 5
                  , UpdateDate = GETDATE()
                  , UpdateBy = @TransportBy
                  , TransportBy = @TransportBy + ' - ' + @EmployeeName
                WHERE
                    ID = @IDMdel
                    AND EcomNum = @EcomNum;

                UPDATE
                    dbo.Assign_ORDR
                SET
                    IsDelete = 1
                  , UpdateDate = GETDATE()
                  , UpdateBy = @TransportBy
                WHERE
                    IDORDR = @IDMdel
                    AND EcomNum = @EcomNum
                    AND EmployeeCode <> @TransportBy
                    AND EmployeeType = 3
                    AND ISNULL(IsDelete, 0) = 0;

                SET @PosNum = (
                                  SELECT TOP 1
                                         PosNum
                                  FROM
                                      dbo.PE_ORDR a ( NOLOCK )
                                  WHERE
                                      a.ID = @IDMdel
                                      AND a.EcomNum = @EcomNum
                              );

                INSERT INTO dbo.TransportStatus_Log ( IDORDR, PosNum, EcomNum, TransportStatus, CreateBy, CreateDate )
                VALUES (
                           @IDMdel -- IDORDR - int
                         , @PosNum -- PosNum - int
                         , @EcomNum -- EcomNum - varchar(50)
                         , 5 -- TransportStatus - int
                         , @TransportBy -- CreateBy - varchar(40)
                         , GETDATE() -- CreateDate - datetime
                       );

                --********************* update trang thai huy grab sang pos qua API *********************--
                ---- TuanNA89 - 20/07/2021 - Thêm rule Grab hủy: Chuyển code sang store cập nhật lại nv shop sp_MDELPHAR_API_UpdateTransportBy
                --            IF EXISTS (
                --                          SELECT
                --                              1
                --                          FROM
                --                              dbo.PE_ORDR ( NOLOCK )
                --                          WHERE
                --                              ID = @IDMdel
                --                              AND Delivery_Type = 'Grab'
                --                              AND IsCancelGrab = 1
                --                      )
                --            BEGIN
                --                --CREATE TABLE #ResultApi(
                --                --	result INT,
                --                --	msg NVARCHAR(500)
                --                --)
                --                --INSERT INTO #ResultApi
                --                --(
                --                --	result,
                --                --	msg
                --                --)
                --                DECLARE
                --                    @Out_Result NVARCHAR(200)
                --                  , @Out_Msg    NVARCHAR(500);
                --                EXEC master.dbo.sp_MdelPhar_Cancel_GiaoHang_Grab_POS
                --                    @Posnum = @PosNum -- int
                --                  , @Out_Result = @Out_Result OUTPUT -- nvarchar(200)
                --                  , @Out_Msg = @Out_Msg OUTPUT; -- nvarchar(500)

                --                INSERT INTO dbo.Logs ( Store, Message, CreateBy, CreateDate )
                --                SELECT
                --                    'sp_MDELPHAR_API_ChangeTransportStatus_DangGiaoHang'
                --                  , CONCAT(N'API POS, posnum: ', CONVERT(VARCHAR(50), @PosNum), ', result: ', CONVERT(VARCHAR(50), @Out_Result), ', msg: ', @Out_Msg)
                --                  , 'HT'
                --                  , GETDATE();
                --            --FROM #ResultApi
                --            END;


                --*****************    ********************

                SET @ResultID = 1;
                SET @Message = N'Đơn hàng đã chuyển trạng thái Đang giao hàng';
            END;
            ELSE
            BEGIN
                SET @ResultID = 0;
                SET @Message = N'Bạn không được phân công giao đơn hàng này';
            END;
        END;
        ELSE
        BEGIN
            SET @ResultID = 0;
            IF EXISTS (
                          SELECT TOP 1
                                 1
                          FROM
                              dbo.PE_ORDR a ( NOLOCK )
                          WHERE
                              a.ID = @IDMdel
                              AND a.EcomNum = @EcomNum
                              AND TransportStatus = 5
                      )
            BEGIN
                DECLARE @currentTrsprtBy NVARCHAR(MAX) = (
                                                             SELECT TOP 1
                                                                    TransportBy
                                                             FROM
                                                                 dbo.PE_ORDR a ( NOLOCK )
                                                             WHERE
                                                                 a.ID = @IDMdel
                                                                 AND a.EcomNum = @EcomNum
                                                         );
                SET @Message = N'Nhân viên ' + ISNULL(@currentTrsprtBy, '') + N' đang giao đơn hàng này';
            END;
            ELSE
            BEGIN
                SET @Message = N'Chỉ có thể giao đơn hàng khi đơn hàng ở trạng thái Chờ giao hàng';
            END;
        END;
    END;
    ELSE
    BEGIN
        SET @ResultID = 0;
        SET @Message = N'Không tìm thấy đơn hàng';
    END;

    SELECT @ResultID AS ResultID, @Message AS [Message], @ID AS ID;
END;
GO

