SET QUOTED_IDENTIFIER ON;
SET ANSI_NULLS ON;
GO
ALTER PROCEDURE dbo.sp_MDELPHAR_API_GetSO ( @UserName VARCHAR(40), @Password NVARCHAR(500))
AS
BEGIN
    --ANHTVH - 20180521 - Lay danh sach SO theo user dc phan cong
    --EXEC sp_MDELPHAR_API_GetSO '00084',''
    --ANHTVH - 20180808 - ADD field ShopAddress

    ----INSERT INTO dbo.Logs ( Store, Message, CreateBy, CreateDate, IsSendMail )
    ----VALUES (
    ----           N'sp_MDELPHAR_API_GetSO' -- Store - nvarchar(max)
    ----         , N'@UserName=' + @UserName + '-@Password=' + @Password -- Message - nvarchar(max)
    ----         , '' -- CreateBy - varchar(50)
    ----         , GETDATE() -- CreateDate - datetime
    ----         , NULL -- IsSendMail - bit
    ----       );

    DECLARE @date DATETIME = CONVERT(DATE, DATEADD(DAY, -30, GETDATE()));

    -- TuanNA89 - 23/07/2021 - Lọc ra những CL shop cũ của User
    SELECT
        E.EmployeeCode
      , E.WarehouseCode
    INTO
        #tmp_F03_EmployeeJobTitles
    FROM
        dbo.F03_EmployeeJobTitles E ( NOLOCK )
    WHERE
        E.EmployeeCode = @UserName
        AND E.Status = 'A'
    GROUP BY
        E.EmployeeCode
      , E.WarehouseCode;

    SELECT TOP 1000
           a.IDORDR
    INTO
        #tmp_SO
    FROM
        dbo.Assign_ORDR a ( NOLOCK )
    WHERE
        a.EmployeeCode = @UserName
        AND ISNULL(a.IsDelete, 0) = 0
        AND a.CreateDate >= @date
    ORDER BY
        a.CreateDate DESC;

    SELECT TOP 15
           a.ID AS IDMdel
         , ISNULL(a.PosNum, 0) AS PosNum
         , a.EcomNum
         , a.CustName
         , a.CustPhone
         , a.SaleMan
         , a.ShopCode
         , a.OrderDate
         , a.Note
         , a.TransportFee
         , a.CustAddress
         , a.TransportType
         , '' AS PromotCode
         , a.PromotAmount
         , a.ShopManager
         , a.TransportBy
         , ISNULL(CONVERT(VARCHAR(20), a.TransportDate, 120), '') AS TransportDate
         , a.TransportStatus
         , a.TransportImage1
         , a.TransportImage2
         , a.TransportImage3
         , a.RejectType
         , a.RejectReason
         , ISNULL(CONVERT(VARCHAR(20), a.CompleteTransport, 120), '') AS CompleteTransport
         , ISNULL(a.CancelReason, '') AS CancelReason
         , a.OrderAmount
         , a.DownPayment
         , a.TotalAmount
         , a.ModifyType
         , a.OriginFrom
         , a.CustProvinceID
         , a.CustDistrictID
         , a.CustWardID
         , a.Pricing_vtp
         , a.Delivery_Fee_ecom
         , a.Delivery_Type
         , CONVERT(INT, a.Product_Weight) AS Product_Weight
         , CONVERT(INT, a.Product_Length) AS Product_Length
         , CONVERT(INT, a.Product_Width) AS Product_Width
         , CONVERT(INT, a.Product_Height) AS Product_Height
         , a.Deposit
         , a.PickingTime
         , a.IsCancelGrab
    INTO
        #tmp_Data
    FROM
        #tmp_SO s
        INNER JOIN dbo.PE_ORDR a ( NOLOCK ) ON s.IDORDR = a.ID
        -- TuanNA89 - 23/07/2021 - Lọc ra những CL shop cũ của User
        INNER JOIN #tmp_F03_EmployeeJobTitles E ON a.ShopCode = E.WarehouseCode
    WHERE
        a.TransportStatus IN (8, 9, 10, 11, 12, 13, 14);

    --HuyDonHang = 8,
    --KhachTuChoi = 9,
    --HoanTatGiaoHang = 10,
    --PosHuy = 11 ,
    --PosTraHang = 12 

    SELECT
        a.ID AS IDMdel
      , ISNULL(a.PosNum, 0) AS PosNum
      , a.EcomNum
      , a.CustName
      , a.CustPhone
      , a.SaleMan
      , a.ShopCode
      , a.OrderDate
      , a.Note
      , a.TransportFee
      , a.CustAddress
      , a.TransportType
      , '' AS PromotCode
      , a.PromotAmount
      , a.ShopManager
      , a.TransportBy
      , ISNULL(CONVERT(VARCHAR(20), a.TransportDate, 120), '') AS TransportDate
      , a.TransportStatus
      , a.TransportImage1
      , a.TransportImage2
      , a.TransportImage3
      , a.RejectType
      , a.RejectReason
      , ISNULL(CONVERT(VARCHAR(20), a.CompleteTransport, 120), '') AS CompleteTransport
      , ISNULL(a.CancelReason, '') AS CancelReason
      , a.OrderAmount
      , a.DownPayment
      , a.TotalAmount
      , a.ModifyType
      , a.OriginFrom
      , a.CustProvinceID
      , a.CustDistrictID
      , a.CustWardID
      , a.Pricing_vtp
      , a.Delivery_Fee_ecom
      , a.Delivery_Type
      , a.Product_Weight
      , a.Product_Length
      , a.Product_Width
      , a.Product_Height
      , a.Deposit
      , a.PickingTime
      , a.IsCancelGrab
    INTO
        #tmp_Data1
    FROM
        #tmp_SO s
        INNER JOIN dbo.PE_ORDR a ( NOLOCK ) ON s.IDORDR = a.ID
        -- TuanNA89 - 23/07/2021 - Lọc ra những CL shop cũ của User
        INNER JOIN #tmp_F03_EmployeeJobTitles E ON a.ShopCode = E.WarehouseCode
    WHERE
        a.TransportStatus NOT IN (8, 9, 10, 11, 12, 13, 14);

    SELECT DISTINCT
           a.IDMdel
         , a.PosNum
         , a.EcomNum
         , a.CustName
         , a.CustPhone
         , a.SaleMan
         , a.ShopCode
         , a.OrderDate AS OrderDate
         , a.Note
         , a.TransportFee
         , a.CustAddress
         , a.TransportType
         , a.PromotCode
         , a.PromotAmount
         , a.ShopManager
         , a.TransportBy
         , a.TransportDate
         , a.TransportStatus
         , a.TransportImage1
         , a.TransportImage2
         , a.TransportImage3
         , a.RejectType
         , a.RejectReason
         , a.CompleteTransport
         , a.CancelReason
         , a.OrderAmount
         , a.DownPayment
         , a.TotalAmount
         , a.ModifyType
         , a.OriginFrom
         , a.CustProvinceID
         , a.CustDistrictID
         , a.CustWardID
         , CONVERT(NVARCHAR(500), '') AS CustProvinceName
         , CONVERT(NVARCHAR(500), '') AS CustDistrictName
         , CONVERT(NVARCHAR(500), '') AS CustWardName
         , a.Pricing_vtp
         , a.Delivery_Fee_ecom
         , a.Delivery_Type
         , a.Product_Weight
         , a.Product_Length
         , a.Product_Width
         , a.Product_Height
         , a.Deposit
         , a.PickingTime
         , a.IsCancelGrab
    INTO
        #tmp_Result
    FROM
        #tmp_Data a
    UNION ALL
    SELECT DISTINCT
           a.IDMdel
         , a.PosNum
         , a.EcomNum
         , a.CustName
         , a.CustPhone
         , a.SaleMan
         , a.ShopCode
         , a.OrderDate AS OrderDate
         , a.Note
         , a.TransportFee
         , a.CustAddress
         , a.TransportType
         , a.PromotCode
         , a.PromotAmount
         , a.ShopManager
         , a.TransportBy
         , a.TransportDate
         , a.TransportStatus
         , a.TransportImage1
         , a.TransportImage2
         , a.TransportImage3
         , a.RejectType
         , a.RejectReason
         , a.CompleteTransport
         , a.CancelReason
         , a.OrderAmount
         , a.DownPayment
         , a.TotalAmount
         , a.ModifyType
         , a.OriginFrom
         , a.CustProvinceID
         , a.CustDistrictID
         , a.CustWardID
         , CONVERT(NVARCHAR(500), '') AS CustProvinceName
         , CONVERT(NVARCHAR(500), '') AS CustDistrictName
         , CONVERT(NVARCHAR(500), '') AS CustWardName
         , a.Pricing_vtp
         , a.Delivery_Fee_ecom
         , a.Delivery_Type
         , a.Product_Weight
         , a.Product_Length
         , a.Product_Width
         , a.Product_Height
         , a.Deposit
         , a.PickingTime
         , a.IsCancelGrab
    FROM
        #tmp_Data1 a;

    UPDATE
        #tmp_Result
    SET
        CustProvinceName = b.ProvinceName
    FROM
        #tmp_Result a
        INNER JOIN dbo.VTP_PROVINCE b ( NOLOCK ) ON a.CustProvinceID = b.ProvinceID
                                                    AND b.IsActive = 1
                                                    AND a.CustProvinceID <> 0;

    UPDATE
        #tmp_Result
    SET
        CustDistrictName = b.DistrictName
    FROM
        #tmp_Result a
        INNER JOIN dbo.VTP_DISTRICT b ( NOLOCK ) ON a.CustDistrictID = b.DistrictID
                                                    AND b.IsActive = 1
                                                    AND a.CustDistrictID <> 0;

    UPDATE
        #tmp_Result
    SET
        CustWardName = b.WardsName
    FROM
        #tmp_Result a
        INNER JOIN dbo.VTP_WARDS b ( NOLOCK ) ON a.CustWardID = b.WardsID
                                                 AND b.IsActive = 1
                                                 AND a.CustWardID <> 0;

    UPDATE
        #tmp_Result
    SET
        TransportStatus = 15
    FROM
        #tmp_Result a
        INNER JOIN dbo.TransportStatus_Log T ( NOLOCK ) ON T.IDORDR = a.IDMdel
                                                           AND T.TransportStatus = 6
    WHERE
        a.TransportStatus = 14;

    SELECT
        kk.shopcode
      , kk.Latitude
      , kk.Longitude
      , kk.Type_shop
    INTO
        #ToaDoShop
    FROM
        SV_THUC_FRT_MOBILE.MDELIVERY.dbo.FRT_ToaDo_Shop kk WITH ( NOLOCK );

    SELECT
        A.EcomNum
      , A.EmployeeCode
    INTO
        #tmp_TransportBy
    FROM
        #tmp_Result AS R
        INNER JOIN dbo.Assign_ORDR AS A ( NOLOCK ) ON A.EcomNum = R.EcomNum
    WHERE
        A.IsDelete = 0
        AND A.EmployeeType = 3;

    SELECT
        a.IDMdel
      , a.PosNum
      , a.EcomNum
      , a.CustName
      , a.CustPhone
      , ISNULL(a.SaleMan, '') AS SaleMan
      , a.ShopCode
      , ISNULL(CONVERT(VARCHAR(20), a.OrderDate, 120), '') AS OrderDate
      , REPLACE(a.Note, CHAR(13), ' ') AS Note
      , a.TransportFee
      , a.CustAddress
      , a.TransportType
      , a.PromotCode
      , ROUND(a.PromotAmount, 0) AS PromotAmount
      , a.ShopManager
      , CASE
            WHEN (
                     a.Delivery_Type = 'Grab'
                     AND ISNULL(a.TransportBy, '') IN ('', N'04879 - Giao hàng Grab')
                 ) THEN N'04879'
            ELSE ISNULL(T.EmployeeCode, '')
        END AS TransportByCode
      , CASE
            WHEN ( a.Delivery_Type = 'Grab' AND ISNULL(a.TransportBy, '') = '' ) THEN N'04879 - Giao hàng Grab'
            ELSE a.TransportBy
        END AS TransportBy
      , a.TransportDate
      , a.TransportStatus
      , a.TransportImage1
      , a.TransportImage2
      , a.TransportImage3
      , a.RejectType
      , a.RejectReason
      , a.CompleteTransport
      , a.CancelReason
      , ISNULL(a.OrderAmount, 0) AS OrderAmount
      , ISNULL(a.DownPayment, 0) AS DownPayment
      , ISNULL(ROUND(a.TotalAmount, 0), 0) AS TotalAmount
      , a.ModifyType
      , ISNULL(a.OriginFrom, 0) AS OriginFrom
      , ISNULL((
                   SELECT TOP 1
                          s.Address
                   FROM
                       dbo.Warehouse s ( NOLOCK )
                   WHERE
                       s.WarehouseCode = a.ShopCode
               )
             , ''
              ) AS ShopAddress
      , CONVERT(INT, ISNULL(a.CustProvinceID, 0)) AS CustProvinceID
      , CONVERT(INT, ISNULL(a.CustDistrictID, 0)) AS CustDistrictID
      , CONVERT(INT, ISNULL(a.CustWardID, 0)) AS CustWardID
      , ISNULL(a.CustProvinceName, '') AS CustProvinceName
      , ISNULL(a.CustDistrictName, '') AS CustDistrictName
      , ISNULL(a.CustWardName, '') AS CustWardName
      , CONVERT(NVARCHAR(20), ISNULL(a.Delivery_Fee_ecom, 0)) AS Deliveryfee
      , ISNULL(b.MaTinhVTP, 0) AS MaTinhShopVTP
      , ISNULL(b.MaQuanVTP, 0) AS MaQuanShopVTP
      , ISNULL(b.MaPhuongVTP, 0) AS MaPhuongShopVTP
      , CONVERT(NVARCHAR(10), '1') AS Delivery_Flag
      -- TuanNA89 - 20/07/2021 - Thêm rule Grab hủy
      , CASE
            WHEN a.IsCancelGrab = 1
                 AND a.TransportBy IS NOT NULL THEN NULL
            ELSE CONVERT(NVARCHAR(10), a.Delivery_Type)
        END AS Delivery_Type
      , CONVERT(NVARCHAR(10), a.Delivery_Type) AS Delivery_Type_2
      , ISNULL(a.Pricing_vtp, 0) AS Pricing_vtp
      , ISNULL(a.Product_Weight, 0) AS Product_Weight
      , ISNULL(a.Product_Length, 0) AS Product_Length
      , ISNULL(a.Product_Width, 0) AS Product_Width
      , ISNULL(a.Product_Height, 0) AS Product_Height
      , ISNULL(a.Deposit, 0) AS Deposit
      , ISNULL(kk.Latitude, '') AS Latitude
      , ISNULL(kk.Longitude, '') AS Longitude
      --, 'https://nhathuoclongchau.com/ttdh/' + a.EcomNum AS UrlTracking
      --      , N'Tài xế đến ' + CAST(DATEPART(HOUR, a.PickingTime) AS VARCHAR(5)) + 'g' + CAST(DATEPART(MINUTE, a.PickingTime) AS VARCHAR(5)) + ' ' + CONVERT(VARCHAR(10), a.PickingTime, 105) AS PickingTime
      --      , ISNULL(a.IsCancelGrab, 0) AS IsCancelGrab

      -- TuanNA89 - 20/07/2021 - Thêm rule Grab hủy
      , CASE
            WHEN a.IsCancelGrab = 1
                 AND ISNULL(a.TransportBy, '') = '' THEN N'Grab hủy/không tìm thấy tài xế Shop chọn lại NV giao hàng LC'
            ELSE 'https://test.nhathuoclongchau.com/ttdh/' + a.EcomNum
        END AS UrlTracking
      , CASE
            WHEN a.IsCancelGrab = 1
                 AND ISNULL(a.TransportBy, '') = '' THEN ''
            ELSE N'Tài xế đến ' + CAST(DATEPART(HOUR, a.PickingTime) AS VARCHAR(5)) + 'g' + CAST(DATEPART(MINUTE, a.PickingTime) AS VARCHAR(5)) + ' ' + CONVERT(VARCHAR(10), a.PickingTime, 105)
        END AS PickingTime
      , CASE
            WHEN ISNULL(a.IsCancelGrab, 0) = 1
                 AND ISNULL(a.TransportBy, '') <> '' THEN CONVERT(BIT, 0)
            ELSE ISNULL(a.IsCancelGrab, 0)
        END AS IsCancelGrab
    -- TuanNA89 - 20/07/2021 - Thêm rule Grab hủy
    FROM
        #tmp_Result a
        LEFT JOIN dbo.FRT_VTP_Code_Bill_Address b ( NOLOCK ) ON b.MaShop = a.ShopCode
        LEFT JOIN #ToaDoShop kk ON kk.shopcode = a.ShopCode
        LEFT JOIN #tmp_TransportBy AS T ON a.EcomNum = T.EcomNum
    ORDER BY
        a.OrderDate DESC;

    DROP TABLE
        #tmp_SO
      , #tmp_Data
      , #tmp_Data1
      , #tmp_Result
      , #ToaDoShop
      , #tmp_F03_EmployeeJobTitles; -- TuanNA89 - 23/07/2021 - Lọc ra những CL shop cũ của User
---Nhiều khi KH không cần gấp nhưng phí VCN cao thì Kh sẽ chọn VCT
END;
GO

