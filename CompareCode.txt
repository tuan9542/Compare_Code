SET QUOTED_IDENTIFIER ON;
SET ANSI_NULLS ON;
GO
/*
==================================================
Author			:	TuanNA89
Create date		:	23/07/2020
Description		:	Load detail CL lên Mobile
Note			:	
==================================================
EXEC dbo.sp__mCallLog__POSM__DuyetHA__Type229__GetDetail_ByReqId
    @RequestId = 5933515 -- bigint
*/
ALTER PROCEDURE dbo.sp__mCallLog__POSM__DuyetHA__Type229__GetDetail_ByReqId @RequestId BIGINT = 0
AS
BEGIN
    DECLARE
        @StoreName    VARCHAR(50)   = OBJECT_NAME(@@PROCID)
      , @ErrorMessage NVARCHAR(MAX) = N'';
    BEGIN TRY
        SELECT
            R.Id
          , R.Title
          , R.TimeCreate
          , R.Status
          , R.ToShop
          , R.StepNo
        INTO
            #tmp_Request
        FROM
            dbo.Requests AS R ( NOLOCK )
        WHERE
            R.Id = @RequestId;

        SELECT
            MD.Code
          , MD.Name
          , MD.Status
        INTO
            #tmp_Status
        FROM
            dbo.MasterDatas AS MD ( NOLOCK )
        WHERE
            MD.[Group] = 'RequestStatus';

        DECLARE
            @LyDoKhongUpHinh           NVARCHAR(MAX) = N''
          , @StepNo_Request            INT           = 0
          , @StepNo_LayLyDoKhongUpHinh INT           = 0
          , @Status                    INT           = 0;

        SELECT TOP 1
               @StepNo_Request = TR.StepNo
             , @StepNo_LayLyDoKhongUpHinh = CASE WHEN TR.StepNo < 3 THEN 1 ELSE 3 END
             , @Status = TR.Status
        FROM
            #tmp_Request AS TR ( NOLOCK );

        SELECT
            R.Id AS RequestId
          , CONCAT(N'Báo cáo hình ảnh POSM', CHAR(10), N'Số CallLog ', R.Id) AS RequestTitle
        FROM
            #tmp_Request AS R ( NOLOCK );

        SELECT
            RD.Id AS RequestDetailId
          , RD.RequestId AS RequestId
          , RD.Property1 AS TenCongViecChiTiet
          , RD.Property2 AS LinkHinhMau
          , CASE
                WHEN @StepNo_Request IN (1, 3)
                     AND ISNULL(RD.Approved, 0) = 0 THEN 1
                ELSE 0
            END ChoPhepUpHinh
          , CASE
                WHEN @Status = 4 THEN N'<label style=''color:red''>Từ chối</label>'
                ELSE CASE
                         WHEN @StepNo_Request = 1 THEN N'Chưa up hình'
                         WHEN @StepNo_Request = 2 THEN N'Chờ duyệt'
                         WHEN @StepNo_Request = 3 THEN N'Từ chối'
                         WHEN @StepNo_Request = 4 THEN N'Chờ duyệt'
                         ELSE ''
                     --     AND @Status < 4 THEN N'Chờ duyệt'
                     --ELSE CASE WHEN ISNULL(RD.Approved, 0) = 0 THEN N'Từ chối' ELSE N'Duyệt' END
                     END
            END AS TinhTrangDuyet_Text
          , CASE
                WHEN @Status = 4 THEN 3
                ELSE CASE
                         WHEN @StepNo_Request IN (1, 2, 4) THEN 1
                         WHEN RD.Approved = 1 THEN 2
                         WHEN RD.Approved = 0 THEN 3
                         ELSE 0
                     END
            END AS TinhTrangDuyet
          , CASE
                WHEN @StepNo_Request = 3
                     AND RD.Approved = 0 THEN ''
                ELSE CASE
                         WHEN ISNULL(RD.Property7, '') = '' THEN RD.Property2
                         ELSE N'https://imagescore.fptshop.com.vn:1233/' + RD.Property7
                     END
            END AS LinkHinhShopUp
          , CASE WHEN RD.Approved = 0 THEN RD.Property8 ELSE '' END AS LyDoKhongDuyet
          , RD.Property11 AS LyDoKhongUpHinh
        FROM
            dbo.RequestDetails AS RD ( NOLOCK )
        WHERE
            RD.RequestId = @RequestId
            AND RD.Status = 1
            AND ISNULL(RD.Approved, 0) = 0;
    END TRY
    BEGIN CATCH
        SET @ErrorMessage += N' - ERROR_MESSAGE: ' + ERROR_MESSAGE() + N' - ERROR_LINE: ' + CONVERT(NVARCHAR, ERROR_LINE());
        PRINT @ErrorMessage;
        --	===Ghi Log===
        INSERT INTO dbo.Logs ( Title, Error, Status, TimeCreate )
        VALUES (
                   @StoreName -- Title - nvarchar(300)
                 , CONCAT(N'Lỗi ', @ErrorMessage) -- Error - nvarchar(max)
                 , 1 -- Status - tinyint
                 , GETDATE() -- TimeCreate - datetime
               );

    END CATCH;
END;

----SELECT * FROM dbo.Logs(NOLOCK) WHERE Title=N'procedure_name' AND CHARINDEX(N'', Error)>0 ORDER BY Id DESC
GO

