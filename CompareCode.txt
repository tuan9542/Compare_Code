SET QUOTED_IDENTIFIER ON;
SET ANSI_NULLS ON;
GO
/*
-- =============================================
-- Author:		? - VietMXH
-- Create date: ? - 13/05/2020 16:04
-- Description:	<Description,,>
-- Note:		Chưa tối ưu
-- =============================================
EXEC Request_GetPermission
	@RequestId = 5892445
  , @EmpCode = '22312'
*/
ALTER PROCEDURE dbo.Request_GetPermission
    @RequestId BIGINT
  , @EmpCode VARCHAR(40)
AS
    BEGIN
        BEGIN TRY

            SET NOCOUNT ON;

            DECLARE
                @typeId INT
              , @step INT
              , @FromShop NVARCHAR(100);

            IF EXISTS ( SELECT 1 FROM dbo.Requests ( NOLOCK ) WHERE Id = @RequestId )
                BEGIN
                    SELECT TOP 1
                           @typeId = TypeId
                         , @step = StepNo
                         , @FromShop = FromShop
                    FROM
                        dbo.Requests ( NOLOCK )
                    WHERE
                        Id = @RequestId;
                END;
            ELSE
                BEGIN
                    SELECT TOP 1
                           @typeId = TypeId
                         , @step = StepNo
                         , @FromShop = FromShop
                    FROM
                        dbo.Requests_ARCH ( NOLOCK )
                    WHERE
                        Id = @RequestId;
                END;

            CREATE TABLE #Tmp_Return ( Per INT );

            -- Group , Admin, Supper Admin
            SELECT
                P.Jobtitle
              , P.PermissionType
              , P.FollowAssignment
            INTO
                #Tmp_Permissions
            FROM
                dbo.Permissions ( NOLOCK ) P
            WHERE
                P.Status = 1
                AND P.StepNo = @step
                AND P.TypeId = @typeId;

            --	===Lấy DL F03_EmployeeJobTitles===
            SELECT
                ID
              , EmployeeCode
              , JobTitleCode
              , WarehouseCode
            INTO
                #Tmp_EmployeeJobTitles
            FROM
                dbo.F03_EmployeeJobTitles WITH ( NOLOCK )
            WHERE
                Status = 'A';

            IF ( @typeId = 24 )
                BEGIN
                    DECLARE @isshop INT = (
                                              SELECT TOP 1
                                                     RD.Quantity5
                                              FROM
                                                  dbo.RequestDetails RD ( NOLOCK )
                                              WHERE
                                                  RD.RequestId = @RequestId
                                                  AND RD.Status = 1
                                          );
                    IF ( @step = 1 OR @step = 3 OR @step = 4 OR @step = 5 )
                        BEGIN
                            IF ( @isshop = 1 ) -- shop
                                BEGIN
                                    IF ( EXISTS (
                                                    SELECT TOP 1
                                                           EJ.JobTitleCode
                                                    FROM
                                                        #Tmp_EmployeeJobTitles AS EJ
                                                    WHERE
                                                        EJ.EmployeeCode = @EmpCode
                                                        AND EJ.JobTitleCode IN (
                                                                                   SELECT
                                                                                       P.Jobtitle
                                                                                   FROM
                                                                                       #Tmp_Permissions P
                                                                                   WHERE
                                                                                       P.PermissionType = 0
                                                                                       AND P.FollowAssignment = 0
                                                                               )
                                                )
                                       )
                                        BEGIN
                                            INSERT #Tmp_Return VALUES ( 0 );
                                        END;
                                    ELSE IF ( EXISTS (
                                                         SELECT TOP 1
                                                                EJ.JobTitleCode
                                                         FROM
                                                             #Tmp_EmployeeJobTitles AS EJ
                                                         WHERE
                                                             EJ.EmployeeCode = @EmpCode
                                                             AND EJ.JobTitleCode IN (
                                                                                        SELECT
                                                                                            P.Jobtitle
                                                                                        FROM
                                                                                            #Tmp_Permissions P
                                                                                        WHERE
                                                                                            P.PermissionType = 1
                                                                                            AND P.FollowAssignment = 0
                                                                                    )
                                                     )
                                            )
                                             BEGIN
                                                 INSERT #Tmp_Return VALUES ( 1 );
                                             END;
                                    ELSE IF ( EXISTS (
                                                         SELECT TOP 1
                                                                EJ.JobTitleCode
                                                         FROM
                                                             #Tmp_EmployeeJobTitles AS EJ
                                                         WHERE
                                                             EJ.EmployeeCode = @EmpCode
                                                             AND EJ.JobTitleCode IN (
                                                                                        SELECT
                                                                                            P.Jobtitle
                                                                                        FROM
                                                                                            #Tmp_Permissions P
                                                                                        WHERE
                                                                                            P.PermissionType = 2
                                                                                            AND P.FollowAssignment = 0
                                                                                    )
                                                     )
                                            )
                                             BEGIN
                                                 INSERT #Tmp_Return VALUES ( 2 );
                                             END;
                                END;
                            ELSE
                                BEGIN
                                    IF ( EXISTS (
                                                    SELECT TOP 1
                                                           EJ.JobTitleCode
                                                    FROM
                                                        #Tmp_EmployeeJobTitles AS EJ
                                                    WHERE
                                                        EJ.EmployeeCode = @EmpCode
                                                        AND EJ.JobTitleCode IN (
                                                                                   SELECT
                                                                                       P.Jobtitle
                                                                                   FROM
                                                                                       #Tmp_Permissions P
                                                                                   WHERE
                                                                                       P.PermissionType = 0
                                                                                       AND P.FollowAssignment = 1
                                                                               )
                                                )
                                       )
                                        BEGIN
                                            INSERT #Tmp_Return VALUES ( 0 );
                                        END;
                                    ELSE IF ( EXISTS (
                                                         SELECT TOP 1
                                                                EJ.JobTitleCode
                                                         FROM
                                                             #Tmp_EmployeeJobTitles AS EJ
                                                         WHERE
                                                             EJ.EmployeeCode = @EmpCode
                                                             AND EJ.JobTitleCode IN (
                                                                                        SELECT
                                                                                            P.Jobtitle
                                                                                        FROM
                                                                                            #Tmp_Permissions P
                                                                                        WHERE
                                                                                            P.PermissionType = 1
                                                                                            AND P.FollowAssignment = 1
                                                                                    )
                                                     )
                                            )
                                             BEGIN
                                                 INSERT #Tmp_Return VALUES ( 1 );
                                             END;
                                    ELSE IF ( EXISTS (
                                                         SELECT TOP 1
                                                                EJ.JobTitleCode
                                                         FROM
                                                             #Tmp_EmployeeJobTitles AS EJ
                                                         WHERE
                                                             EJ.EmployeeCode = @EmpCode
                                                             AND EJ.JobTitleCode IN (
                                                                                        SELECT
                                                                                            P.Jobtitle
                                                                                        FROM
                                                                                            #Tmp_Permissions P
                                                                                        WHERE
                                                                                            P.PermissionType = 2
                                                                                            AND P.FollowAssignment = 1
                                                                                    )
                                                     )
                                            )
                                             BEGIN
                                                 INSERT #Tmp_Return VALUES ( 2 );
                                             END;
                                END;
                        END;
                    ELSE
                        BEGIN
                            --bước 2 RSM/ASM
                            IF ( EXISTS (
                                            SELECT TOP 1
                                                   EJ.JobTitleCode
                                            FROM
                                                #Tmp_EmployeeJobTitles AS EJ
                                            WHERE
                                                EJ.EmployeeCode = @EmpCode
                                                AND EJ.JobTitleCode IN (
                                                                           SELECT
                                                                               P.Jobtitle
                                                                           FROM
                                                                               #Tmp_Permissions P
                                                                           WHERE
                                                                               P.PermissionType = 0
                                                                               AND P.FollowAssignment = 0
                                                                       )
                                        )
                               )
                                BEGIN
                                    INSERT #Tmp_Return VALUES ( 0 );
                                END;
                            ELSE IF ( EXISTS (
                                                 SELECT TOP 1
                                                        EJ.JobTitleCode
                                                 FROM
                                                     #Tmp_EmployeeJobTitles AS EJ
                                                 WHERE
                                                     EJ.EmployeeCode = @EmpCode
                                                     AND EJ.JobTitleCode IN (
                                                                                SELECT
                                                                                    P.Jobtitle
                                                                                FROM
                                                                                    #Tmp_Permissions P
                                                                                WHERE
                                                                                    P.PermissionType = 1
                                                                                    AND P.FollowAssignment = 0
                                                                            )
                                             )
                                    )
                                     BEGIN
                                         INSERT #Tmp_Return VALUES ( 1 );
                                     END;
                            ELSE IF ( EXISTS (
                                                 SELECT TOP 1
                                                        EJ.JobTitleCode
                                                 FROM
                                                     #Tmp_EmployeeJobTitles AS EJ
                                                 WHERE
                                                     EJ.EmployeeCode = @EmpCode
                                                     AND EJ.JobTitleCode IN (
                                                                                SELECT
                                                                                    P.Jobtitle
                                                                                FROM
                                                                                    #Tmp_Permissions P
                                                                                WHERE
                                                                                    P.PermissionType = 2
                                                                                    AND P.FollowAssignment = 0
                                                                            )
                                             )
                                    )
                                     BEGIN
                                         INSERT #Tmp_Return VALUES ( 2 );
                                     END;
                        END;

                END;
            ELSE IF ( @typeId = 45 OR @typeId = 213 )
                     BEGIN
                         IF ( EXISTS (
                                         SELECT TOP 1
                                                EJ.JobTitleCode
                                         FROM
                                             #Tmp_EmployeeJobTitles AS EJ
                                         WHERE
                                             EJ.EmployeeCode = @EmpCode
                                             AND EJ.WarehouseCode = @FromShop
                                             AND EJ.JobTitleCode IN ( SELECT Jobtitle FROM #Tmp_Permissions WHERE PermissionType = 0 )
                                     )
                            )
                             BEGIN
                                 INSERT #Tmp_Return VALUES ( 0 );
                             END;
                         ELSE IF ( EXISTS (
                                              SELECT TOP 1
                                                     EJ.JobTitleCode
                                              FROM
                                                  #Tmp_EmployeeJobTitles AS EJ
                                              WHERE
                                                  EJ.EmployeeCode = @EmpCode
                                                  AND EJ.WarehouseCode = @FromShop
                                                  AND EJ.JobTitleCode IN ( SELECT Jobtitle FROM #Tmp_Permissions WHERE PermissionType = 1 )
                                          )
                                 )
                                  BEGIN
                                      INSERT #Tmp_Return VALUES ( 1 );
                                  END;
                         ELSE IF ( EXISTS (
                                              SELECT TOP 1
                                                     EJ.JobTitleCode
                                              FROM
                                                  #Tmp_EmployeeJobTitles AS EJ
                                              WHERE
                                                  EJ.EmployeeCode = @EmpCode
                                                  AND EJ.WarehouseCode = @FromShop
                                                  AND EJ.JobTitleCode IN ( SELECT Jobtitle FROM #Tmp_Permissions WHERE PermissionType = 2 )
                                          )
                                 )
                                  BEGIN
                                      INSERT #Tmp_Return VALUES ( 2 );
                                  END;
                     END;
            ELSE
                     BEGIN
                         IF ( EXISTS (
                                         SELECT TOP 1
                                                EJ.JobTitleCode
                                         FROM
                                             #Tmp_EmployeeJobTitles AS EJ
                                         WHERE
                                             EJ.EmployeeCode = @EmpCode
                                             AND EJ.JobTitleCode IN ( SELECT Jobtitle FROM #Tmp_Permissions WHERE PermissionType = 0 )
                                     )
                            )
                             BEGIN
                                 INSERT #Tmp_Return VALUES ( 0 );
                             END;
                         ELSE IF ( EXISTS (
                                              SELECT TOP 1
                                                     EJ.JobTitleCode
                                              FROM
                                                  #Tmp_EmployeeJobTitles AS EJ
                                              WHERE
                                                  EJ.EmployeeCode = @EmpCode
                                                  AND EJ.JobTitleCode IN ( SELECT Jobtitle FROM #Tmp_Permissions WHERE PermissionType = 1 )
                                          )
                                 )
                                  BEGIN
                                      INSERT #Tmp_Return VALUES ( 1 );
                                  END;
                         ELSE IF ( EXISTS (
                                              SELECT TOP 1
                                                     EJ.JobTitleCode
                                              FROM
                                                  #Tmp_EmployeeJobTitles AS EJ
                                              WHERE
                                                  EJ.EmployeeCode = @EmpCode
                                                  AND EJ.JobTitleCode IN ( SELECT Jobtitle FROM #Tmp_Permissions WHERE PermissionType = 2 )
                                          )
                                 )
                                  BEGIN
                                      INSERT #Tmp_Return VALUES ( 2 );
                                  END;
                     END;

            SELECT R.Per AS Per FROM #Tmp_Return AS R;

            DROP TABLE
                #Tmp_Return
              , #Tmp_Permissions
              , #Tmp_EmployeeJobTitles;
        END TRY
        BEGIN CATCH
            DECLARE @ErrorMessage NVARCHAR(MAX) = N'';
            SET @ErrorMessage = N'Lỗi: [Request_GetPermission]';
            SET @ErrorMessage += N', @RequestId=N''' + ISNULL(CONVERT(NVARCHAR(50), @RequestId), 'NULL') + N'''';
            SET @ErrorMessage += N', @EmpCode=N''' + ISNULL(CONVERT(NVARCHAR(50), @EmpCode), 'NULL') + N'''';
            SET @ErrorMessage += N' - ERROR_MESSAGE: ' + ERROR_MESSAGE() + N' - ERROR_LINE: ' + CONVERT(NVARCHAR, ERROR_LINE());

            --	===Ghi Log===
            INSERT INTO dbo.Logs ( Title, Error, Status, TimeCreate )
            VALUES (
                       N'Request_GetPermission' -- Title - nvarchar(300)
                     , @ErrorMessage -- Error - nvarchar(max)
                     , 1 -- Status - tinyint
                     , GETDATE() -- TimeCreate - datetime
                   );
        END CATCH;
    END;





GO

